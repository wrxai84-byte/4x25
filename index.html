<!DOCTYPE html>
<html lang="en" prefix="og: http://ogp.me/ns#">
<head>
    <!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-8GJYYGEB88"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-8GJYYGEB88');
</script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>4x25 - Permanent Portfolio & FIRE Calculator</title>
    <meta name="description" content="Free tool for Harry Browne's Permanent Portfolio strategy and the FIRE 4% Rule.">
    
    <!-- Tailwind CSS CDN (Locked Version for Stability) -->
    <script src="https://cdn.tailwindcss.com/3.4.1"></script>
    
    <style>
        body { font-family: 'Inter', system-ui, -apple-system, sans-serif; }
        .lang-btn.active { background-color: #3b82f6; color: white; border-color: #3b82f6; }
        
        button:disabled { opacity: 0.3; cursor: not-allowed; pointer-events: none; }
        
        /* Remove default arrows for number inputs */
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }

        .table-cell-truncate { max-width: 140px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        
        /* Animation Classes */
        .faq-content { transition: max-height 0.3s ease-in-out, opacity 0.3s ease-in-out, visibility 0.3s; max-height: 0; opacity: 0; visibility: hidden; overflow: hidden; }
        .faq-content.open { max-height: 500px; opacity: 1; visibility: visible; }
        .faq-icon { transition: transform 0.3s ease; }
        .faq-icon.rotate { transform: rotate(180deg); }
        .modal-overlay { transition: opacity 0.3s ease; }
        .modal-content { transition: transform 0.3s ease, opacity 0.3s ease; }

        /* Focus Styles */
        button:focus-visible, input:focus-visible, a:focus-visible {
            outline: 2px solid #2563eb;
            outline-offset: 2px;
        }

        /* Reduced Motion Preference */
        @media (prefers-reduced-motion: reduce) {
            *, ::before, ::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
                scroll-behavior: auto !important;
            }
            .faq-content { transition: none !important; }
            .faq-content.open { max-height: auto !important; }
        }
        
        /* FOUC Prevention */
        body { opacity: 0; animation: fadeIn 0.3s ease-in forwards; }
        @keyframes fadeIn { to { opacity: 1; } }
    </style>
</head>
<body class="bg-gray-50 text-slate-800 min-h-screen flex flex-col">

    <!-- APP Container -->
    <div id="app" class="flex flex-col min-h-screen p-4 md:p-8 transition-opacity duration-300">
        <div class="max-w-5xl mx-auto w-full flex-grow">
            <!-- Header -->
            <header class="mb-8 flex flex-col md:flex-row md:items-center justify-between gap-4">
                <div>
                    <h1 class="text-4xl font-extrabold text-slate-900 tracking-tight">4x25</h1>
                    <h2 class="text-slate-500 mt-2 text-lg font-normal" data-i18n="subtitle">Permanent Portfolio Rebalancing Calculator Â· FIRE 4% Rule</h2>
                </div>
                
                <div class="flex flex-col md:flex-row gap-3 items-end md:items-center">
                    <div class="flex rounded-lg shadow-sm overflow-hidden border border-gray-300 bg-white" role="group" aria-label="Language Selection">
                        <button type="button" id="btn-en" class="lang-btn px-4 py-2 text-sm font-medium hover:bg-gray-50 transition-colors active" aria-pressed="true">EN</button>
                        <div class="w-px bg-gray-300"></div>
                        <button type="button" id="btn-zh" class="lang-btn px-4 py-2 text-sm font-medium hover:bg-gray-50 transition-colors" aria-pressed="false">ä¸­æ–‡</button>
                    </div>

                    <div class="bg-white px-2 py-1.5 rounded-lg shadow-sm border border-gray-200 flex items-center gap-2 select-none">
                        <span class="text-sm font-medium text-gray-500 ml-2" data-i18n="thresholdLabel" id="threshold-label">Threshold: Â±</span>
                        <div class="flex items-center bg-gray-100 rounded-md p-1" role="group" aria-labelledby="threshold-label">
                            <button type="button" id="btn-minus" aria-label="Decrease threshold" class="w-8 h-8 flex items-center justify-center bg-white rounded shadow-sm text-slate-600 hover:text-blue-600 hover:bg-blue-50 transition-all font-bold text-lg">-</button>
                            <div class="w-10 text-center font-bold text-slate-800" id="threshold-display" aria-live="polite">10</div>
                            <span class="text-xs font-bold text-slate-400 mr-2" aria-hidden="true">%</span>
                            <button type="button" id="btn-plus" aria-label="Increase threshold" class="w-8 h-8 flex items-center justify-center bg-white rounded shadow-sm text-slate-600 hover:text-blue-600 hover:bg-blue-50 transition-all font-bold text-lg">+</button>
                        </div>
                    </div>
                </div>
            </header>

            <main class="grid grid-cols-1 lg:grid-cols-12 gap-8">
                
                <!-- Left: Inputs -->
                <section class="lg:col-span-4 space-y-6">
                    <div class="bg-white rounded-2xl shadow-sm border border-gray-200 p-6">
                        <h3 class="text-xl font-bold mb-6 flex items-center gap-2" data-i18n="inputTitle">ğŸ’° Current Holdings</h3>
                        <div class="space-y-5" id="inputs-container">
                            <!-- JS Generated Inputs -->
                        </div>
                        <div class="mt-8 pt-6 border-t border-gray-100 flex justify-between items-center overflow-hidden">
                            <span class="text-gray-500 font-medium whitespace-nowrap mr-2" data-i18n="totalValue">Total Value</span>
                            <span class="text-2xl font-bold text-slate-900 font-mono truncate" id="total-value">0</span>
                        </div>
                    </div>

                    <!-- SVG Chart -->
                    <div class="bg-white rounded-2xl shadow-sm border border-gray-200 p-6 flex flex-col items-center" aria-hidden="true">
                        <div class="relative w-48 h-48 mb-6">
                            <svg viewBox="0 0 32 32" class="w-full h-full transform -rotate-90">
                                <circle r="15.9155" cx="16" cy="16" fill="transparent" stroke="#f3f4f6" stroke-width="6"></circle>
                                <circle id="chart-stocks" class="chart-segment" r="15.9155" cx="16" cy="16" fill="transparent" stroke="#3B82F6" stroke-width="6" stroke-dasharray="0 100" stroke-dashoffset="0"></circle>
                                <circle id="chart-bonds" class="chart-segment" r="15.9155" cx="16" cy="16" fill="transparent" stroke="#8B5CF6" stroke-width="6" stroke-dasharray="0 100" stroke-dashoffset="0"></circle>
                                <circle id="chart-cash" class="chart-segment" r="15.9155" cx="16" cy="16" fill="transparent" stroke="#10B981" stroke-width="6" stroke-dasharray="0 100" stroke-dashoffset="0"></circle>
                                <circle id="chart-gold" class="chart-segment" r="15.9155" cx="16" cy="16" fill="transparent" stroke="#F59E0B" stroke-width="6" stroke-dasharray="0 100" stroke-dashoffset="0"></circle>
                            </svg>
                            <div class="absolute inset-0 flex items-center justify-center pointer-events-none">
                                <span class="text-slate-300 font-bold text-xs tracking-widest">4x25</span>
                            </div>
                        </div>
                        <div class="w-full px-6 space-y-3">
                            <div class="flex items-center gap-3">
                                <span class="w-3 h-3 rounded-full bg-blue-500 flex-shrink-0 shadow-sm"></span>
                                <span class="text-sm font-medium text-slate-600" data-i18n="stocks">Stocks</span>
                            </div>
                            <div class="flex items-center gap-3">
                                <span class="w-3 h-3 rounded-full bg-violet-500 flex-shrink-0 shadow-sm"></span>
                                <span class="text-sm font-medium text-slate-600" data-i18n="bonds">Bonds</span>
                            </div>
                            <div class="flex items-center gap-3">
                                <span class="w-3 h-3 rounded-full bg-emerald-500 flex-shrink-0 shadow-sm"></span>
                                <span class="text-sm font-medium text-slate-600" data-i18n="cash">Cash</span>
                            </div>
                            <div class="flex items-center gap-3">
                                <span class="w-3 h-3 rounded-full bg-amber-500 flex-shrink-0 shadow-sm"></span>
                                <span class="text-sm font-medium text-slate-600" data-i18n="gold">Gold</span>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Right: Results -->
                <section class="lg:col-span-8 space-y-6">
                    
                    <!-- Status Card -->
                    <div id="status-card" class="rounded-2xl p-6 border-l-4 shadow-sm transition-all bg-blue-50 border-blue-500 text-blue-900" role="status" aria-live="polite">
                        <div class="flex items-start gap-4">
                            <div id="status-icon" class="text-2xl" aria-hidden="true">ğŸ‘‹</div>
                            <div>
                                <h3 class="text-lg font-bold" id="status-title">...</h3>
                                <p class="mt-1 text-sm" id="status-desc">...</p>
                            </div>
                        </div>
                    </div>

                    <!-- Table -->
                    <div class="bg-white rounded-2xl shadow-sm border border-gray-200 overflow-hidden">
                        <div class="p-6 border-b border-gray-100 flex justify-between items-center">
                            <h3 class="text-xl font-bold" data-i18n="rebalanceTitle">ğŸ”„ Rebalancing Suggestions</h3>
                            <span class="text-xs font-mono bg-gray-100 text-gray-600 px-2 py-1 rounded" data-i18n="targetLabel">Target: 25%</span>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-left border-collapse">
                                <thead>
                                    <tr class="bg-gray-50 text-gray-500 text-sm uppercase tracking-wider">
                                        <th class="p-3 font-medium whitespace-nowrap text-left" data-i18n="colAsset" scope="col">Asset</th>
                                        <th class="p-3 font-medium whitespace-nowrap text-left" data-i18n="colCurrent" scope="col">Current %</th>
                                        <th class="p-3 font-medium whitespace-nowrap text-left" data-i18n="colTarget" scope="col">Target Value</th>
                                        <th class="p-3 font-medium whitespace-nowrap text-left" data-i18n="colAction" scope="col">Action</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-gray-100" id="result-body">
                                    <!-- JS Generated Rows -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- FIRE Calc -->
                    <div class="bg-slate-900 text-white rounded-2xl p-6 shadow-lg overflow-hidden">
                        <h3 class="text-lg font-bold mb-2" data-i18n="fireTitle">FIRE 4% Rule Preview</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-4">
                            <div class="overflow-hidden">
                                <p class="text-slate-400 text-sm mb-1" data-i18n="fireYear">Safe Annual Withdrawal</p>
                                <p class="text-3xl font-mono font-bold text-emerald-400 truncate" id="fire-year">0</p>
                            </div>
                            <div class="overflow-hidden">
                                <p class="text-slate-400 text-sm mb-1" data-i18n="fireMonth">Safe Monthly Withdrawal</p>
                                <p class="text-2xl font-mono font-bold text-emerald-400 truncate" id="fire-month">0</p>
                            </div>
                        </div>
                    </div>

                    <!-- 4% Rule Info -->
                    <article class="bg-white rounded-2xl shadow-sm border border-gray-200 p-6">
                        <h3 class="text-base font-bold text-slate-900 mb-2 flex items-center gap-2">
                            <span class="text-blue-500" aria-hidden="true">â„¹ï¸</span> <span data-i18n="fireRuleTitle">About the 4% Rule</span>
                        </h3>
                        <div class="text-sm text-slate-600 leading-relaxed" data-i18n="fireRuleText" data-i18n-html="true"></div>
                    </article>

                </section>
            </main>

            <!-- Intro & FAQ -->
            <article class="mt-10 bg-white rounded-2xl shadow-sm border border-gray-200 p-8">
                <h2 class="text-2xl font-bold text-slate-900 mb-4" data-i18n="introTitle">What is the Permanent Portfolio?</h2>
                <div class="prose text-slate-600 max-w-none leading-relaxed mb-10" data-i18n="introText" data-i18n-html="true"></div>
                
                <div class="border-t border-gray-100 pt-8">
                    <h3 class="text-xl font-bold text-slate-800 mb-6" data-i18n="faqTitle">Frequently Asked Questions (FAQ)</h3>
                    <div id="faq-container" class="space-y-4"></div>
                </div>
            </article>
        </div>

        <!-- Footer -->
        <footer class="mt-12 text-center pb-8 px-4 border-t border-gray-100 pt-8">
            <p class="text-slate-400 text-sm mb-2">
                &copy; 2026 4x25 Â· <button type="button" id="btn-privacy" class="cursor-pointer hover:text-slate-600 transition-colors underline decoration-slate-300 underline-offset-2" data-i18n="privacy">Privacy Policy</button>
            </p>
            <p class="text-slate-400 text-xs max-w-2xl mx-auto leading-relaxed opacity-80" data-i18n="disclaimer">
                Disclaimer: This tool is for informational purposes only.
            </p>
        </footer>
    </div>

    <!-- Privacy Modal -->
    <div id="privacy-modal" class="fixed inset-0 z-50 hidden" role="dialog" aria-modal="true" aria-labelledby="modal-title">
        <div class="modal-overlay absolute inset-0 bg-slate-900/50 backdrop-blur-sm transition-opacity opacity-0"></div>
        <div class="flex min-h-full items-center justify-center p-4 text-center sm:p-0">
            <div class="modal-content relative transform overflow-hidden rounded-2xl bg-white text-left shadow-xl transition-all sm:my-8 sm:w-full sm:max-w-lg opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95" id="modal-panel">
                <div class="bg-white px-4 pb-4 pt-5 sm:p-6 sm:pb-4">
                    <h3 class="text-xl font-bold leading-6 text-slate-900 mb-4" id="modal-title" data-i18n="privacyTitle">Privacy Policy</h3>
                    <div class="mt-2 text-sm text-slate-600 space-y-3 leading-relaxed" data-i18n="privacyContent" data-i18n-html="true"></div>
                </div>
                <div class="bg-gray-50 px-4 py-3 sm:flex sm:flex-row-reverse sm:px-6">
                    <button type="button" id="modal-close-btn" class="inline-flex w-full justify-center rounded-lg bg-blue-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-blue-500 sm:ml-3 sm:w-auto transition-colors" data-i18n="closeBtn">Close</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- Constants & Config ---
        // Clean Code: Extract magic number
        const TARGET_PERCENT = 25; 
        const MIN_THRESHOLD = 5;
        const MAX_THRESHOLD = 15;
        const MAX_DIGITS = 12;

        let currentLang = 'en'; 
        let currentThreshold = 10;
        let isScheduled = false;

        const translations = {
            zh: {
                symbol: 'Â¥', 
                subtitle: "æ°¸ä¹…æŠ•èµ„ç»„åˆå†å¹³è¡¡è®¡ç®—å™¨ Â· FIRE 4% æ³•åˆ™", 
                thresholdLabel: "å†å¹³è¡¡é˜ˆå€¼: Â±",
                inputTitle: "ğŸ’° å½“å‰æŒä»“è¾“å…¥",
                totalValue: "æ€»èµ„äº§ä»·å€¼",
                rebalanceTitle: "ğŸ”„ å†å¹³è¡¡æ“ä½œå»ºè®®",
                targetLabel: `ç›®æ ‡å æ¯”: ${TARGET_PERCENT}%`,
                colAsset: "èµ„äº§",
                colCurrent: "å½“å‰å æ¯”",
                colTarget: "ç›®æ ‡é‡‘é¢",
                colAction: "æ“ä½œ",
                fireTitle: "FIRE 4% æ³•åˆ™é¢„è§ˆ",
                fireYear: "å¯æ”¯æŒå¹´æ”¯å‡º",
                fireMonth: "å¯æ”¯æŒæœˆæ”¯å‡º",
                stocks: "è‚¡ç¥¨ (Stocks)",
                bonds: "é•¿æœŸå›½å€º (Bonds)",
                cash: "ç°é‡‘/çŸ­å€º (Cash)",
                gold: "é»„é‡‘ (Gold)",
                buy: "ä¹°å…¥",
                sell: "å–å‡º",
                hold: "ä¿æŒ", 
                statusEmptyTitle: "è¯·è¾“å…¥æŒä»“é‡‘é¢",
                statusEmptyDesc: "è¯·åœ¨å·¦ä¾§è¾“å…¥å„é¡¹èµ„äº§çš„å½“å‰ä»·å€¼ä»¥å¼€å§‹è®¡ç®—ã€‚",
                statusHealthyTitle: "æŠ•èµ„ç»„åˆå¤„äºå¥åº·åŒºé—´",
                statusHealthyDesc: "æ‰€æœ‰èµ„äº§å‡åœ¨ç›®æ ‡åŒºé—´å†…ï¼Œæ— éœ€æ“ä½œã€‚",
                statusActionTitle: "å»ºè®®è¿›è¡Œå†å¹³è¡¡",
                statusActionDesc: "æ£€æµ‹åˆ°æœ‰èµ„äº§åç¦»ç›®æ ‡é…ç½®è¶…è¿‡ {threshold}% (å³ <{min}% æˆ– >{max}%)ã€‚",
                fireRuleTitle: "å…³äº 4% æ³•åˆ™",
                fireRuleText: "æºè‡ª<b>ä¸‰ä¸€å­¦é™¢ç ”ç©¶</b>ã€‚æ ¸å¿ƒè§‚ç‚¹ï¼šè‹¥æ¯å¹´æå–åˆå§‹èµ„é‡‘çš„ <b>4%</b> ä½œä¸ºç”Ÿæ´»è´¹ï¼ˆå¹¶éšé€šèƒ€è°ƒæ•´ï¼‰ï¼Œèµ„é‡‘å¤§æ¦‚ç‡èƒ½ç»´æŒ 30 å¹´ä»¥ä¸Šã€‚è¿™æ„å‘³ç€ï¼šå½“<b>æ€»èµ„äº§ = å¹´æ”¯å‡º Ã— 25</b> æ—¶ï¼Œç†è®ºä¸Šå·²è¾¾æˆè´¢åŠ¡è‡ªç”±ã€‚",
                introTitle: "ä»€ä¹ˆæ˜¯æ°¸ä¹…æŠ•èµ„ç»„åˆï¼Ÿ",
                introText: `<p class="mb-4">æ°¸ä¹…æŠ•èµ„ç»„åˆï¼ˆPermanent Portfolioï¼‰æ˜¯ç”±å“ˆåˆ©Â·å¸ƒæœ—ï¼ˆHarry Browneï¼‰æå‡ºçš„æŠ•èµ„ç­–ç•¥ï¼Œæ—¨åœ¨æ— è®ºç»æµçŠ¶å†µå¦‚ä½•ï¼ˆç¹è£ã€é€šç¼©ã€é€šèƒ€æˆ–æ»èƒ€ï¼‰ï¼Œéƒ½èƒ½ä¿æŠ¤å¹¶å¢å€¼ä½ çš„è´¢å¯Œã€‚</p><p class="mb-4">å…¶æ ¸å¿ƒç†å¿µæå…¶ç®€å•ï¼šå°†èµ„äº§å¹³åˆ†ä¸ºå››ç­‰ä»½ï¼ˆå„${TARGET_PERCENT}%ï¼‰ï¼š<strong>è‚¡ç¥¨</strong>ï¼ˆåº”å¯¹ç¹è£ï¼‰ã€<strong>é•¿æœŸå›½å€º</strong>ï¼ˆåº”å¯¹é€šç¼©ï¼‰ã€<strong>ç°é‡‘/çŸ­å€º</strong>ï¼ˆåº”å¯¹è¡°é€€/ç´§ç¼©ï¼‰ã€<strong>é»„é‡‘</strong>ï¼ˆåº”å¯¹é€šèƒ€ï¼‰ã€‚</p><p>ä½ åªéœ€è¦æ¯å¹´æ£€æŸ¥ä¸€æ¬¡ï¼Œå¦‚æœæŸé¡¹èµ„äº§å æ¯”åç¦» ${TARGET_PERCENT}% å¤ªå¤šï¼ˆä¾‹å¦‚è¶…è¿‡è®¾å®šçš„é˜ˆå€¼ï¼‰ï¼Œå°±è¿›è¡Œâ€œå†å¹³è¡¡â€ï¼šå–å‡ºæ¶¨å¾—å¤šçš„ï¼Œä¹°å…¥è·Œå¾—å¤šçš„ï¼Œä½¿å…¶å›åˆ° ${TARGET_PERCENT}%ã€‚</p>`,
                faqTitle: "å¸¸è§é—®é¢˜ (FAQ)",
                faqData: [
                    { question: "ä¸ºä»€ä¹ˆå« 4x25?", answer: `<p class="mb-2">è¿™æ˜¯ä¸€ä¸ªåŒå…³å«ä¹‰ï¼š</p><ul class="list-decimal list-inside space-y-1 ml-1"><li><strong>æ°¸ä¹…æŠ•èµ„ç»„åˆï¼š</strong>4ç§èµ„äº§ï¼Œå„å  ${TARGET_PERCENT}%ã€‚</li><li><strong>FIRE è¿åŠ¨ï¼š</strong>4% æ³•åˆ™ï¼Œæ„å‘³ç€ä½ éœ€è¦å­˜å¤Ÿå¹´æ”¯å‡ºçš„ 25 å€ã€‚</li></ul>` },
                    { question: "å†å¹³è¡¡çš„é˜ˆå€¼è®¾ä¸ºå¤šå°‘æ¯”è¾ƒå¥½?", answer: `<p>å“ˆåˆ©Â·å¸ƒæœ—å»ºè®®ä½¿ç”¨ <strong>15/35 é¢‘å¸¦</strong>ï¼Œå³å½“æŸé¡¹èµ„äº§è·Œç ´ 15% æˆ–æ¶¨è¶… 35% æ—¶è§¦å‘å†å¹³è¡¡ï¼ˆç›¸å½“äº Â±10% çš„é˜ˆå€¼ï¼‰ã€‚</p><p class="mt-2">æœ¬è®¡ç®—å™¨é»˜è®¤è®¾ç½®ä¸º Â±10%ï¼Œä½ å¯ä»¥æ ¹æ®è‡ªå·±çš„é£é™©åå¥½åœ¨é¡¶éƒ¨è°ƒæ•´ã€‚</p>` }
                ],
                privacy: "éšç§æ”¿ç­–",
                disclaimer: "å…è´£å£°æ˜ï¼šæœ¬å·¥å…·ä»…ä¾›å‚è€ƒï¼Œä¸æ„æˆä»»ä½•è´¢åŠ¡å»ºè®®ã€‚æŠ•èµ„æœ‰é£é™©ï¼Œå…¥å¸‚éœ€è°¨æ…ã€‚",
                privacyTitle: "éšç§æ”¿ç­–",
                privacyContent: `<p><strong>1. æ•°æ®å®‰å…¨ä¸æœ¬åœ°è®¡ç®—</strong><br>æœ¬ç½‘ç«™æ˜¯ä¸€ä¸ªçº¯å‰ç«¯åº”ç”¨ã€‚æ‰€æœ‰è®¡ç®—å‡åœ¨æ‚¨çš„æµè§ˆå™¨æœ¬åœ°å®Œæˆã€‚æˆ‘ä»¬æ²¡æœ‰åç«¯æœåŠ¡å™¨ï¼Œä¹Ÿä¸ä¼šæ”¶é›†ã€å­˜å‚¨æˆ–ä¼ è¾“æ‚¨çš„ä»»ä½•è´¢åŠ¡æ•°æ®ã€‚</p><p><strong>2. Cookie ä½¿ç”¨</strong><br>æœ¬ç½‘ç«™ä¸ä½¿ç”¨ä»»ä½•ç”¨äºè¿½è¸ªä¸ªäººèº«ä»½çš„ Cookieã€‚</p><p class="text-xs text-gray-400 mt-4">æœ€åæ›´æ–°æ—¥æœŸï¼š2026å¹´1æœˆ4æ—¥</p>`,
                closeBtn: "å…³é—­"
            },
            en: {
                symbol: '$', 
                subtitle: "Permanent Portfolio Rebalancing Calculator Â· FIRE 4% Rule",
                thresholdLabel: "Threshold: Â±",
                inputTitle: "ğŸ’° Current Holdings",
                totalValue: "Total Value",
                rebalanceTitle: "ğŸ”„ Rebalancing Suggestions",
                targetLabel: `Target: ${TARGET_PERCENT}%`,
                colAsset: "Asset",
                colCurrent: "Current %",
                colTarget: "Target Value",
                colAction: "Action",
                fireTitle: "FIRE 4% Rule Preview",
                fireYear: "Safe Annual Withdrawal",
                fireMonth: "Safe Monthly Withdrawal",
                stocks: "Stocks",
                bonds: "Long-Term Bonds",
                cash: "Cash / T-Bills",
                gold: "Gold",
                buy: "Buy",
                sell: "Sell",
                hold: "Hold",
                statusEmptyTitle: "Enter Your Holdings",
                statusEmptyDesc: "Please input the current value of your assets to get started.",
                statusHealthyTitle: "Portfolio is Healthy",
                statusHealthyDesc: "All assets are within the target allocation range.",
                statusActionTitle: "Rebalancing Recommended",
                statusActionDesc: "Assets detected deviating by more than {threshold}% (i.e., <{min}% or >{max}%).",
                fireRuleTitle: "About the 4% Rule",
                fireRuleText: "Derived from the <b>Trinity Study</b>. It suggests that if you withdraw <b>4%</b> of your portfolio annually (adjusted for inflation), your money has a high probability of lasting 30+ years. You are 'FIRE' when <b>Assets = 25 Ã— Annual Expenses</b>.",
                introTitle: "What is the Permanent Portfolio?",
                introText: `<p class="mb-4">The Permanent Portfolio is an investment strategy invented by Harry Browne, designed to preserve and grow your wealth under any condition.</p><p class="mb-4">The core concept is simple: divide your assets equally into four parts (${TARGET_PERCENT}% each): <strong>Stocks</strong>, <strong>Long-Term Bonds</strong>, <strong>Cash</strong>, and <strong>Gold</strong>.</p><p>You simply check it once a year. If an asset deviates too far from ${TARGET_PERCENT}% (beyond your set threshold), you "rebalance": sell the winners and buy the losers to get back to ${TARGET_PERCENT}%.</p>`,
                faqTitle: "Frequently Asked Questions (FAQ)",
                faqData: [
                    { question: "Why 4x25?", answer: `<p class="mb-2">It's a double meaning:</p><ul class="list-decimal list-inside space-y-1 ml-1"><li><strong>Permanent Portfolio:</strong> 4 assets at ${TARGET_PERCENT}% each.</li><li><strong>FIRE Movement:</strong> The 4% Rule implies saving 25 times your annual expenses.</li></ul>` },
                    { question: "What is the best rebalancing threshold?", answer: `<p>Harry Browne recommended using a <strong>15/35 band</strong>. This means you rebalance only when an asset drops below 15% or rises above 35% (which equals a Â±10% threshold).</p><p class="mt-2">This calculator defaults to Â±10%, but you can adjust it at the top based on your risk tolerance.</p>` }
                ],
                privacy: "Privacy Policy",
                disclaimer: "Disclaimer: This tool is for informational purposes only and does not constitute financial advice. Invest at your own risk.",
                privacyTitle: "Privacy Policy",
                privacyContent: `<p><strong>1. Data Security & Local Processing</strong><br>This is a client-side application. All calculations are performed locally in your browser. We do not have a backend server, and we do not collect, store, or transmit any of your financial data.</p><p><strong>2. Cookies</strong><br>This website does not use cookies for tracking personal identities.</p><p class="text-xs text-gray-400 mt-4">Last Updated: January 4, 2026</p>`,
                closeBtn: "Close"
            }
        };

        const assetsConfig = [
            { key: 'stocks', color: '#3B82F6', value: 0 },
            { key: 'bonds', color: '#8B5CF6', value: 0 },
            { key: 'cash', color: '#10B981', value: 0 },
            { key: 'gold', color: '#F59E0B', value: 0 }
        ];

        const formatters = {
            zh: {
                standard: new Intl.NumberFormat('zh-CN', { maximumFractionDigits: 0 }),
                compact: new Intl.NumberFormat('zh-CN', { notation: "compact", maximumFractionDigits: 2 })
            },
            en: {
                standard: new Intl.NumberFormat('en-US', { maximumFractionDigits: 0 }),
                compact: new Intl.NumberFormat('en-US', { notation: "compact", maximumFractionDigits: 2 })
            }
        };

        // --- DOM Elements Cache ---
        let domElements = {};
        let assetDomElements = {};

        // --- Initialization ---
        function init() {
            const inputsContainer = document.getElementById('inputs-container');
            const resultBody = document.getElementById('result-body');

            // Best Practice: Use DocumentFragment for batch DOM insertion
            const inputsFragment = document.createDocumentFragment();
            const rowsFragment = document.createDocumentFragment();

            assetsConfig.forEach((asset, index) => {
                const div = document.createElement('div');
                const initialValue = asset.value === 0 ? '' : asset.value;
                
                // Note: Added 'asset-input' class for specific selection
                div.innerHTML = `
                    <label class="block text-sm font-medium text-gray-700 mb-1.5" id="label-${asset.key}" for="input-${asset.key}"></label>
                    <div class="relative">
                        <span class="currency-symbol absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 font-bold select-none" aria-hidden="true"></span>
                        <input type="text" inputmode="numeric" pattern="[0-9]*"
                            id="input-${asset.key}" placeholder="0" data-index="${index}" value="${initialValue}" 
                            class="asset-input w-full pl-8 pr-4 py-3 bg-gray-50 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none font-mono text-lg placeholder-gray-300 transition-shadow">
                    </div>
                `;
                inputsFragment.appendChild(div);

                const tr = document.createElement('tr');
                tr.className = "hover:bg-gray-50 transition-colors";
                tr.innerHTML = `
                    <td class="p-3 text-left">
                        <div class="flex items-center gap-3">
                            <div class="w-3 h-3 rounded-full flex-shrink-0" style="background-color:${asset.color}" aria-hidden="true"></div>
                            <span class="font-medium text-slate-700 whitespace-nowrap" id="name-${asset.key}"></span>
                        </div>
                    </td>
                    <td class="p-3 text-left font-mono">
                        <span id="percent-${asset.key}" class="text-slate-600">0.0%</span>
                    </td>
                    <td class="p-3 text-left font-mono text-slate-600 table-cell-truncate" id="target-${asset.key}">0</td>
                    <td class="p-3 text-left" id="action-${asset.key}">
                        <!-- Default state is now a dash -->
                        <span class="text-gray-300 text-lg font-bold select-none">-</span>
                    </td>
                `;
                rowsFragment.appendChild(tr);
            });

            inputsContainer.appendChild(inputsFragment);
            resultBody.appendChild(rowsFragment);

            // --- Cache DOM Elements (Renamed for clarity) ---
            domElements = {
                totalValue: document.getElementById('total-value'),
                fireYear: document.getElementById('fire-year'),
                fireMonth: document.getElementById('fire-month'),
                statusCard: document.getElementById('status-card'),
                statusTitle: document.getElementById('status-title'),
                statusDesc: document.getElementById('status-desc'),
                statusIcon: document.getElementById('status-icon'),
                thresholdDisplay: document.getElementById('threshold-display'),
                btnMinus: document.getElementById('btn-minus'),
                btnPlus: document.getElementById('btn-plus'),
                btnEn: document.getElementById('btn-en'),
                btnZh: document.getElementById('btn-zh'),
                faqContainer: document.getElementById('faq-container'),
                currencySymbols: document.querySelectorAll('.currency-symbol'),
                i18nElements: document.querySelectorAll('[data-i18n]'),
                // Clean Code: Specific naming to avoid shadowing
                privacyModalEl: document.getElementById('privacy-modal'),
                modalOverlayEl: document.querySelector('.modal-overlay'),
                modalCloseBtnEl: document.getElementById('modal-close-btn'),
                modalContentEl: document.querySelector('.modal-content'),
                appContainer: document.getElementById('app') 
            };

            assetDomElements = Object.fromEntries(
                assetsConfig.map(a => [a.key, {
                    input: document.getElementById(`input-${a.key}`),
                    label: document.getElementById(`label-${a.key}`),
                    name: document.getElementById(`name-${a.key}`),
                    percent: document.getElementById(`percent-${a.key}`),
                    target: document.getElementById(`target-${a.key}`),
                    action: document.getElementById(`action-${a.key}`),
                    chart: document.getElementById(`chart-${a.key}`)
                }])
            );

            bindEvents();
            setLanguage('en');
            updateThresholdUI();
        }

        function bindEvents() {
            domElements.btnEn.addEventListener('click', () => setLanguage('en'));
            domElements.btnZh.addEventListener('click', () => setLanguage('zh'));

            domElements.btnMinus.addEventListener('click', () => changeThreshold(-1));
            domElements.btnPlus.addEventListener('click', () => changeThreshold(1));

            document.getElementById('btn-privacy').addEventListener('click', function() { openPrivacyModal(this); });
            domElements.modalCloseBtnEl.addEventListener('click', closePrivacyModal);
            domElements.modalOverlayEl.addEventListener('click', closePrivacyModal);
            
            domElements.privacyModalEl.addEventListener('keydown', function(e) {
                if (e.key === 'Tab' || e.keyCode === 9) {
                    const focusableElements = domElements.privacyModalEl.querySelectorAll('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])');
                    const firstElement = focusableElements[0];
                    const lastElement = focusableElements[focusableElements.length - 1];

                    if (e.shiftKey) { 
                        if (document.activeElement === firstElement) {
                            e.preventDefault();
                            lastElement.focus();
                        }
                    } else { 
                        if (document.activeElement === lastElement) {
                            e.preventDefault();
                            firstElement.focus();
                        }
                    }
                }
                if (e.key === "Escape") closePrivacyModal();
            });

            Object.values(assetDomElements).forEach(assetDom => {
                assetDom.input.addEventListener('input', handleInput);
            });

            domElements.faqContainer.addEventListener('click', (e) => {
                const btn = e.target.closest('button[data-faq-toggle]');
                if (btn) {
                    const index = btn.getAttribute('data-index');
                    toggleFaq(index);
                }
            });
        }

        // --- Logic Functions ---

        function scheduleCalculate() {
            if (isScheduled) return;
            isScheduled = true;
            requestAnimationFrame(() => {
                calculate();
                isScheduled = false;
            });
        }

        function sanitizeInput(value) {
            let clean = value.replace(/[^\d]/g, '');
            if (clean.length > 1 && clean.startsWith('0')) {
                clean = clean.replace(/^0+/, '');
            }
            if (clean.length > MAX_DIGITS) {
                clean = clean.slice(0, MAX_DIGITS);
            }
            return clean;
        }

        function handleInput(e) {
            const val = e.target.value;
            const clean = sanitizeInput(val);
            
            if (val !== clean) {
                const start = e.target.selectionStart;
                const end = e.target.selectionEnd;
                const oldLen = val.length;
                
                e.target.value = clean;
                
                const newLen = clean.length;
                if (start && end) {
                    e.target.setSelectionRange(start - (oldLen - newLen), end - (oldLen - newLen));
                }
            }
            scheduleCalculate();
        }

        function updateChart(total) {
            let accumulatedPercent = 0;
            assetsConfig.forEach(asset => {
                const circle = assetDomElements[asset.key].chart;
                if (total === 0) {
                    circle.style.strokeDasharray = `0 100`;
                    circle.style.strokeDashoffset = 0;
                    return;
                }
                const percent = (asset.value / total) * 100;
                circle.style.strokeDasharray = `${percent} 100`;
                circle.style.strokeDashoffset = -accumulatedPercent;
                accumulatedPercent += percent;
            });
        }

        function calculate() {
            const t = translations[currentLang];
            const sym = t.symbol;
            let total = 0;
            
            assetsConfig.forEach((asset) => {
                let valStr = assetDomElements[asset.key].input.value;
                let val = parseInt(valStr.replace(/[^\d]/g, ''), 10);
                if (isNaN(val)) val = 0;
                asset.value = val;
                total += val;
            });

            domElements.totalValue.textContent = formatNumberCompact(total, currentLang, sym);
            domElements.fireYear.textContent = formatNumberCompact(total * 0.04, currentLang, sym);
            domElements.fireMonth.textContent = formatNumberCompact(total * 0.04 / 12, currentLang, sym);

            updateChart(total);

            const baseTarget = Math.floor(total / 4);
            const remainder = total % 4;
            const targets = assetsConfig.map((_, index) => {
                return baseTarget + (index < remainder ? 1 : 0);
            });

            let globalNeedsRebalance = false;

            assetsConfig.forEach((asset, index) => {
                const currentPercent = total === 0 ? 0 : (asset.value / total) * 100;
                // Clean Code: Use constant instead of magic number 25
                const isBreached = total > 0 && (currentPercent > (TARGET_PERCENT + currentThreshold) || currentPercent < (TARGET_PERCENT - currentThreshold));
                if (isBreached) globalNeedsRebalance = true;
            });

            assetsConfig.forEach((asset, index) => {
                const currentPercent = total === 0 ? 0 : (asset.value / total) * 100;
                const targetValue = targets[index];
                const diff = targetValue - asset.value;
                // Clean Code: Use constant
                const isBreached = total > 0 && (currentPercent > (TARGET_PERCENT + currentThreshold) || currentPercent < (TARGET_PERCENT - currentThreshold));
                
                const el = assetDomElements[asset.key];

                el.percent.textContent = currentPercent.toFixed(1) + '%';
                el.percent.className = isBreached ? 'text-red-500 font-bold' : 'text-slate-600';

                const targetText = formatNumberCompact(targetValue, currentLang, sym);
                el.target.textContent = targetText;
                el.target.title = targetText;

                let actionHtml = '';
                
                // --- MODIFIED LOGIC START ---
                if (total === 0) {
                    // Show a dash for empty state
                    actionHtml = `<span class="text-gray-300 text-lg font-bold select-none">-</span>`;
                } else if (globalNeedsRebalance) {
                    if (Math.abs(diff) > 0) {
                        const type = diff > 0 ? t.buy : t.sell;
                        const colorClass = diff > 0 ? 'bg-blue-50 text-blue-700' : 'bg-orange-50 text-orange-700';
                        actionHtml = `<div class="inline-flex items-center gap-1.5 px-3 py-1 rounded-full text-sm font-bold ${colorClass} whitespace-nowrap">${type} <span class="font-mono ml-1">${formatNumberCompact(Math.abs(diff), currentLang, '')}</span></div>`;
                    } else {
                        actionHtml = `<span class="text-gray-400 text-sm font-medium">${t.hold}</span>`;
                    }
                } else {
                    actionHtml = `<span class="text-gray-400 text-sm font-medium bg-gray-100 px-3 py-1 rounded-full">${t.hold}</span>`;
                }
                // --- MODIFIED LOGIC END ---
                
                if (el.action.innerHTML !== actionHtml) {
                    el.action.innerHTML = actionHtml;
                }
            });

            if (total === 0) {
                domElements.statusCard.className = "rounded-2xl p-6 border-l-4 shadow-sm transition-all bg-blue-50 border-blue-500 text-blue-900";
                domElements.statusIcon.textContent = "ğŸ‘‹";
                domElements.statusTitle.textContent = t.statusEmptyTitle;
                domElements.statusDesc.textContent = t.statusEmptyDesc;
            } else if (globalNeedsRebalance) {
                domElements.statusCard.className = "rounded-2xl p-6 border-l-4 shadow-sm transition-all bg-amber-50 border-amber-500 text-amber-900";
                domElements.statusIcon.textContent = "âš ï¸";
                domElements.statusTitle.textContent = t.statusActionTitle;
                // Clean Code: Use constant
                domElements.statusDesc.textContent = t.statusActionDesc.replace('{threshold}', currentThreshold).replace('{min}', TARGET_PERCENT - currentThreshold).replace('{max}', TARGET_PERCENT + currentThreshold);
            } else {
                domElements.statusCard.className = "rounded-2xl p-6 border-l-4 shadow-sm transition-all bg-emerald-50 border-emerald-500 text-emerald-900";
                domElements.statusIcon.textContent = "âœ…";
                domElements.statusTitle.textContent = t.statusHealthyTitle;
                domElements.statusDesc.textContent = t.statusHealthyDesc;
            }
        }

        function changeThreshold(delta) {
            const newValue = currentThreshold + delta;
            if (newValue >= MIN_THRESHOLD && newValue <= MAX_THRESHOLD) {
                currentThreshold = newValue;
                updateThresholdUI();
                scheduleCalculate();
            }
        }
        function updateThresholdUI() {
            domElements.thresholdDisplay.textContent = currentThreshold;
            domElements.btnMinus.disabled = (currentThreshold <= MIN_THRESHOLD);
            domElements.btnPlus.disabled = (currentThreshold >= MAX_THRESHOLD);
        }

        function toggleFaq(index) {
            const content = document.getElementById(`faq-content-${index}`);
            const icon = document.getElementById(`faq-icon-${index}`);
            const button = document.getElementById(`faq-btn-${index}`);
            
            const isOpen = content.classList.contains('open');
            
            if (isOpen) {
                content.classList.remove('open');
                icon.classList.remove('rotate');
                button.setAttribute('aria-expanded', 'false');
                content.setAttribute('aria-hidden', 'true');
            } else {
                content.classList.add('open');
                icon.classList.add('rotate');
                button.setAttribute('aria-expanded', 'true');
                content.setAttribute('aria-hidden', 'false');
            }
        }

        let lastFocusedElement;
        let prevBodyOverflow = '';

        function openPrivacyModal(triggerElement) {
            lastFocusedElement = triggerElement; 
            prevBodyOverflow = document.body.style.overflow;
            document.body.style.overflow = 'hidden';
            
            domElements.privacyModalEl.classList.remove('hidden');
            domElements.appContainer.setAttribute('aria-hidden', 'true');
            domElements.appContainer.inert = true; 

            setTimeout(() => {
                domElements.modalOverlayEl.classList.remove('opacity-0');
                domElements.modalContentEl.classList.remove('opacity-0', 'translate-y-4', 'sm:translate-y-0', 'sm:scale-95');
                domElements.modalContentEl.classList.add('opacity-100', 'translate-y-0', 'sm:scale-100');
                domElements.modalCloseBtnEl.focus();
            }, 10);
        }

        function closePrivacyModal() {
            domElements.modalOverlayEl.classList.add('opacity-0');
            domElements.modalContentEl.classList.remove('opacity-100', 'translate-y-0', 'sm:scale-100');
            domElements.modalContentEl.classList.add('opacity-0', 'translate-y-4', 'sm:translate-y-0', 'sm:scale-95');
            
            document.body.style.overflow = prevBodyOverflow;
            
            domElements.appContainer.setAttribute('aria-hidden', 'false');
            domElements.appContainer.inert = false;

            setTimeout(() => { 
                domElements.privacyModalEl.classList.add('hidden');
                if (lastFocusedElement) lastFocusedElement.focus();
            }, 300);
        }

        function setLanguage(lang) {
            currentLang = lang;
            document.documentElement.lang = lang === 'zh' ? 'zh-CN' : 'en';
            
            domElements.btnZh.classList.toggle('active', lang === 'zh');
            domElements.btnEn.classList.toggle('active', lang === 'en');
            domElements.btnZh.setAttribute('aria-pressed', lang === 'zh');
            domElements.btnEn.setAttribute('aria-pressed', lang === 'en');
            
            const dict = translations[lang];

            domElements.i18nElements.forEach(el => {
                const key = el.getAttribute('data-i18n');
                if (Object.prototype.hasOwnProperty.call(dict, key)) {
                    const value = dict[key];
                    if (el.dataset.i18nHtml === 'true') {
                        el.innerHTML = value;
                    } else {
                        el.textContent = value;
                    }
                }
            });

            assetsConfig.forEach(asset => {
                assetDomElements[asset.key].label.textContent = translations[lang][asset.key];
                assetDomElements[asset.key].name.textContent = translations[lang][asset.key];
            });

            // Use DocumentFragment for FAQ re-render as well
            domElements.faqContainer.innerHTML = ''; 
            const faqFragment = document.createDocumentFragment();
            translations[lang].faqData.forEach((item, index) => {
                const faqItem = document.createElement('div');
                faqItem.className = 'border border-gray-200 rounded-xl overflow-hidden bg-white';
                faqItem.innerHTML = `<button type="button" id="faq-btn-${index}" data-faq-toggle="true" data-index="${index}" aria-expanded="false" aria-controls="faq-content-${index}" class="w-full flex justify-between items-center p-4 bg-gray-50 hover:bg-gray-100 transition-colors text-left focus:outline-none"><span class="font-bold text-slate-800 text-sm md:text-base">${item.question}</span><svg id="faq-icon-${index}" class="faq-icon w-5 h-5 text-slate-400 flex-shrink-0 ml-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg></button><div id="faq-content-${index}" class="faq-content bg-white" role="region" aria-labelledby="faq-btn-${index}" aria-hidden="true"><div class="p-4 text-sm text-slate-600 leading-relaxed border-t border-gray-100">${item.answer}</div></div>`;
                faqFragment.appendChild(faqItem);
            });
            domElements.faqContainer.appendChild(faqFragment);

            const symbol = translations[lang].symbol;
            domElements.currencySymbols.forEach(el => { el.textContent = symbol; });
            document.title = lang === 'en' ? "4x25 - Permanent Portfolio & FIRE Calculator" : "4x25 - æ°¸ä¹…æŠ•èµ„ç»„åˆå†å¹³è¡¡è®¡ç®—å™¨ & FIRE 4%æ³•åˆ™å·¥å…·";
            scheduleCalculate(); 
        }

        function formatNumberCompact(num, lang, symbol) {
            const useCompact = num > 1000000000; 
            const formatter = useCompact ? formatters[lang].compact : formatters[lang].standard;
            const valueToFormat = useCompact ? num : Math.round(num);
            return symbol + formatter.format(valueToFormat);
        }

        // Start
        init();
    </script>
</body>
</html>
