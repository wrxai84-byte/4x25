<!DOCTYPE html>
<html lang="en" prefix="og: http://ogp.me/ns#">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>4x25 Strategy & FIRE Tool | æ°¸ä¹…æŠ•èµ„ç»„åˆè®¡ç®—å™¨</title>
    <meta name="description" content="Free Permanent Portfolio Rebalancing Tool & FIRE Calculator.">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸ€</text></svg>">
    <script src="https://cdn.tailwindcss.com/3.4.1"></script>
    <style>
        body { font-family: system-ui, -apple-system, sans-serif; font-feature-settings: "tnum"; -webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; margin: 0; }
        .lang-btn.active { background-color: #3b82f6; color: white; border-color: #3b82f6; }
        button:disabled { opacity: 0.3; cursor: not-allowed; pointer-events: none; }
        .table-cell-truncate { max-width: 140px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .faq-content { display: grid; grid-template-rows: 0fr; transition: grid-template-rows 0.3s ease-out, opacity 0.3s ease-out; opacity: 0; visibility: hidden; }
        .faq-content.open { grid-template-rows: 1fr; opacity: 1; visibility: visible; }
        .faq-inner { overflow: hidden; min-height: 0; }
        .faq-icon { transition: transform 0.3s ease; }
        .faq-icon.rotate { transform: rotate(180deg); }
        .modal-overlay { transition: opacity 0.3s ease; }
        .modal-content { transition: transform 0.3s ease, opacity 0.3s ease; max-height: 85vh; display: flex; flex-direction: column; }
        .chart-segment { transition: stroke-dasharray 0.6s cubic-bezier(0.4, 0, 0.2, 1), stroke-dashoffset 0.6s cubic-bezier(0.4, 0, 0.2, 1); will-change: stroke-dasharray, stroke-dashoffset; transform: translateZ(0); }
        button:focus-visible, input:focus-visible, a:focus-visible, .season-card:focus-visible { outline: 2px solid #2563eb; outline-offset: 2px; z-index: 10; }
        .season-card { transition: transform 0.2s ease, box-shadow 0.2s ease; }
        .season-card:hover { transform: translateY(-2px); box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1); }
        @keyframes textFlash { 0% { color: #10B981; text-shadow: 0 0 5px rgba(16, 185, 129, 0.5); } 100% { color: #94a3b8; text-shadow: none; } }
        .flash-update { animation: textFlash 1s ease-out; }
        #toast-container { position: fixed; bottom: 20px; right: 20px; z-index: 100; display: flex; flex-direction: column; gap: 10px; pointer-events: none; }
        .toast { pointer-events: auto; min-width: 300px; padding: 16px; border-radius: 12px; background: white; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); border-left: 4px solid; transform: translateX(120%); transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1), opacity 0.3s ease; opacity: 0; display: flex; align-items: start; gap: 12px; }
        .toast.show { transform: translateX(0); opacity: 1; }
        .toast-error { border-left-color: #EF4444; }
        .toast-success { border-left-color: #10B981; }
        .toast-info { border-left-color: #3B82F6; }
        .chart-path { transition: d 0.6s ease-out, fill 0.6s ease; }
        .chart-area-path { opacity: 0.2; transition: d 0.6s ease-out, fill 0.6s ease; }
        .content-auto { content-visibility: auto; contain-intrinsic-size: 1px 1000px; }
        
        /* --- Ambient Background Effect --- */
        .ambient-bg { position: fixed; top: 0; left: 0; width: 100%; height: 100%; overflow: hidden; z-index: -1; pointer-events: none; opacity: 0.6; }
        .orb { position: absolute; border-radius: 50%; filter: blur(80px); opacity: 0.4; animation: float 20s infinite ease-in-out alternate; will-change: transform; }
        
        /* Stocks (Blue) */
        .orb-1 { width: 50vw; height: 50vw; background: #3B82F6; top: -10%; left: -10%; animation-duration: 25s; }
        /* Bonds (Purple) */
        .orb-2 { width: 40vw; height: 40vw; background: #8B5CF6; top: 10%; right: -10%; animation-duration: 28s; animation-delay: -5s; }
        /* Cash (Green) */
        .orb-3 { width: 45vw; height: 45vw; background: #10B981; bottom: -10%; left: 10%; animation-duration: 32s; animation-delay: -10s; }
        /* Gold (Yellow/Amber) */
        .orb-4 { width: 35vw; height: 35vw; background: #F59E0B; bottom: 10%; right: 20%; animation-duration: 22s; animation-delay: -2s; }

        @keyframes float {
            0% { transform: translate(0, 0) scale(1); }
            33% { transform: translate(30px, -50px) scale(1.1); }
            66% { transform: translate(-20px, 20px) scale(0.9); }
            100% { transform: translate(0, 0) scale(1); }
        }

        @media (prefers-reduced-motion: reduce) { *, ::before, ::after { animation-duration: 0.01ms !important; animation-iteration-count: 1 !important; transition-duration: 0.01ms !important; scroll-behavior: auto !important; } .chart-segment { transition: none; } .flash-update { animation: none; } .toast { transition: none; } .chart-path { transition: none; } .orb { animation: none; } }
        @media (max-width: 640px) { .modal-content { max-height: 80vh; width: 92%; margin: 0 auto; } #toast-container { right: 50%; transform: translateX(50%); width: 90%; bottom: 10px; } .toast { min-width: 0; width: 100%; } .orb { filter: blur(50px); opacity: 0.3; } }
    </style>
</head>
<body class="bg-gray-50/80 text-slate-800 min-h-screen flex flex-col relative">

    <!-- Ambient Background Layer -->
    <div class="ambient-bg" aria-hidden="true">
        <div class="orb orb-1"></div> <!-- Stocks: Blue -->
        <div class="orb orb-2"></div> <!-- Bonds: Purple -->
        <div class="orb orb-3"></div> <!-- Cash: Green -->
        <div class="orb orb-4"></div> <!-- Gold: Amber -->
    </div>

    <div id="app" class="flex flex-col min-h-screen p-4 md:p-8 relative z-10">
        <div class="max-w-5xl mx-auto w-full flex-grow">
            <!-- Header -->
            <header class="mb-10 flex flex-col md:flex-row md:items-end justify-between gap-6 border-b border-gray-200/60 pb-6 backdrop-blur-sm">
                <div class="flex flex-col justify-center">
                    <h1 class="flex items-center tracking-tighter select-none group cursor-default">
                        <span class="text-5xl md:text-6xl font-black text-slate-900 tracking-tight">4</span>
                        <span class="text-3xl md:text-4xl font-bold text-blue-500 mx-1 opacity-80 group-hover:opacity-100 transition-opacity">Ã—</span>
                        <span class="text-5xl md:text-6xl font-black text-slate-900 tracking-tight">25</span>
                    </h1>
                    <h2 class="text-slate-500 mt-3 text-base md:text-lg font-medium" data-i18n="subtitle">Permanent Portfolio Strategy & FIRE Tool</h2>
                </div>
                <div class="flex rounded-lg shadow-sm overflow-hidden border border-gray-300 bg-white/90 self-start md:self-end" role="group" aria-label="Language Switcher">
                    <button type="button" id="btn-en" class="lang-btn w-20 flex justify-center px-4 py-3 text-sm font-bold hover:bg-gray-50 transition-colors active" aria-label="Switch to English">EN</button>
                    <div class="w-px bg-gray-300"></div>
                    <button type="button" id="btn-zh" class="lang-btn w-20 flex justify-center px-4 py-3 text-sm font-bold hover:bg-gray-50 transition-colors" aria-label="åˆ‡æ¢åˆ°ä¸­æ–‡">ä¸­æ–‡</button>
                </div>
            </header>

            <main class="grid grid-cols-1 lg:grid-cols-12 gap-8">
                <!-- Left Column -->
                <section class="lg:col-span-4 space-y-6">
                    <div class="bg-white/80 backdrop-blur-md rounded-2xl shadow-sm border border-white/50 p-6">
                        <h3 class="text-xl font-bold mb-6 flex items-center gap-2" data-i18n="inputTitle">ğŸ’° Current Holdings</h3>
                        <div class="space-y-5" id="inputs-container"></div>
                        <div class="mt-8 pt-6 border-t border-gray-100 flex justify-between items-center overflow-hidden">
                            <span class="text-gray-500 font-medium whitespace-nowrap mr-2" data-i18n="totalValue">Total Value</span>
                            <span class="text-2xl font-bold text-slate-900 font-mono truncate" id="total-value" data-current-value="0" aria-live="polite" aria-atomic="true">0</span>
                        </div>
                    </div>

                    <div class="bg-white/80 backdrop-blur-md rounded-2xl shadow-sm border border-white/50 p-6 flex flex-col items-center">
                        <div class="relative w-48 h-48 mb-6" role="img" aria-label="Portfolio Allocation Chart">
                            <svg viewBox="0 0 32 32" class="w-full h-full transform -rotate-90" aria-hidden="true">
                                <circle r="15.9155" cx="16" cy="16" fill="transparent" stroke="#f3f4f6" stroke-width="6"></circle>
                                <circle id="chart-stocks" class="chart-segment" r="15.9155" cx="16" cy="16" fill="transparent" stroke="#3B82F6" stroke-width="6" stroke-dasharray="0 100" stroke-dashoffset="0"></circle>
                                <circle id="chart-bonds" class="chart-segment" r="15.9155" cx="16" cy="16" fill="transparent" stroke="#8B5CF6" stroke-width="6" stroke-dasharray="0 100" stroke-dashoffset="0"></circle>
                                <circle id="chart-cash" class="chart-segment" r="15.9155" cx="16" cy="16" fill="transparent" stroke="#10B981" stroke-width="6" stroke-dasharray="0 100" stroke-dashoffset="0"></circle>
                                <circle id="chart-gold" class="chart-segment" r="15.9155" cx="16" cy="16" fill="transparent" stroke="#F59E0B" stroke-width="6" stroke-dasharray="0 100" stroke-dashoffset="0"></circle>
                            </svg>
                            <div class="absolute inset-0 flex items-center justify-center pointer-events-none flex-col">
                                <span class="text-slate-900 font-black text-xl tracking-tight">4<span class="text-blue-500 mx-px">Ã—</span>25</span>
                            </div>
                        </div>
                        <div class="w-full px-6 space-y-3" id="legend-container"></div>
                    </div>

                    <div class="bg-white/80 backdrop-blur-md rounded-2xl shadow-sm border border-white/50 p-6">
                        <h3 class="text-base font-bold text-slate-900 mb-4 flex items-center gap-2">
                            <span class="text-xl" aria-hidden="true">ğŸ§­</span> <span data-i18n="seasonTitle">Economic Seasons</span>
                        </h3>
                        <div class="grid grid-cols-2 gap-3 mb-4">
                            <div class="season-card bg-blue-50/80 border border-blue-100 rounded-xl p-3 flex flex-col items-center text-center cursor-default outline-none" role="region" aria-label="Prosperity Season Strategy: Stocks" tabindex="0">
                                <span class="text-xl mb-1" aria-hidden="true">ğŸ“ˆ</span>
                                <span class="text-xs font-bold text-blue-400 uppercase tracking-wide mb-0.5" data-i18n="seasonProsperity">Prosperity</span>
                                <span class="text-sm font-bold text-blue-700" data-i18n="seasonStocks">Stocks</span>
                            </div>
                            <div class="season-card bg-violet-50/80 border border-violet-100 rounded-xl p-3 flex flex-col items-center text-center cursor-default outline-none" role="region" aria-label="Deflation Season Strategy: Bonds" tabindex="0">
                                <span class="text-xl mb-1" aria-hidden="true">ğŸ“œ</span>
                                <span class="text-xs font-bold text-violet-400 uppercase tracking-wide mb-0.5" data-i18n="seasonDeflation">Deflation</span>
                                <span class="text-sm font-bold text-violet-700" data-i18n="seasonBonds">Bonds</span>
                            </div>
                            <div class="season-card bg-emerald-50/80 border border-emerald-100 rounded-xl p-3 flex flex-col items-center text-center cursor-default outline-none" role="region" aria-label="Recession Season Strategy: Cash" tabindex="0">
                                <span class="text-xl mb-1" aria-hidden="true">ğŸ›¡ï¸</span>
                                <span class="text-xs font-bold text-emerald-400 uppercase tracking-wide mb-0.5" data-i18n="seasonRecession">Recession</span>
                                <span class="text-sm font-bold text-emerald-700" data-i18n="seasonCash">Cash</span>
                            </div>
                            <div class="season-card bg-amber-50/80 border border-amber-100 rounded-xl p-3 flex flex-col items-center text-center cursor-default outline-none" role="region" aria-label="Inflation Season Strategy: Gold" tabindex="0">
                                <span class="text-xl mb-1" aria-hidden="true">ğŸª™</span>
                                <span class="text-xs font-bold text-amber-400 uppercase tracking-wide mb-0.5" data-i18n="seasonInflation">Inflation</span>
                                <span class="text-sm font-bold text-amber-700" data-i18n="seasonGold">Gold</span>
                            </div>
                        </div>
                        <div class="bg-slate-50/80 rounded-lg p-3 text-xs text-slate-500 leading-relaxed border border-slate-100">
                            <span class="font-bold text-slate-700"><span aria-hidden="true">ğŸ’¡</span> <span data-i18n="rule72Title">Rule of 72</span>:</span> 
                            <span id="rule72-desc">Calculating...</span>
                        </div>
                    </div>
                </section>

                <!-- Right Column -->
                <section class="lg:col-span-8 space-y-6">
                    <div id="status-card" class="rounded-2xl p-6 border shadow-sm transition-all bg-blue-50/90 border-blue-200 text-blue-900 backdrop-blur-sm" role="status" aria-live="polite">
                        <div class="flex items-start gap-4">
                            <div id="status-icon" class="text-2xl" aria-hidden="true">âš–ï¸</div>
                            <div>
                                <h3 class="text-lg font-bold" id="status-title">...</h3>
                                <p class="mt-1 text-sm" id="status-desc">...</p>
                                <p class="mt-2 text-xs opacity-75 hidden" id="status-note"></p>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white/80 backdrop-blur-md rounded-2xl shadow-sm border border-white/50 overflow-hidden">
                        <div class="p-6 border-b border-gray-100 flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                            <h3 class="text-xl font-bold" data-i18n="rebalanceTitle">ğŸ”„ Rebalancing Suggestions</h3>
                            <div class="flex flex-wrap items-center gap-3 sm:gap-4">
                                <div class="bg-gray-50/80 px-2 py-1 rounded-lg border border-gray-200 flex items-center gap-2 select-none">
                                    <span class="text-xs font-bold text-gray-500 ml-1" data-i18n="thresholdLabel" id="threshold-label">Threshold: Â±</span>
                                    <div class="flex items-center bg-white rounded border border-gray-200 shadow-sm">
                                        <button type="button" id="btn-minus" class="w-6 h-6 flex items-center justify-center text-slate-600 hover:text-blue-600 hover:bg-blue-50 transition-all font-bold text-base rounded-l" aria-label="Decrease threshold">-</button>
                                        <div class="w-8 text-center font-bold text-slate-800 text-sm border-x border-gray-100" id="threshold-display">10</div>
                                        <button type="button" id="btn-plus" class="w-6 h-6 flex items-center justify-center text-slate-600 hover:text-blue-600 hover:bg-blue-50 transition-all font-bold text-base rounded-r" aria-label="Increase threshold">+</button>
                                    </div>
                                    <span class="text-xs font-bold text-slate-400 mr-1">%</span>
                                </div>
                                <span class="text-xs font-mono bg-gray-100/80 text-gray-600 px-2 py-1.5 rounded border border-gray-200" data-i18n="targetLabel">Target: 25%</span>
                            </div>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-left border-collapse">
                                <thead>
                                    <tr class="bg-gray-50/50 text-gray-500 text-sm uppercase tracking-wider">
                                        <th class="p-3 font-medium whitespace-nowrap text-left pl-4" data-i18n="colAsset">Asset</th>
                                        <th class="p-3 font-medium whitespace-nowrap text-left" data-i18n="colCurrent">Current %</th>
                                        <th class="p-3 font-medium whitespace-nowrap text-left" data-i18n="colTarget">Target Value</th>
                                        <th class="p-3 font-medium whitespace-nowrap text-left pl-4" data-i18n="colAction">Action</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-gray-100" id="result-body"></tbody>
                            </table>
                        </div>
                    </div>

                    <div class="bg-slate-900/95 backdrop-blur-xl text-white rounded-2xl p-6 shadow-lg overflow-hidden transition-colors duration-500" id="fire-card">
                        <h3 class="text-lg font-bold mb-4 flex items-center gap-2">
                            <span id="fire-header-icon" class="text-2xl transition-all duration-500" aria-hidden="true">ğŸ”¥</span> 
                            <span id="fire-header-title" data-i18n="fireTitle">FIRE 4% Rule Preview</span>
                        </h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                            <div class="overflow-hidden">
                                <p class="text-slate-400 text-sm mb-1" data-i18n="fireYear">Safe Annual Withdrawal</p>
                                <p class="text-3xl font-mono font-bold text-emerald-400 truncate" id="fire-year" data-current-value="0">0</p>
                            </div>
                            <div class="overflow-hidden">
                                <p class="text-slate-400 text-sm mb-1" data-i18n="fireMonth">Safe Monthly Withdrawal</p>
                                <p class="text-2xl font-mono font-bold text-emerald-400 truncate" id="fire-month" data-current-value="0">0</p>
                            </div>
                        </div>
                        <div class="border-t border-slate-700 pt-5">
                            <div class="flex flex-col sm:flex-row justify-between items-end gap-2 mb-2">
                                <label class="text-sm font-medium text-slate-300" for="fire-expense-input" data-i18n="fireExpenseLabel">Annual Expense Goal</label>
                                <div class="text-right flex items-baseline gap-2">
                                    <span class="text-xs text-slate-500 uppercase tracking-wider font-bold" data-i18n="fireProgress">Progress</span>
                                    <span class="text-2xl font-bold text-white font-mono transition-colors duration-300" id="fire-percent" aria-live="polite" aria-atomic="true">0%</span>
                                </div>
                            </div>
                            <div class="relative mb-3">
                                <span class="currency-symbol absolute left-3 top-1/2 -translate-y-1/2 text-slate-500 font-bold text-sm"></span>
                                <input type="text" id="fire-expense-input" inputmode="numeric" maxlength="8" class="w-full bg-slate-800 border border-slate-600 rounded-lg py-2.5 pl-8 pr-3 text-white placeholder-slate-500 focus:ring-2 focus:ring-emerald-500 focus:border-transparent outline-none transition-all font-mono shadow-inner" placeholder="0">
                            </div>
                            <div class="h-3 bg-slate-800 rounded-full overflow-hidden mb-2 shadow-inner border border-slate-700/50" role="progressbar" aria-valuemin="0" aria-valuemax="100">
                                <div id="fire-progress-bar" class="h-full bg-gradient-to-r from-emerald-600 to-emerald-400 transition-all duration-700 ease-out w-0 shadow-[0_0_10px_rgba(16,185,129,0.5)]"></div>
                            </div>
                            
                            <div id="fire-footer-standard" class="flex justify-between text-xs text-slate-500 font-mono transition-opacity duration-300">
                                <span>0</span>
                                <div>
                                    <span data-i18n="fireTargetLabel">Target (25x)</span>: <span id="fire-target-display" class="text-slate-400">0</span>
                                </div>
                            </div>
                            
                            <div id="fire-footer-diogenes" class="hidden text-center pt-1 transition-opacity duration-300">
                                <span class="text-yellow-400 font-bold text-sm italic font-serif tracking-wide" id="diogenes-quote"></span>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white/80 backdrop-blur-md rounded-2xl shadow-sm border border-white/50 p-6">
                        <div class="flex flex-col sm:flex-row sm:items-center justify-between mb-6 gap-4">
                            <h3 class="text-xl font-bold flex items-center gap-2">
                                <span class="text-purple-500" aria-hidden="true">ğŸ²</span> <span data-i18n="projTitle">Monte Carlo Simulation</span>
                            </h3>
                            <div class="flex items-center gap-2">
                                <button type="button" id="btn-simulate" class="px-3 py-1.5 text-xs font-bold rounded-md shadow-sm bg-purple-100 text-purple-700 hover:bg-purple-200 transition-all flex items-center gap-1">
                                    <span class="text-lg leading-none">â†»</span> <span data-i18n="btnSimulate">Resimulate</span>
                                </button>
                                <div class="flex bg-gray-100 p-1 rounded-lg">
                                    <button type="button" id="mode-saving" class="px-3 py-1.5 text-xs font-bold rounded-md shadow-sm bg-white text-emerald-600 transition-all"><span data-i18n="modeSaving">Saving</span></button>
                                    <button type="button" id="mode-spending" class="px-3 py-1.5 text-xs font-bold rounded-md text-gray-500 hover:text-gray-700 transition-all"><span data-i18n="modeSpending">Spending</span></button>
                                </div>
                            </div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="space-y-4">
                                <div>
                                    <div class="mb-1"><label class="block text-xs font-bold text-gray-500 uppercase" data-i18n="projCurrent">Current Assets</label></div>
                                    <div class="relative">
                                        <span class="currency-symbol absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 font-bold text-sm"></span>
                                        <input type="text" id="proj-principal" maxlength="12" class="w-full pl-7 pr-3 py-2 bg-gray-50/50 border border-gray-200 rounded-lg font-mono text-sm focus:ring-2 focus:ring-purple-500 outline-none placeholder-gray-300 transition-colors" placeholder="0">
                                    </div>
                                </div>
                                <div class="grid grid-cols-2 gap-4">
                                    <div class="flex flex-col h-full">
                                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1" data-i18n="projYears">Years</label>
                                        <input type="text" inputmode="numeric" id="proj-years" value="10" placeholder="1" class="mt-auto w-full px-3 py-2 bg-gray-50/50 border border-gray-200 rounded-lg font-mono text-sm focus:ring-2 focus:ring-purple-500 outline-none placeholder-gray-300">
                                    </div>
                                    <div class="flex flex-col h-full">
                                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1" id="proj-flow-label" data-i18n="projContribution">Annual Contribution</label>
                                        <div class="relative mt-auto">
                                            <span class="currency-symbol absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 font-bold text-sm"></span>
                                            <input type="text" id="proj-flow" maxlength="12" class="w-full pl-7 pr-3 py-2 bg-gray-50/50 border border-gray-200 rounded-lg font-mono text-sm focus:ring-2 focus:ring-purple-500 outline-none placeholder-gray-300" placeholder="0">
                                        </div>
                                    </div>
                                </div>
                                <div class="bg-purple-50/80 rounded-lg p-3 text-xs text-purple-800 border border-purple-100 space-y-2">
                                    <div>
                                        <p class="font-bold mb-1" data-i18n="monteCarloTitle">Based on US Market Data (1976-2025):</p>
                                        <p class="opacity-80 leading-relaxed" data-i18n="monteCarloDesc">Simulating 1,000 possible futures by randomly sampling from 50 years of historical US Permanent Portfolio returns.</p>
                                    </div>
                                    <div class="border-t border-purple-200 pt-2 mt-2">
                                        <p class="font-bold flex items-center gap-1">
                                            <span class="text-sm italic font-serif">e</span>
                                            <span data-i18n="continuousCompoundingTitle">Continuous Compounding Model</span>
                                        </p>
                                        <p class="opacity-80 leading-relaxed mt-1" data-i18n="continuousCompoundingDesc">Using Euler's number (e) to simulate continuous cash flows (daily contributions/spending) rather than lump-sum year-end transactions.</p>
                                    </div>
                                </div>
                            </div>
                            <div class="flex flex-col h-full">
                                <div class="bg-white/50 rounded-lg border border-gray-100 overflow-hidden relative flex-grow min-h-[200px] mb-2">
                                    <div class="absolute top-2 left-3 z-10 pointer-events-none">
                                        <p class="text-xs font-bold text-gray-400 uppercase tracking-wider" data-i18n="projChartTitle">Wealth Projection</p>
                                    </div>
                                    <svg id="proj-chart" class="w-full h-full block" preserveAspectRatio="none" viewBox="0 0 100 100" role="img" aria-label="Monte Carlo Simulation Chart">
                                        <defs>
                                            <linearGradient id="grad-fan" x1="0%" y1="0%" x2="0%" y2="100%">
                                                <stop offset="0%" style="stop-color:#a855f7;stop-opacity:0.3" />
                                                <stop offset="100%" style="stop-color:#a855f7;stop-opacity:0.05" />
                                            </linearGradient>
                                        </defs>
                                        <path id="proj-chart-fan" class="chart-area-path" d="" fill="url(#grad-fan)"></path>
                                        <path id="proj-chart-line" class="chart-path" d="" fill="none" stroke="#9333ea" stroke-width="2" vector-effect="non-scaling-stroke"></path>
                                    </svg>
                                    <div class="absolute bottom-2 right-3 pointer-events-none flex items-baseline gap-2 bg-white/90 px-2 rounded-lg backdrop-blur-[2px]">
                                        <span class="text-xs text-gray-500 font-bold whitespace-nowrap" data-i18n="projMedian">Median Outcome</span>
                                        <span class="text-xl font-bold text-purple-700 font-mono" id="proj-result">0</span>
                                    </div>
                                </div>
                                <div class="flex justify-between text-xs text-gray-400 px-1">
                                    <span>Now</span>
                                    <span id="proj-end-year">Future</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>
            </main>

            <section class="mt-10 max-w-4xl mx-auto content-auto">
                <h3 class="text-lg font-bold text-slate-800 mb-6 text-center" data-i18n="faqTitle">Frequently Asked Questions (FAQ)</h3>
                <div id="faq-container" class="space-y-4 min-h-[100px]"></div>
            </section>
        </div>

        <footer class="mt-12 text-center pb-8 px-4 border-t border-gray-200/60 pt-8">
            <p class="text-slate-400 text-sm">
                &copy; 2026 4x25 Â· <button type="button" id="btn-privacy" class="cursor-pointer hover:text-slate-600 transition-colors underline decoration-slate-300 underline-offset-2" data-i18n="privacy">Terms & Privacy</button>
            </p>
        </footer>
    </div>

    <div id="toast-container"></div>

    <div id="privacy-modal" class="fixed inset-0 z-50 hidden" role="dialog" aria-modal="true" aria-labelledby="modal-title">
        <div class="modal-overlay absolute inset-0 bg-slate-900/50 backdrop-blur-sm transition-opacity opacity-0"></div>
        <div class="flex min-h-full items-center justify-center p-4 text-center sm:p-0">
            <div class="modal-content relative transform rounded-2xl bg-white text-left shadow-xl transition-all opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95" id="modal-panel">
                <div class="bg-white px-4 pt-5 sm:p-6 border-b border-gray-100 flex-shrink-0">
                    <h3 class="text-xl font-bold leading-6 text-slate-900" id="modal-title" data-i18n="privacyTitle">Terms & Privacy Policy</h3>
                </div>
                <div class="flex-1 overflow-y-auto px-4 py-4 sm:px-6">
                    <div id="modal-body" class="text-sm text-slate-600 space-y-4 leading-relaxed"></div>
                </div>
                <div class="bg-gray-50 px-4 py-3 sm:flex sm:flex-row-reverse sm:px-6 border-t border-gray-100 flex-shrink-0">
                    <button type="button" id="modal-close-btn" class="inline-flex w-full justify-center rounded-lg bg-blue-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-blue-50 sm:ml-3 sm:w-auto transition-colors" data-i18n="closeBtn">Close</button>
                </div>
            </div>
        </div>
    </div>

    <template id="tmpl-privacy-zh">
        <h4 class="font-bold text-slate-800 mt-2 mb-2">1. æ¡æ¬¾æ¥å—</h4>
        <p>è®¿é—®å¹¶ä½¿ç”¨æœ¬ç½‘ç«™ ("4x25 Tools") ï¼Œå³è¡¨ç¤ºæ‚¨åŒæ„éµå®ˆä»¥ä¸‹æ¡æ¬¾ã€‚å¦‚æœæ‚¨ä¸åŒæ„è¿™äº›æ¡æ¬¾çš„ä»»ä½•éƒ¨åˆ†ï¼Œè¯·å‹¿ä½¿ç”¨æœ¬æœåŠ¡ã€‚</p>
        <h4 class="font-bold text-slate-800 mt-4 mb-2">2. å…è´£å£°æ˜ (æ— è´¢åŠ¡å»ºè®®)</h4>
        <p>æœ¬ç½‘ç«™æä¾›çš„è®¡ç®—ç»“æœã€å›¾è¡¨åŠä¿¡æ¯ä»…ä¾›<strong>æ•™è‚²å’Œå‚è€ƒç”¨é€”</strong>ã€‚å®ƒä»¬ä¸æ„æˆä»»ä½•å½¢å¼çš„è´¢åŠ¡ã€æŠ•èµ„ã€ç¨åŠ¡æˆ–æ³•å¾‹å»ºè®®ã€‚</p>
        <ul class="list-disc pl-5 mt-2 space-y-1">
            <li>æŠ•èµ„æ¶‰åŠé£é™©ï¼ŒåŒ…æ‹¬æœ¬é‡‘æŸå¤±çš„å¯èƒ½ã€‚</li>
            <li>è¿‡å¾€è¡¨ç°ä¸ä»£è¡¨æœªæ¥ç»“æœã€‚</li>
            <li>åœ¨åšå‡ºä»»ä½•æŠ•èµ„å†³å®šå‰ï¼Œè¯·å’¨è¯¢åˆæ ¼çš„ä¸“ä¸šç†è´¢é¡¾é—®ã€‚</li>
        </ul>
        <p class="mt-2">æœ¬ç½‘ç«™ä¸å¯¹å› ä½¿ç”¨æœ¬å·¥å…·è€Œäº§ç”Ÿçš„ä»»ä½•ç›´æ¥æˆ–é—´æ¥æŸå¤±è´Ÿè´£ã€‚æ‚¨éœ€è‡ªè¡Œæ‰¿æ‹…ä½¿ç”¨æœ¬æœåŠ¡çš„é£é™©ã€‚</p>
        <h4 class="font-bold text-slate-800 mt-4 mb-2">3. éšç§æ”¿ç­– (æ•°æ®æœ¬åœ°åŒ–)</h4>
        <p>æˆ‘ä»¬é«˜åº¦é‡è§†æ‚¨çš„éšç§ã€‚æœ¬å·¥å…·é‡‡ç”¨<strong>å®¢æˆ·ç«¯è®¡ç®— (Client-Side)</strong> æ¶æ„ï¼š</p>
        <ul class="list-disc pl-5 mt-2 space-y-1">
            <li><strong>æ‚¨çš„è´¢åŠ¡æ•°æ®ä¸ç¦»çº¿:</strong> æ‚¨è¾“å…¥çš„èµ„äº§é‡‘é¢ã€æ”¶ç›Šç‡ç­‰æ•æ„Ÿæ•°æ®å®Œå…¨åœ¨æ‚¨çš„æµè§ˆå™¨æœ¬åœ°å¤„ç†ï¼Œç»ä¸ä¼šå‘é€è‡³æˆ‘ä»¬çš„æœåŠ¡å™¨ã€‚</li>
            <li><strong>æ•°æ®æŒä¹…åŒ–:</strong> ä¸ºäº†æå‡ä½“éªŒï¼Œæˆ‘ä»¬ä¼šå°†æ‚¨çš„è¾“å…¥æ•°æ®å­˜å‚¨åœ¨æ‚¨æµè§ˆå™¨çš„ <strong>LocalStorage</strong> ä¸­ï¼Œä»¥ä¾¿æ‚¨ä¸‹æ¬¡è®¿é—®æ—¶æ— éœ€é‡æ–°è¾“å…¥ã€‚æ‚¨å¯ä»¥éšæ—¶æ¸…é™¤æµè§ˆå™¨ç¼“å­˜æ¥åˆ é™¤è¿™äº›æ•°æ®ã€‚</li>
            <li><strong>Cookie ä¸ç»Ÿè®¡:</strong> æˆ‘ä»¬å¯èƒ½ä¼šä½¿ç”¨ç¬¬ä¸‰æ–¹æœåŠ¡ï¼ˆå¦‚ Google Analyticsï¼‰æ”¶é›†åŒ¿åçš„è®¿é—®ç»Ÿè®¡æ•°æ®ï¼ˆå¦‚é¡µé¢æµè§ˆé‡ã€è®¾å¤‡ç±»å‹ï¼‰ï¼Œä»¥ä¼˜åŒ–ç”¨æˆ·ä½“éªŒã€‚è¿™äº›æœåŠ¡å¯èƒ½ä¼šåœ¨æ‚¨çš„è®¾å¤‡ä¸Šå­˜å‚¨ Cookieã€‚</li>
        </ul>
        <h4 class="font-bold text-slate-800 mt-4 mb-2">4. æ¨¡å‹å±€é™æ€§ (è´¹ç”¨ä¸é€šèƒ€)</h4>
        <p>è¯·æ³¨æ„ï¼Œæœ¬å·¥å…·ç”Ÿæˆçš„æ¨¡æ‹Ÿæ¨æ¼”ä¸å†å¹³è¡¡å»ºè®®å‡ä¸º<strong>ç†è®ºæ•°å­¦æ¨¡å‹</strong>ï¼Œå­˜åœ¨ä»¥ä¸‹å±€é™æ€§ï¼š</p>
        <ul class="list-disc pl-5 mt-2 space-y-1">
            <li><strong>æœªè€ƒè™‘é€šèƒ€/é€šç¼©:</strong> æ‰€æœ‰é‡‘é¢å‡ä¸ºåä¹‰ä»·å€¼ï¼Œæœªæ ¹æ®é€šè´§è†¨èƒ€ç‡æˆ–è´­ä¹°åŠ›å˜åŒ–è¿›è¡Œè°ƒæ•´ã€‚</li>
            <li><strong>å¿½ç•¥äº¤æ˜“æ‘©æ“¦:</strong> è®¡ç®—å‡è®¾äº¤æ˜“æ— æŸè€—ï¼Œæœªæ‰£é™¤äº¤æ˜“æ‰‹ç»­è´¹ã€ä½£é‡‘ã€å°èŠ±ç¨ã€æ»‘ç‚¹ä»¥åŠèµ„æœ¬åˆ©å¾—ç¨ç­‰å®é™…æˆæœ¬ã€‚</li>
        </ul>
        <h4 class="font-bold text-slate-800 mt-4 mb-2">5. æœåŠ¡å˜æ›´</h4>
        <p>æˆ‘ä»¬ä¿ç•™éšæ—¶ä¿®æ”¹æˆ–ç»ˆæ­¢æœåŠ¡ã€æ›´æ–°æœ¬æ¡æ¬¾çš„æƒåˆ©ï¼Œæ•ä¸å¦è¡Œé€šçŸ¥ã€‚</p>
        <p class="mt-6 text-xs text-slate-400 border-t pt-4">æœ€åæ›´æ–°æ—¥æœŸ: 2026å¹´1æœˆ7æ—¥</p>
    </template>

    <template id="tmpl-privacy-en">
        <h4 class="font-bold text-slate-800 mt-2 mb-2">1. Acceptance of Terms</h4>
        <p>By accessing and using this website ("4x25 Tools"), you agree to be bound by these terms. If you do not agree, please do not use this service.</p>
        <h4 class="font-bold text-slate-800 mt-4 mb-2">2. Disclaimer (No Financial Advice)</h4>
        <p>The calculations, charts, and information provided on this website are for <strong>educational and informational purposes only</strong>. They do not constitute financial, investment, tax, or legal advice.</p>
        <ul class="list-disc pl-5 mt-2 space-y-1">
            <li>Investments involve risk, including the possible loss of principal.</li>
            <li>Past performance is not indicative of future results.</li>
            <li>Consult with a qualified financial advisor before making any investment decisions.</li>
        </ul>
        <p class="mt-2">We accept no liability for any loss or damage resulting from the use of this tool. You use this service entirely at your own risk.</p>
        <h4 class="font-bold text-slate-800 mt-4 mb-2">3. Privacy Policy (Data Localization)</h4>
        <p>We respect your privacy. This tool operates on a <strong>Client-Side</strong> architecture:</p>
        <ul class="list-disc pl-5 mt-2 space-y-1">
            <li><strong>Your Financial Data Stays Local:</strong> The asset values and rates you input are processed entirely within your browser. This data is never transmitted to our servers.</li>
            <li><strong>Data Persistence:</strong> To improve your experience, we save your input data in your browser's <strong>LocalStorage</strong> so you don't have to re-enter it next time. You can clear your browser cache to remove this data.</li>
            <li><strong>Cookies & Analytics:</strong> We may use third-party services (like Google Analytics) to collect anonymous usage statistics (e.g., page views, device type) to improve the user experience. These services may store cookies on your device.</li>
        </ul>
        <h4 class="font-bold text-slate-800 mt-4 mb-2">4. Model Limitations (Fees & Inflation)</h4>
        <p>Please note that the simulations and rebalancing suggestions are <strong>theoretical mathematical models</strong> with the following limitations:</p>
        <ul class="list-disc pl-5 mt-2 space-y-1">
            <li><strong>Inflation/Deflation Excluded:</strong> All figures are nominal values and are not adjusted for inflation or changes in purchasing power.</li>
            <li><strong>Transaction Costs Ignored:</strong> Calculations assume zero friction and do not account for trading fees, commissions, slippage, or taxes (e.g., capital gains tax).</li>
        </ul>
        <h4 class="font-bold text-slate-800 mt-4 mb-2">5. Changes to Service</h4>
        <p>We reserve the right to modify or discontinue the service, or update these terms at any time without prior notice.</p>
        <p class="mt-6 text-xs text-slate-400 border-t pt-4">Last Updated: January 7, 2026</p>
    </template>

    <script id="i18n-data" type="application/json">
    {
        "zh": {
            "currencyCode": "CNY",
            "subtitle": "4x25 æ°¸ä¹…æŠ•èµ„ç»„åˆç­–ç•¥å·¥å…· Â· FIRE è´¢åŠ¡è‡ªç”±è®¡ç®—å™¨", 
            "thresholdLabel": "é˜ˆå€¼: Â±",
            "inputTitle": "ğŸ’° å½“å‰æŒä»“è¾“å…¥",
            "totalValue": "æ€»èµ„äº§ä»·å€¼",
            "rebalanceTitle": "ğŸ”„ å†å¹³è¡¡å»ºè®®",
            "targetLabel": "ç›®æ ‡: 25%",
            "colAsset": "èµ„äº§",
            "colCurrent": "å½“å‰å æ¯”",
            "colTarget": "ç›®æ ‡é‡‘é¢",
            "colAction": "æ“ä½œ",
            "fireTitle": "FIRE 4% æ³•åˆ™é¢„è§ˆ",
            "diogenesTitle": "ç¬¬æ¬§æ ¹å°¼æ¨¡å¼ (Diogenes)",
            "fireYear": "å¯æ”¯æŒå¹´æ”¯å‡º",
            "fireMonth": "å¯æ”¯æŒæœˆæ”¯å‡º",
            "fireExpenseLabel": "é¢„æœŸå¹´æ”¯å‡ºç›®æ ‡",
            "fireProgress": "FIRE è¿›åº¦",
            "fireTargetLabel": "ç›®æ ‡èµ„äº§ (25x)",
            "fireSetGoal": "è¯·è®¾å®šæ”¯å‡º",
            "stocks": "è‚¡ç¥¨ (Stocks)",
            "bonds": "é•¿æœŸå›½å€º (Bonds)",
            "cash": "ç°é‡‘/çŸ­å€º (Cash)",
            "gold": "é»„é‡‘ (Gold)",
            "buy": "ä¹°å…¥",
            "sell": "å–å‡º",
            "hold": "ä¿æŒ", 
            "statusEmptyTitle": "è¯·è¾“å…¥æŒä»“é‡‘é¢",
            "statusEmptyDesc": "è¯·åœ¨å·¦ä¾§è¾“å…¥å„é¡¹èµ„äº§çš„å½“å‰ä»·å€¼ä»¥å¼€å§‹è®¡ç®—ã€‚æœªå¡«å†™çš„é¡¹ç›®å°†é»˜è®¤ä¸º 0ã€‚",
            "statusHealthyTitle": "æŠ•èµ„ç»„åˆå¤„äºå¥åº·åŒºé—´",
            "statusHealthyDesc": "æ‰€æœ‰èµ„äº§å‡åœ¨ç›®æ ‡åŒºé—´å†…ï¼Œæ— éœ€æ“ä½œã€‚",
            "statusActionTitle": "å»ºè®®è¿›è¡Œå†å¹³è¡¡",
            "statusActionDesc": "æ£€æµ‹åˆ°æœ‰èµ„äº§åç¦»ç›®æ ‡é…ç½®è¶…è¿‡ {threshold}% (å³ <{min}% æˆ– >{max}%)ã€‚",
            "statusActionNote": "è¯´æ˜ï¼šé»˜è®¤ç­–ç•¥ä¸ºå°†æ‰€æœ‰èµ„äº§å›å½’è‡³å„ 25%ã€‚",
            "faqTitle": "å¸¸è§é—®é¢˜ (FAQ)",
            "faqData": [
                { 
                    "question": "ä¸ºä»€ä¹ˆå« 4x25?", 
                    "answer": [ "è¿™æ˜¯ä¸€ä¸ªåŒå…³å«ä¹‰ï¼š", "1. æ°¸ä¹…æŠ•èµ„ç»„åˆï¼š4ç§èµ„äº§ï¼Œå„å  25%ã€‚", "2. FIRE è¿åŠ¨ï¼š4% æ³•åˆ™ï¼Œæ„å‘³ç€ä½ éœ€è¦å­˜å¤Ÿå¹´æ”¯å‡ºçš„ 25 å€ã€‚" ]
                },
                {
                    "question": "ä»€ä¹ˆæ˜¯ 4% æ³•åˆ™?",
                    "answer": [
                        "æºè‡ªä¸‰ä¸€å­¦é™¢ç ”ç©¶ (Trinity Study)ã€‚",
                        "æ ¸å¿ƒè§‚ç‚¹ï¼šè‹¥æ¯å¹´æå–åˆå§‹èµ„é‡‘çš„ 4% ä½œä¸ºç”Ÿæ´»è´¹ï¼ˆå¹¶éšé€šèƒ€è°ƒæ•´ï¼‰ï¼Œèµ„é‡‘å¤§æ¦‚ç‡èƒ½ç»´æŒ 30 å¹´ä»¥ä¸Šã€‚",
                        "è¿™æ„å‘³ç€ï¼šå½“æ€»èµ„äº§ = å¹´æ”¯å‡º Ã— 25 æ—¶ï¼Œç†è®ºä¸Šå·²è¾¾æˆè´¢åŠ¡è‡ªç”± (FIRE)ã€‚"
                    ]
                },
                { 
                    "question": "ä»€ä¹ˆæ˜¯æ°¸ä¹…æŠ•èµ„ç»„åˆï¼Ÿ", 
                    "answer": [
                        "æ°¸ä¹…æŠ•èµ„ç»„åˆ (Permanent Portfolio) æ˜¯ç”±å“ˆåˆ©Â·å¸ƒæœ— (Harry Browne) æå‡ºçš„æŠ•èµ„ç­–ç•¥ï¼Œæ—¨åœ¨æ— è®ºç»æµçŠ¶å†µå¦‚ä½•ï¼ˆç¹è£ã€é€šç¼©ã€é€šèƒ€æˆ–æ»èƒ€ï¼‰ï¼Œéƒ½èƒ½ä¿æŠ¤å¹¶å¢å€¼ä½ çš„è´¢å¯Œã€‚",
                        "å…¶æ ¸å¿ƒç†å¿µæå…¶ç®€å•ï¼šå°†èµ„äº§å¹³åˆ†ä¸ºå››ç­‰ä»½ï¼ˆå„25%ï¼‰ï¼šè‚¡ç¥¨ï¼ˆåº”å¯¹ç¹è£ï¼‰ã€é•¿æœŸå›½å€ºï¼ˆåº”å¯¹é€šç¼©ï¼‰ã€ç°é‡‘/çŸ­å€ºï¼ˆåº”å¯¹è¡°é€€/ç´§ç¼©ï¼‰ã€é»„é‡‘ï¼ˆåº”å¯¹é€šèƒ€ï¼‰ã€‚",
                        "ä½ åªéœ€è¦å®šæœŸæ£€æŸ¥ï¼Œå¦‚æœæŸé¡¹èµ„äº§å æ¯”åç¦» 25% å¤ªå¤šï¼ˆä¾‹å¦‚è¶…è¿‡è®¾å®šçš„é˜ˆå€¼ï¼‰ï¼Œå°±è¿›è¡Œâ€œå†å¹³è¡¡â€ï¼šå–å‡ºæ¶¨å¾—å¤šçš„ï¼Œä¹°å…¥è·Œå¾—å¤šçš„ï¼Œä½¿å…¶å›åˆ° 25%ã€‚"
                    ]
                },
                {
                    "question": "è’™ç‰¹å¡æ´›æ¨¡æ‹Ÿæ˜¯å¦‚ä½•å·¥ä½œçš„ï¼Ÿ",
                    "answer": [ "æˆ‘ä»¬æ”¶é›†äº†æ°¸ä¹…æŠ•èµ„ç»„åˆåœ¨ç¾å›½å¸‚åœº 1976-2025 å¹´é—´å…± 50 å¹´çš„çœŸå®å†å²å›æŠ¥ç‡ã€‚", "æ¨¡æ‹Ÿå™¨ä¼šè¿›è¡Œ 1000 æ¬¡æ¨æ¼”ã€‚æ¯æ¬¡æ¨æ¼”ä¸­ï¼Œæœªæ¥çš„æ¯ä¸€å¹´éƒ½ä¼šéšæœºæŠ½å–è¿™ 50 å¹´ä¸­çš„æŸä¸€å¹´ä½œä¸ºå›æŠ¥ç‡ã€‚", "æœ€ç»ˆçš„å›¾è¡¨å±•ç¤ºäº†è¿™ 1000 ç§å¯èƒ½æ€§çš„åˆ†å¸ƒï¼šä¸­é—´çš„å®çº¿ä»£è¡¨ä¸­ä½æ•°ï¼ˆæœ€å¯èƒ½å‘ç”Ÿçš„æƒ…å†µï¼‰ï¼Œæµ…è‰²åŒºåŸŸä»£è¡¨ 80% çš„å¯èƒ½æ€§èŒƒå›´ï¼ˆä»è¾ƒå·®è¿æ°”åˆ°è¾ƒå¥½è¿æ°”ï¼‰ã€‚" ]
                },
                { 
                    "question": "å†å¹³è¡¡çš„é˜ˆå€¼è®¾ä¸ºå¤šå°‘æ¯”è¾ƒå¥½?", 
                    "answer": [ "å“ˆåˆ©Â·å¸ƒæœ—å»ºè®®ä½¿ç”¨ 15/35 é¢‘å¸¦ï¼Œå³å½“æŸé¡¹èµ„äº§è·Œç ´ 15% æˆ–æ¶¨è¶… 35% æ—¶è§¦å‘å†å¹³è¡¡ï¼ˆç›¸å½“äº Â±10% çš„é˜ˆå€¼ï¼‰ã€‚", "æœ¬è®¡ç®—å™¨é»˜è®¤è®¾ç½®ä¸º Â±10%ï¼Œä½ å¯ä»¥æ ¹æ®è‡ªå·±çš„é£é™©åå¥½åœ¨é¡¶éƒ¨è°ƒæ•´ã€‚" ]
                }
            ],
            "privacy": "æ¡æ¬¾ä¸éšç§",
            "privacyTitle": "ä½¿ç”¨æ¡æ¬¾ä¸éšç§æ”¿ç­–",
            "closeBtn": "æˆ‘å·²äº†è§£",
            "projTitle": "è’™ç‰¹å¡æ´›è´¢å¯Œæ¨¡æ‹Ÿ",
            "modeSaving": "å®šæŠ•æ¨¡å¼",
            "modeSpending": "æ¶ˆè´¹æ¨¡å¼",
            "projCurrent": "å½“å‰æ€»èµ„äº§",
            "projYears": "æ¨æ¼”å¹´é™ (1-50)",
            "projContribution": "æ¯å¹´å®šæŠ•é‡‘é¢",
            "projExpense": "æ¯å¹´è®¡åˆ’å¼€é”€",
            "projChartTitle": "è´¢å¯Œé¢„æµ‹åŒºé—´",
            "projMedian": "ä¸­ä½æ•°ç»“æœ",
            "btnSimulate": "é‡æ–°æ¨¡æ‹Ÿ",
            "monteCarloTitle": "åŸºäº 1976-2025 ç¾å›½å¸‚åœºæ•°æ®:",
            "monteCarloDesc": "é€šè¿‡éšæœºæŠ½å–è¿‡å» 50 å¹´çš„ç¾å›½å¸‚åœºæ°¸ä¹…ç»„åˆå†å²å›æŠ¥ç‡ï¼Œè¿›è¡Œ 1,000 æ¬¡æœªæ¥è·¯å¾„æ¨¡æ‹Ÿï¼Œå±•ç¤ºè´¢å¯Œå¢é•¿çš„æ¦‚ç‡åˆ†å¸ƒåŒºé—´ã€‚",
            "continuousCompoundingTitle": "è¿ç»­å¤åˆ©æ¨¡å‹ (Continuous Compounding)",
            "continuousCompoundingDesc": "ä½¿ç”¨æ¬§æ‹‰æ•° (e) æ¨¡æ‹Ÿè¿ç»­çš„ç°é‡‘æµï¼ˆå³å‡è®¾å®šæŠ•/æ¶ˆè´¹æ˜¯æ¯æ—¥å‡åŒ€å‘ç”Ÿçš„ï¼‰ï¼Œè€Œéä¼ ç»Ÿçš„å¹´æœ«ä¸€æ¬¡æ€§ç»“ç®—ï¼Œç»“æœæ›´è´´è¿‘çœŸå®æƒ…å†µã€‚",
            "rebalanceNote": "æ³¨ï¼šå»ºè®®æ“ä½œé‡‘é¢ä¸ºç†è®ºå€¼ï¼Œæœªè€ƒè™‘äº¤æ˜“æ‰‹ç»­è´¹åŠç¨åŠ¡ï¼ˆå¦‚èµ„æœ¬åˆ©å¾—ç¨ï¼‰å½±å“ã€‚",
            "seasonTitle": "ç»æµå››å­£ç½—ç›˜",
            "seasonProsperity": "ç¹è£æœŸ",
            "seasonStocks": "è‚¡ç¥¨ (Stocks)",
            "seasonDeflation": "é€šç¼©æœŸ",
            "seasonBonds": "é•¿å€º (Bonds)",
            "seasonRecession": "è¡°é€€/ç´§ç¼©",
            "seasonCash": "ç°é‡‘ (Cash)",
            "seasonInflation": "é€šèƒ€æœŸ",
            "seasonGold": "é»„é‡‘ (Gold)",
            "rule72Title": "72æ³•åˆ™",
            "rule72Desc": "åŸºäº 1976-2025 ç¾å›½å¸‚åœºæ•°æ®ï¼ˆå¹´åŒ– {rate}%ï¼‰ï¼Œæ‚¨çš„èµ„äº§çº¦æ¯ {years} å¹´ç¿»ä¸€ç•ªã€‚",
            "errUnexpected": "å‘ç”Ÿæ„å¤–é”™è¯¯ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•ã€‚"
        },
        "en": {
            "currencyCode": "USD",
            "subtitle": "4x25 Strategy & FIRE Tool Â· Permanent Portfolio Calculator",
            "thresholdLabel": "Threshold: Â±",
            "inputTitle": "ğŸ’° Current Holdings",
            "totalValue": "Total Value",
            "rebalanceTitle": "ğŸ”„ Rebalancing Suggestions",
            "targetLabel": "Target: 25%",
            "colAsset": "Asset",
            "colCurrent": "Current %",
            "colTarget": "Target Value",
            "colAction": "Action",
            "fireTitle": "FIRE 4% Rule Preview",
            "diogenesTitle": "Diogenes Mode",
            "fireYear": "Safe Annual Withdrawal",
            "fireMonth": "Safe Monthly Withdrawal",
            "fireExpenseLabel": "Annual Expense Goal",
            "fireProgress": "FIRE Progress",
            "fireTargetLabel": "Target (25x)",
            "fireSetGoal": "Set Expense",
            "stocks": "Stocks",
            "bonds": "Long-Term Bonds",
            "cash": "Cash / T-Bills",
            "gold": "Gold",
            "buy": "Buy",
            "sell": "Sell",
            "hold": "Hold",
            "statusEmptyTitle": "Enter Your Holdings",
            "statusEmptyDesc": "Please input the current value of your assets. Empty fields will be treated as 0.",
            "statusHealthyTitle": "Portfolio is Healthy",
            "statusHealthyDesc": "All assets are within the target allocation range.",
            "statusActionTitle": "Rebalancing Recommended",
            "statusActionDesc": "Assets detected deviating by more than {threshold}% (i.e., <{min}% or >{max}%).",
            "statusActionNote": "Note: Defaults to rebalancing to 25% each.",
            "faqTitle": "Frequently Asked Questions (FAQ)",
            "faqData": [
                { 
                    "question": "Why 4x25?", 
                    "answer": [ "It's a double meaning:", "1. Permanent Portfolio: 4 assets at 25% each.", "2. FIRE Movement: The 4% Rule implies saving 25 times your annual expenses." ]
                },
                {
                    "question": "What is the 4% Rule?",
                    "answer": [
                        "Derived from the Trinity Study.",
                        "It suggests that if you withdraw 4% of your portfolio annually (adjusted for inflation), your money has a high probability of lasting 30+ years.",
                        "This implies: You reach FIRE when Total Assets = 25 Ã— Annual Expenses."
                    ]
                },
                { 
                    "question": "What is the Permanent Portfolio?", 
                    "answer": [
                        "The Permanent Portfolio is an investment strategy invented by Harry Browne, designed to preserve and grow your wealth under any condition.",
                        "The core concept is simple: divide your assets equally into four parts (25% each): Stocks (Prosperity), Long-Term Bonds (Deflation), Cash (Recession), and Gold (Inflation).",
                        "You simply check it regularly. If an asset deviates too far from 25% (beyond your set threshold), you \"rebalance\": sell the winners and buy the losers to get back to 25%."
                    ]
                },
                {
                    "question": "How does the Monte Carlo simulation work?",
                    "answer": [ "We use historical return data from the US Market (1976-2025) for the Permanent Portfolio.", "The simulator runs 1,000 scenarios. In each scenario, the return for each future year is randomly selected from one of those 50 historical years.", "The chart shows the distribution of these 1,000 outcomes: the solid line is the median (most likely), and the shaded area covers 80% of possibilities (from bad luck to good luck)." ]
                },
                { 
                    "question": "What is the best rebalancing threshold?", 
                    "answer": [ "Harry Browne recommended using a 15/35 band. This means you rebalance only when an asset drops below 15% or rises above 35% (which equals a Â±10% threshold).", "This calculator defaults to Â±10%, but you can adjust it at the top based on your risk tolerance." ]
                }
            ],
            "privacy": "Terms & Privacy",
            "privacyTitle": "Terms of Service & Privacy Policy",
            "closeBtn": "I Understand",
            "projTitle": "Monte Carlo Simulation",
            "modeSaving": "Saving",
            "modeSpending": "Spending",
            "projCurrent": "Current Assets",
            "projYears": "Years (1-50)",
            "projContribution": "Annual Contribution",
            "projExpense": "Annual Expense",
            "projChartTitle": "Wealth Projection Range",
            "projMedian": "Median Outcome",
            "btnSimulate": "Resimulate",
            "monteCarloTitle": "Based on US Market Data (1976-2025):",
            "monteCarloDesc": "Simulating 1,000 possible futures by randomly sampling from 50 years of historical US Permanent Portfolio returns.",
            "continuousCompoundingTitle": "Continuous Compounding Model",
            "continuousCompoundingDesc": "Using Euler's number (e) to simulate continuous cash flows (daily contributions/spending) rather than lump-sum year-end transactions.",
            "rebalanceNote": "Note: Suggested actions are theoretical and do not account for transaction fees or tax implications.",
            "seasonTitle": "Economic Seasons",
            "seasonProsperity": "Prosperity",
            "seasonStocks": "Stocks",
            "seasonDeflation": "Deflation",
            "seasonBonds": "Bonds",
            "seasonRecession": "Recession",
            "seasonCash": "Cash",
            "seasonInflation": "Inflation",
            "seasonGold": "Gold",
            "rule72Title": "Rule of 72",
            "rule72Desc": "Based on US Market (1976-2025) average return of {rate}%, your assets double every ~{years} years.",
            "errUnexpected": "An unexpected error occurred. Please refresh the page."
        }
    }
    </script>

    <script>
        class EventEmitter {
            constructor() { this.events = {}; }
            on(event, listener) {
                if (!this.events[event]) this.events[event] = [];
                this.events[event].push(listener);
            }
            off(event, listener) {
                if (!this.events[event]) return;
                this.events[event] = this.events[event].filter(l => l !== listener);
            }
            emit(event, data) {
                if (this.events[event]) this.events[event].forEach(listener => listener(data));
            }
        }

        const App = (() => {
            const Config = {
                STORAGE_KEY: '4x25_data_v2', 
                DATA_VERSION: 3, 
                TARGET_PERCENT: 25,
                MIN_THRESHOLD: 5,
                MAX_THRESHOLD: 15,
                ASSET_MAX_DIGITS: 8,
                PROJ_MAX_DIGITS: 12,
                TIMING: { 
                    CALC_DEBOUNCE: 150, 
                    PROJ_DEBOUNCE: 600, 
                    SAVE_DEBOUNCE: 1000,
                    ANIMATION_DURATION: 800,
                    TOAST_DISPLAY: 4000,
                    TOAST_FADEOUT: 300
                },
                FORMAT: { SCIENTIFIC_THRESHOLD: 1e15, COMPACT_THRESHOLD: 1000000, MIN_LENGTH_FOR_TRIM: 2 },
                ASSETS: [
                    { key: 'stocks', color: '#3B82F6', tailwindColor: 'bg-blue-500' },
                    { key: 'bonds', color: '#8B5CF6', tailwindColor: 'bg-violet-500' },
                    { key: 'cash', color: '#10B981', tailwindColor: 'bg-emerald-500' },
                    { key: 'gold', color: '#F59E0B', tailwindColor: 'bg-amber-500' }
                ],
                HISTORICAL_RETURNS: [
                    11.22, 6.43, 12.78, 39.77, 13.65, -5.34, 23.27, 3.46, 2.22, 20.47,
                    17.64, 7.42, 4.39, 12.90, 1.11, 11.72, 3.57, 12.00, -1.37, 18.11,
                    5.08, 7.19, 10.09, 5.17, 2.40, -0.52, 5.85, 13.32, 8.91, 10.94,
                    12.69, 0.87, 7.85, 13.92, 11.11, 6.41, -2.08, 9.40, -3.06, 5.54,
                    10.97, -1.76, 16.17, 16.10, 4.21, -12.53, 11.55, 11.90, 22.29, 7.50
                ]
            };

            let Translations = {};
            try {
                Translations = JSON.parse(document.getElementById('i18n-data').textContent);
            } catch (e) {
                console.error("Failed to parse i18n data", e);
                Translations = { en: {}, zh: {} }; 
            }

            const Utils = {
                formatterCache: new Map(),
                getFormatter: (locale, options) => {
                    const key = `${locale}|${options.style}|${options.currency}|${options.notation || 'std'}|${options.maximumFractionDigits || 0}`;
                    let formatter = Utils.formatterCache.get(key);
                    if (!formatter) {
                        formatter = new Intl.NumberFormat(locale, options);
                        Utils.formatterCache.set(key, formatter);
                    }
                    return formatter;
                },
                debounce: (func, wait) => {
                    let timeout;
                    return function(...args) {
                        const context = this;
                        clearTimeout(timeout);
                        timeout = setTimeout(() => func.apply(context, args), wait);
                    };
                },
                sanitizeInput: (value, maxLength = Config.ASSET_MAX_DIGITS) => {
                    let clean = value.replace(/[^\d]/g, '');
                    if (clean === '') return '';
                    clean = clean.replace(/^0+(?=\d)/, '');
                    if (clean.length > maxLength) clean = clean.slice(0, maxLength);
                    return clean;
                },
                sanitizeInteger: (value, max) => {
                    let clean = value.replace(/\D/g, ''); 
                    if (clean === '') return '';
                    clean = clean.replace(/^0+(?=\d)/, '');
                    if (parseInt(clean, 10) > max) return String(max);
                    return clean;
                },
                formatMoney: (num, lang, isCompact, includeCurrency = true) => {
                    const currencyCode = Translations[lang].currencyCode;
                    const locale = lang === 'zh' ? 'zh-CN' : 'en-US';
                    if (!Number.isFinite(num)) return '---';
                    
                    if (Math.abs(num) > Config.FORMAT.SCIENTIFIC_THRESHOLD) {
                        return Utils.getFormatter(locale, { 
                            style: includeCurrency ? 'currency' : 'decimal', 
                            currency: currencyCode, 
                            notation: 'scientific', 
                            maximumFractionDigits: 2 
                        }).format(num);
                    }
                    const useCompact = isCompact && Math.abs(num) > Config.FORMAT.COMPACT_THRESHOLD; 
                    return Utils.getFormatter(locale, { 
                        style: includeCurrency ? 'currency' : 'decimal', 
                        currency: currencyCode, 
                        notation: useCompact ? 'compact' : 'standard', 
                        maximumFractionDigits: useCompact ? 2 : 0 
                    }).format(num);
                },
                animateTo: (el, endValue, lang, isCompact = false, includeCurrency = true) => {
                    if (!el) return;
                    const startValue = parseFloat(el.dataset.currentValue || '0');
                    if (startValue === endValue) { el.textContent = Utils.formatMoney(endValue, lang, isCompact, includeCurrency); return; }
                    
                    const mediaQuery = window.matchMedia('(prefers-reduced-motion: reduce)');
                    if (mediaQuery.matches) {
                        el.textContent = Utils.formatMoney(endValue, lang, isCompact, includeCurrency);
                        el.dataset.currentValue = endValue;
                        return;
                    }

                    if (el.animationFrame) cancelAnimationFrame(el.animationFrame);
                    const duration = Config.TIMING.ANIMATION_DURATION;
                    const startTime = performance.now();
                    
                    const step = (currentTime) => {
                        const elapsed = currentTime - startTime;
                        const progress = Math.min(elapsed / duration, 1);
                        const ease = progress === 1 ? 1 : 1 - Math.pow(2, -10 * progress);
                        const current = startValue + (endValue - startValue) * ease;
                        
                        if (progress < 1) { 
                            el.textContent = Math.floor(current).toLocaleString('en-US'); 
                            el.animationFrame = requestAnimationFrame(step); 
                        } else { 
                            el.textContent = Utils.formatMoney(endValue, lang, isCompact, includeCurrency); 
                            el.dataset.currentValue = endValue; 
                        }
                    };
                    el.animationFrame = requestAnimationFrame(step);
                },
                setText: (el, text) => { if (el && el.textContent !== text) el.textContent = text; },
                setClass: (el, cls) => { if (el && el.className !== cls) el.className = cls; },
                createEl: (tag, cls, text) => {
                    const el = document.createElement(tag);
                    if (cls) el.className = cls;
                    if (text) el.textContent = text;
                    return el;
                }
            };

            const State = new EventEmitter();
            Object.assign(State, {
                lang: 'en',
                threshold: 10,
                holdings: { stocks: 0, bonds: 0, cash: 0, gold: 0 },
                projection: { mode: 'saving', principal: '', years: 10, flow: '' },
                fireExpense: '', 
                debouncedPortfolioCalc: null, 
                debouncedProjCalc: null,      
                debouncedSave: null,
                shouldSyncPrincipal: false, 
                historicalStats: null,
                init() { 
                    this.load(); 
                    this.debouncedPortfolioCalc = Utils.debounce(() => { this.performPortfolioCalculation(); }, Config.TIMING.CALC_DEBOUNCE); 
                    this.debouncedProjCalc = Utils.debounce(() => { this.performProjectionCalculation(); }, Config.TIMING.PROJ_DEBOUNCE);
                    this.debouncedSave = Utils.debounce(() => { this.save(); }, Config.TIMING.SAVE_DEBOUNCE);
                },
                calculateHistoricalStats() {
                    const returns = Config.HISTORICAL_RETURNS;
                    const totalGrowth = returns.reduce((acc, val) => acc * (1 + val / 100), 1);
                    const n = returns.length;
                    const cagr = (Math.pow(totalGrowth, 1 / n) - 1) * 100;
                    const doublingTime = 72 / cagr;
                    this.historicalStats = { cagr, doublingTime };
                    if (UI && UI.renderRule72) UI.renderRule72();
                },
                validate() {
                    const { threshold, holdings } = this;
                    if (typeof threshold !== 'number' || threshold < Config.MIN_THRESHOLD || threshold > Config.MAX_THRESHOLD) return false;
                    if (!holdings || typeof holdings !== 'object') return false;
                    return true;
                },
                save() {
                    if (!this.validate()) return;
                    try {
                        const data = {
                            version: Config.DATA_VERSION, 
                            lang: this.lang,
                            threshold: this.threshold,
                            holdings: this.holdings,
                            projection: this.projection,
                            fireExpense: this.fireExpense
                        };
                        localStorage.setItem(Config.STORAGE_KEY, JSON.stringify(data));
                    } catch (e) { 
                        if (e.name === 'QuotaExceededError' || e.name === 'NS_ERROR_DOM_QUOTA_REACHED') {
                            console.warn('LocalStorage quota exceeded. Auto-save disabled.');
                        } else {
                            console.warn('LocalStorage save failed:', e);
                        }
                    }
                },
                load() {
                    try {
                        const raw = localStorage.getItem(Config.STORAGE_KEY);
                        if (raw) {
                            let data = JSON.parse(raw);
                            if (!data.version || data.version < Config.DATA_VERSION) { data = this.migrate(data); }
                            if (data.lang) this.lang = data.lang;
                            if (data.threshold) this.threshold = data.threshold;
                            if (data.holdings) this.holdings = { ...this.holdings, ...data.holdings };
                            if (data.projection) this.projection = { ...this.projection, ...data.projection };
                            if (data.fireExpense) this.fireExpense = data.fireExpense;
                        } else {
                            const browserLang = navigator.language || navigator.userLanguage; 
                            if (browserLang && (browserLang.toLowerCase().startsWith('zh'))) { this.lang = 'zh'; } else { this.lang = 'en'; }
                        }
                    } catch (e) { 
                        const browserLang = navigator.language || navigator.userLanguage; 
                        if (browserLang && (browserLang.toLowerCase().startsWith('zh'))) { this.lang = 'zh'; }
                    }
                },
                migrate(oldData) {
                    const newData = { ...oldData };
                    if (!newData.version) {
                        if (typeof newData.fireExpense === 'undefined') newData.fireExpense = ''; 
                        newData.version = 3;
                    }
                    return newData;
                },
                setLang(l) { this.lang = l; this.emit('langChanged', l); this.debouncedSave(); },
                setThreshold(t) { 
                    if (t >= Config.MIN_THRESHOLD && t <= Config.MAX_THRESHOLD) { 
                        this.threshold = t; 
                        this.emit('thresholdChanged', t);
                        this.triggerCalc(); 
                    } 
                },
                updateHolding(key, valueStr) { 
                    const val = parseInt(valueStr.replace(/[^\d]/g, ''), 10); 
                    this.holdings[key] = isNaN(val) ? 0 : val; 
                    this.shouldSyncPrincipal = true; 
                    this.triggerCalc(); 
                },
                setProjMode(mode) { this.projection.mode = mode; this.emit('projModeChanged', mode); this.triggerCalc(); },
                triggerCalc() { 
                    if (this.debouncedPortfolioCalc) this.debouncedPortfolioCalc(); 
                    if (this.debouncedProjCalc) this.debouncedProjCalc();
                    if (this.debouncedSave) this.debouncedSave(); 
                },
                forceResimulate() {
                    this.performProjectionCalculation();
                },
                performPortfolioCalculation() {
                    const results = Logic.calculatePortfolio(this.holdings, this.threshold);
                    this.emit('calculationDone', results);
                    if (this.shouldSyncPrincipal) {
                        this.projection.principal = String(results.total);
                        this.emit('principalSynced', results.total);
                        this.shouldSyncPrincipal = false;
                    }
                },
                performProjectionCalculation() {
                    const projResults = Logic.runMonteCarlo(this.projection.principal, this.projection.years, this.projection.flow, this.projection.mode);
                    this.emit('projectionDone', projResults);
                }
            });

            const Logic = {
                calculatePortfolio: (holdings, threshold) => {
                    const total = Object.values(holdings).reduce((a, b) => a + b, 0);
                    const targetVal = total / 4; 
                    const assetKeys = Config.ASSETS.map(a => a.key);
                    let globalBreach = false;
                    const assetsData = assetKeys.map((key) => {
                        const value = holdings[key];
                        const target = targetVal; 
                        const percent = total === 0 ? 0 : (value / total) * 100;
                        const diff = target - value;
                        const isBreached = total > 0 && (percent > (Config.TARGET_PERCENT + threshold) || percent < (Config.TARGET_PERCENT - threshold));
                        if (isBreached) globalBreach = true;
                        return { key, value, target, percent, diff, isBreached };
                    });
                    return { total, assetsData, globalBreach };
                },
                runMonteCarlo: (principalStr, yearsStr, flowStr, mode) => {
                    const principal = parseFloat(String(principalStr).replace(/[^\d]/g, '')) || 0;
                    let years = parseFloat(yearsStr) || 0;
                    if (!Number.isFinite(years)) years = 0; if (years > 50) years = 50; 
                    let annualFlow = parseFloat(String(flowStr).replace(/[^\d]/g, '')) || 0;
                    if (mode === 'spending') { annualFlow = -annualFlow; }

                    const SIMULATIONS = 1000;
                    const history = Config.HISTORICAL_RETURNS;
                    const historyLen = history.length;
                    
                    const allPaths = new Array(SIMULATIONS);
                    
                    for (let s = 0; s < SIMULATIONS; s++) {
                        const path = new Float64Array(years + 1);
                        path[0] = principal;
                        let currentBalance = principal;
                        
                        for (let y = 1; y <= years; y++) {
                            const randomReturn = history[(Math.random() * historyLen) | 0];
                            const k = Math.log(1 + randomReturn / 100);
                            
                            if (Math.abs(k) < 1e-9) {
                                currentBalance = currentBalance + annualFlow;
                            } else {
                                const growthFactor = Math.exp(k);
                                currentBalance = currentBalance * growthFactor + (annualFlow / k) * (growthFactor - 1);
                            }
                            
                            if (currentBalance < 0) currentBalance = 0;
                            path[y] = currentBalance;
                        }
                        allPaths[s] = path;
                    }

                    const p10Arr = [], p50Arr = [], p90Arr = [];
                    const tempYearValues = new Float64Array(SIMULATIONS);
                    
                    for (let y = 0; y <= years; y++) {
                        for(let s = 0; s < SIMULATIONS; s++) {
                            tempYearValues[s] = allPaths[s][y];
                        }
                        tempYearValues.sort(); 
                        p10Arr.push(tempYearValues[(SIMULATIONS * 0.1) | 0]);
                        p50Arr.push(tempYearValues[(SIMULATIONS * 0.5) | 0]);
                        p90Arr.push(tempYearValues[(SIMULATIONS * 0.9) | 0]);
                    }

                    return { medianFinal: p50Arr[years], percentiles: { p10: p10Arr, p50: p50Arr, p90: p90Arr }, years: years };
                }
            };

            const UI = {
                els: { assetInputs: {}, assetLabels: {}, assetLegends: {}, chartCircles: {} },
                faqObserver: null,
                hasRenderedFaq: false,
                tableInited: false, 
                init() {
                    this.setupErrorHandling();
                    this.cacheDOM();          
                    State.init();             
                    this.renderInputs();
                    this.initResultTable(); 
                    this.cacheDynamicDOM(); 
                    this.renderLegend(); 
                    this.cacheLegendDOM(); 
                    this.bindEvents(); 
                    this.subscribeToState(); 
                    this.renderAll();
                    this.setupLazyLoad();

                    const onIdle = window.requestIdleCallback || function(cb) { setTimeout(cb, 2000); };
                    
                    onIdle(() => {
                        State.calculateHistoricalStats(); 
                    }, { timeout: 3000 });
                },
                setupErrorHandling() {
                    window.addEventListener('error', (event) => {
                        if (event.message && event.message.includes('Script error')) return;
                        const msg = Translations[State.lang]?.errUnexpected || 'Unexpected Error. Please refresh.';
                        this.showToast(msg, 'error');
                    });
                },
                setupLazyLoad() {
                    if ('IntersectionObserver' in window) {
                        this.faqObserver = new IntersectionObserver((entries) => {
                            entries.forEach(entry => {
                                if (entry.isIntersecting) {
                                    this.renderFAQ();
                                    this.faqObserver.disconnect();
                                }
                            });
                        }, { rootMargin: '200px' });
                        this.faqObserver.observe(this.els.faqContainer);
                    } else {
                        this.renderFAQ();
                    }
                },
                subscribeToState() {
                    State.on('langChanged', () => { this.renderAll(); });
                    State.on('thresholdChanged', () => this.updateThresholdDisplay());
                    State.on('projModeChanged', () => this.renderProjectionUI());
                    State.on('calculationDone', (results) => {
                        this.renderResults(results); 
                        this.renderFireProgress(results.total);
                    });
                    State.on('principalSynced', (val) => {
                        if (this.els.projPrincipal) this.els.projPrincipal.value = val > 0 ? val : '';
                    });
                    State.on('projectionDone', (results) => {
                        this.renderProjectionResult(results);
                        this.renderMonteCarloChart(results);
                    });
                },
                cacheDOM() {
                    this.els = { ...this.els,
                        inputsContainer: document.getElementById('inputs-container'), resultBody: document.getElementById('result-body'), legendContainer: document.getElementById('legend-container'),
                        totalValue: document.getElementById('total-value'), fireYear: document.getElementById('fire-year'), fireMonth: document.getElementById('fire-month'),
                        fireExpenseInput: document.getElementById('fire-expense-input'), fireProgressBar: document.getElementById('fire-progress-bar'), firePercent: document.getElementById('fire-percent'), fireTargetDisplay: document.getElementById('fire-target-display'),
                        fireHeaderIcon: document.getElementById('fire-header-icon'), fireHeaderTitle: document.getElementById('fire-header-title'), fireFooterStandard: document.getElementById('fire-footer-standard'), fireFooterDiogenes: document.getElementById('fire-footer-diogenes'), diogenesQuote: document.getElementById('diogenes-quote'),
                        statusCard: document.getElementById('status-card'), statusIcon: document.getElementById('status-icon'), statusTitle: document.getElementById('status-title'),
                        statusDesc: document.getElementById('status-desc'), statusNote: document.getElementById('status-note'), thresholdDisplay: document.getElementById('threshold-display'),
                        btnMinus: document.getElementById('btn-minus'), btnPlus: document.getElementById('btn-plus'), btnEn: document.getElementById('btn-en'), btnZh: document.getElementById('btn-zh'),
                        faqContainer: document.getElementById('faq-container'), currencySymbols: document.querySelectorAll('.currency-symbol'), i18nElements: document.querySelectorAll('[data-i18n]'),
                        privacyModal: document.getElementById('privacy-modal'), modalOverlay: document.querySelector('.modal-overlay'), modalCloseBtn: document.getElementById('modal-close-btn'),
                        modalContent: document.querySelector('.modal-content'), modalBody: document.getElementById('modal-body'), appContainer: document.getElementById('app'), projPrincipal: document.getElementById('proj-principal'),
                        projYears: document.getElementById('proj-years'), projFlow: document.getElementById('proj-flow'),
                        projResult: document.getElementById('proj-result'), projFlowLabel: document.getElementById('proj-flow-label'),
                        modeSavingBtn: document.getElementById('mode-saving'), modeSpendingBtn: document.getElementById('mode-spending'), btnSimulate: document.getElementById('btn-simulate'),
                        toastContainer: document.getElementById('toast-container'), projEndYear: document.getElementById('proj-end-year'),
                        projChartFan: document.getElementById('proj-chart-fan'), projChartLine: document.getElementById('proj-chart-line'),
                        rule72Desc: document.getElementById('rule72-desc')
                    };
                },
                renderInputs() {
                    this.els.inputsContainer.innerHTML = ''; 
                    const fragment = document.createDocumentFragment();
                    Config.ASSETS.forEach(asset => {
                        const div = Utils.createEl('div');
                        
                        const label = Utils.createEl('label', 'block text-sm font-medium text-gray-700 mb-1.5');
                        label.id = `label-${asset.key}`;
                        label.htmlFor = `input-${asset.key}`;
                        
                        const relativeDiv = Utils.createEl('div', 'relative');
                        
                        const symbol = Utils.createEl('span', 'currency-symbol absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 font-bold select-none');
                        
                        const input = Utils.createEl('input', 'asset-input w-full pl-8 pr-4 py-3 bg-gray-50 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none font-mono text-lg placeholder-gray-300 transition-shadow');
                        input.type = 'text';
                        input.inputMode = 'numeric';
                        input.pattern = '[0-9]*';
                        input.maxLength = Config.ASSET_MAX_DIGITS;
                        input.id = `input-${asset.key}`;
                        input.placeholder = '0';
                        input.value = State.holdings[asset.key] === 0 ? '' : State.holdings[asset.key];
                        
                        relativeDiv.appendChild(symbol);
                        relativeDiv.appendChild(input);
                        div.appendChild(label);
                        div.appendChild(relativeDiv);
                        
                        fragment.appendChild(div);
                    });
                    this.els.inputsContainer.appendChild(fragment);
                },
                initResultTable() {
                    if (this.tableInited) return; 

                    const fragment = document.createDocumentFragment();
                    Config.ASSETS.forEach(asset => {
                        const tr = Utils.createEl('tr', 'hover:bg-gray-50/50 transition-colors');
                        tr.setAttribute('data-key', asset.key);
                        
                        // Asset Name Cell
                        const tdName = Utils.createEl('td', 'p-3 text-left pl-4');
                        const divName = Utils.createEl('div', 'flex items-center gap-3');
                        const dot = Utils.createEl('div', 'w-3 h-3 rounded-full flex-shrink-0');
                        dot.style.backgroundColor = asset.color;
                        const spanName = Utils.createEl('span', 'font-medium text-slate-700 whitespace-nowrap');
                        spanName.setAttribute('data-cell', 'name');
                        divName.append(dot, spanName);
                        tdName.appendChild(divName);
                        
                        // Percent Cell
                        const tdPercent = Utils.createEl('td', 'p-3 text-left font-mono');
                        const spanPercent = Utils.createEl('span', 'text-slate-600', '0.0%');
                        spanPercent.setAttribute('data-cell', 'percent');
                        tdPercent.appendChild(spanPercent);
                        
                        // Target Cell
                        const tdTarget = Utils.createEl('td', 'p-3 text-left font-mono text-slate-600 table-cell-truncate', '0');
                        tdTarget.setAttribute('data-cell', 'target');
                        
                        // Action Cell
                        const tdAction = Utils.createEl('td', 'p-3 text-left pl-4');
                        tdAction.setAttribute('data-cell', 'action');
                        
                        tr.append(tdName, tdPercent, tdTarget, tdAction);
                        fragment.appendChild(tr);
                    });
                    this.els.resultBody.replaceChildren(fragment);
                    this.tableInited = true;
                },
                cacheDynamicDOM() { Config.ASSETS.forEach(asset => { this.els.assetInputs[asset.key] = document.getElementById(`input-${asset.key}`); this.els.assetLabels[asset.key] = document.getElementById(`label-${asset.key}`); this.els.chartCircles[asset.key] = document.getElementById(`chart-${asset.key}`); }); },
                renderLegend() {
                    const fragment = document.createDocumentFragment();
                    Config.ASSETS.forEach(asset => { 
                        const div = Utils.createEl('div', 'flex items-center gap-3');
                        const dot = Utils.createEl('span', `w-3 h-3 rounded-full ${asset.tailwindColor} flex-shrink-0 shadow-sm`);
                        const text = Utils.createEl('span', 'text-sm font-medium text-slate-600');
                        text.id = `legend-${asset.key}`;
                        div.append(dot, text);
                        fragment.appendChild(div); 
                    });
                    this.els.legendContainer.replaceChildren(fragment);
                },
                cacheLegendDOM() { Config.ASSETS.forEach(asset => { this.els.assetLegends[asset.key] = document.getElementById(`legend-${asset.key}`); }); },
                bindEvents() {
                    this.els.btnEn.onclick = () => State.setLang('en'); this.els.btnZh.onclick = () => State.setLang('zh');
                    this.els.btnMinus.onclick = () => State.setThreshold(State.threshold - 1); this.els.btnPlus.onclick = () => State.setThreshold(State.threshold + 1);
                    document.getElementById('btn-privacy').onclick = (e) => this.openModal(e.currentTarget);
                    this.els.modalCloseBtn.onclick = () => this.closeModal(); this.els.modalOverlay.onclick = () => this.closeModal();
                    this.els.privacyModal.onkeydown = (e) => { if(e.key === "Escape") this.closeModal(); };
                    this.els.faqContainer.onclick = (e) => { const btn = e.target.closest('button[data-faq-toggle]'); if (btn) this.toggleFaq(btn); };
                    
                    this.els.inputsContainer.addEventListener('input', (e) => {
                        if (e.target.classList.contains('asset-input')) {
                            const key = e.target.id.replace('input-', '');
                            const clean = Utils.sanitizeInput(e.target.value, Config.ASSET_MAX_DIGITS);
                            if (e.target.value !== clean) e.target.value = clean;
                            State.updateHolding(key, clean);
                        }
                    });
                    
                    const projectionInputs = [
                        { el: this.els.projPrincipal, key: 'principal', type: 'input', max: Config.PROJ_MAX_DIGITS },
                        { el: this.els.projFlow, key: 'flow', type: 'input', max: Config.PROJ_MAX_DIGITS },
                        { el: this.els.projYears, key: 'years', type: 'integer', max: 50 }
                    ];

                    const sanitizerMap = { 'input': Utils.sanitizeInput, 'integer': Utils.sanitizeInteger };

                    projectionInputs.forEach(config => {
                        if (!config.el) return;
                        const sanitizer = sanitizerMap[config.type];
                        config.el.oninput = (e) => {
                            const clean = sanitizer(e.target.value, config.max);
                            if (e.target.value !== clean) e.target.value = clean;
                            State.projection[config.key] = clean;
                            State.triggerCalc();
                        };
                    });

                    this.els.modeSavingBtn.onclick = () => State.setProjMode('saving'); 
                    this.els.modeSpendingBtn.onclick = () => State.setProjMode('spending');
                    this.els.btnSimulate.onclick = () => State.forceResimulate();

                    if (this.els.fireExpenseInput) {
                        this.els.fireExpenseInput.oninput = (e) => {
                            const clean = Utils.sanitizeInput(e.target.value, Config.ASSET_MAX_DIGITS);
                            if (e.target.value !== clean) e.target.value = clean;
                            State.fireExpense = clean;
                            State.triggerCalc();
                        };
                    }
                },
                showToast(message, type = 'info') {
                    const toast = Utils.createEl('div', `toast toast-${type}`);
                    const iconSpan = Utils.createEl('span', 'text-lg', type === 'error' ? 'âš ï¸' : (type === 'success' ? 'âœ…' : 'â„¹ï¸'));
                    const msgSpan = Utils.createEl('span', 'text-sm font-medium text-slate-800 pt-0.5', message);
                    toast.append(iconSpan, msgSpan);
                    this.els.toastContainer.appendChild(toast);
                    requestAnimationFrame(() => toast.classList.add('show'));
                    setTimeout(() => {
                        toast.classList.remove('show');
                        setTimeout(() => toast.remove(), Config.TIMING.TOAST_FADEOUT);
                    }, Config.TIMING.TOAST_DISPLAY);
                },
                renderResults(data) {
                    const t = Translations[State.lang]; const { total, assetsData, globalBreach } = data;
                    Utils.animateTo(this.els.totalValue, total, State.lang, true); Utils.animateTo(this.els.fireYear, total * 0.04, State.lang, true); Utils.animateTo(this.els.fireMonth, total * 0.04 / 12, State.lang, true);
                    let statusClass, icon, title, desc, showNote; const allZero = total === 0;
                    if (allZero) { statusClass = "bg-blue-50/90 border-blue-200 text-blue-900"; icon = "âš–ï¸"; title = t.statusEmptyTitle; desc = t.statusEmptyDesc; showNote = false; } 
                    else if (globalBreach) { statusClass = "bg-amber-50/90 border-amber-200 text-amber-900"; icon = "âš ï¸"; title = t.statusActionTitle; desc = t.statusActionDesc.replace('{threshold}', State.threshold).replace('{min}', Config.TARGET_PERCENT - State.threshold).replace('{max}', Config.TARGET_PERCENT + State.threshold); showNote = true; } 
                    else { statusClass = "bg-emerald-50/90 border-emerald-200 text-emerald-900"; icon = "âœ…"; title = t.statusHealthyTitle; desc = t.statusHealthyDesc; showNote = false; }
                    
                    requestAnimationFrame(() => {
                        Utils.setClass(this.els.statusCard, `rounded-2xl p-6 border shadow-sm transition-all backdrop-blur-sm ${statusClass}`);
                        Utils.setText(this.els.statusIcon, icon); 
                        Utils.setText(this.els.statusTitle, title); 
                        Utils.setText(this.els.statusDesc, desc); 
                        Utils.setText(this.els.statusNote, t.statusActionNote); 
                        Utils.setClass(this.els.statusNote, showNote ? "mt-2 text-xs opacity-75" : "hidden");
                    });
                    
                    let chartOffset = 0;
                    const rows = this.els.resultBody.children;

                    assetsData.forEach((asset, index) => {
                        const circle = this.els.chartCircles[asset.key];
                        if (allZero) { circle.style.strokeDasharray = `0 100`; } else { circle.style.strokeDasharray = `${asset.percent} 100`; circle.style.strokeDashoffset = -chartOffset; chartOffset += asset.percent; }
                        
                        const tr = rows[index];
                        if (!tr) return; 

                        const nameCell = tr.querySelector('[data-cell="name"]');
                        const percentCell = tr.querySelector('[data-cell="percent"]');
                        const targetCell = tr.querySelector('[data-cell="target"]');
                        const actionCell = tr.querySelector('[data-cell="action"]');

                        Utils.setText(nameCell, t[asset.key]);
                        
                        const percentClass = asset.isBreached ? 'text-red-500 font-bold' : 'text-slate-600';
                        Utils.setClass(percentCell, percentClass);
                        Utils.setText(percentCell, `${asset.percent.toFixed(1)}%`);

                        const targetDisplay = Utils.formatMoney(asset.target, State.lang, true);
                        Utils.setText(targetCell, targetDisplay);
                        targetCell.title = targetDisplay;

                        // Clear previous action content
                        actionCell.textContent = '';
                        
                        const absDiff = Math.abs(asset.diff);
                        const locale = State.lang === 'zh' ? 'zh-CN' : 'en-US';
                        const currencyCode = Translations[State.lang].currencyCode;

                        if (allZero) { 
                            const dash = Utils.createEl('span', 'text-gray-300 text-lg font-bold select-none', '-');
                            actionCell.appendChild(dash);
                        } 
                        else if (globalBreach) {
                            if (absDiff < 0.01) {
                                const holdSpan = Utils.createEl('span', 'text-gray-400 text-sm font-medium pl-1 font-mono', t.hold);
                                actionCell.appendChild(holdSpan);
                            } else {
                                const type = asset.diff > 0 ? t.buy : t.sell; 
                                const colorClass = asset.diff > 0 ? 'bg-blue-50/80 text-blue-700' : 'bg-orange-50/80 text-orange-700';
                                
                                let formattedAmount;
                                if (absDiff < 1) {
                                    formattedAmount = Utils.getFormatter(locale, { style: 'currency', currency: currencyCode, minimumFractionDigits: 1, maximumFractionDigits: 2 }).format(absDiff);
                                } else {
                                    formattedAmount = Utils.getFormatter(locale, { style: 'currency', currency: currencyCode, maximumFractionDigits: 0 }).format(absDiff);
                                }
                                
                                const badge = Utils.createEl('div', `inline-flex items-center gap-1.5 px-3 py-1 rounded-full text-sm font-bold ${colorClass} whitespace-nowrap font-mono`);
                                badge.textContent = type + ' ';
                                const amountSpan = Utils.createEl('span', 'ml-1', formattedAmount);
                                badge.appendChild(amountSpan);
                                actionCell.appendChild(badge);
                            }
                        } else { 
                            const holdSpan = Utils.createEl('span', 'text-gray-400 text-sm font-medium pl-1 font-mono', t.hold);
                            actionCell.appendChild(holdSpan);
                        }
                    });
                },
                renderFireProgress(totalAssets) {
                    const expenseStr = State.fireExpense;
                    const expense = parseFloat(expenseStr) || 0;
                    const t = Translations[State.lang];
                    
                    this.els.firePercent.className = 'transition-colors duration-300 font-mono';
                    this.els.fireExpenseInput.classList.remove('ring-2', 'ring-amber-500', 'ring-opacity-50');
                    this.els.fireProgressBar.className = 'h-full bg-gradient-to-r from-emerald-600 to-emerald-400 transition-all duration-700 ease-out w-0 shadow-[0_0_10px_rgba(16,185,129,0.5)]';
                    
                    this.els.fireHeaderIcon.textContent = 'ğŸ”¥';
                    this.els.fireHeaderTitle.textContent = t.fireTitle;
                    this.els.fireFooterStandard.classList.remove('hidden');
                    this.els.fireFooterDiogenes.classList.add('hidden');

                    if (expenseStr === '') {
                        this.els.fireProgressBar.style.width = '0%';
                        this.els.firePercent.textContent = t.fireSetGoal;
                        this.els.firePercent.classList.add('text-sm', 'text-slate-500', 'font-medium', 'italic');
                        this.els.fireExpenseInput.classList.add('ring-2', 'ring-amber-500', 'ring-opacity-50');
                        Utils.setText(this.els.fireTargetDisplay, '---');
                        return;
                    }

                    this.els.firePercent.classList.add('text-2xl', 'text-white', 'font-bold');

                    if (expense === 0 && totalAssets > 0) {
                        this.els.fireHeaderIcon.textContent = 'ğŸº'; 
                        this.els.fireHeaderTitle.textContent = t.diogenesTitle;
                        this.els.fireProgressBar.className = 'h-full transition-all duration-700 ease-out w-0 shadow-[0_0_10px_rgba(251,191,36,0.5)] bg-gradient-to-r from-amber-300 to-yellow-500'; 
                        this.els.fireProgressBar.style.width = '100%';
                        this.els.firePercent.textContent = 'âˆ';
                        this.els.firePercent.className = 'text-2xl font-bold text-yellow-400 font-mono';
                        this.els.fireFooterStandard.classList.add('hidden');
                        this.els.fireFooterDiogenes.classList.remove('hidden');
                        this.els.diogenesQuote.textContent = State.lang === 'zh' ? 'â€œè¯·ä¸è¦æŒ¡ä½æˆ‘çš„é˜³å…‰ï¼â€' : 'â€œStand out of my sunshine!â€';
                        return;
                    }

                    if (expense === 0 && totalAssets === 0) {
                        this.els.fireProgressBar.style.width = '0%';
                        this.els.firePercent.textContent = '0.0%';
                        Utils.setText(this.els.fireTargetDisplay, Utils.formatMoney(0, State.lang, true));
                        return;
                    }

                    const target = expense * 25;
                    let percent = 0;
                    if (target > 0) { percent = (totalAssets / target) * 100; }
                    const visualPercent = Math.min(percent, 100);
                    this.els.fireProgressBar.style.width = `${visualPercent}%`;
                    this.els.firePercent.textContent = `${percent.toFixed(1)}%`;
                    Utils.setText(this.els.fireTargetDisplay, Utils.formatMoney(target, State.lang, true));
                },
                renderProjectionUI() {
                    const t = Translations[State.lang]; const mode = State.projection.mode;
                    if (mode === 'saving') { 
                        Utils.setClass(this.els.modeSavingBtn, "px-3 py-1.5 text-sm font-semibold rounded-md shadow-sm bg-white text-emerald-600 transition-all"); 
                        Utils.setClass(this.els.modeSpendingBtn, "px-3 py-1.5 text-sm font-semibold rounded-md text-gray-500 hover:text-gray-700 transition-all"); 
                        Utils.setText(this.els.projFlowLabel, t.projContribution); 
                    } else { 
                        Utils.setClass(this.els.modeSavingBtn, "px-3 py-1.5 text-sm font-semibold rounded-md text-gray-500 hover:text-gray-700 transition-all"); 
                        Utils.setClass(this.els.modeSpendingBtn, "px-3 py-1.5 text-sm font-semibold rounded-md shadow-sm bg-white text-orange-600 transition-all"); 
                        Utils.setText(this.els.projFlowLabel, t.projExpense); 
                    }
                },
                updateThresholdDisplay() { Utils.setText(this.els.thresholdDisplay, State.threshold); this.els.btnMinus.disabled = (State.threshold <= Config.MIN_THRESHOLD); this.els.btnPlus.disabled = (State.threshold >= Config.MAX_THRESHOLD); },
                renderFAQ() {
                    const t = Translations[State.lang];
                    this.els.faqContainer.innerHTML = ''; 
                    const faqFragment = document.createDocumentFragment();
                    
                    t.faqData.forEach((item, index) => {
                        const container = Utils.createEl('div', 'border border-gray-200 rounded-xl overflow-hidden bg-white/80 backdrop-blur-sm');
                        
                        const btn = Utils.createEl('button', 'w-full flex justify-between items-center p-4 bg-gray-50/50 hover:bg-gray-100/50 transition-colors text-left focus:outline-none');
                        btn.type = 'button';
                        btn.setAttribute('data-faq-toggle', 'true');
                        btn.setAttribute('data-index', index);
                        btn.setAttribute('aria-expanded', 'false');
                        
                        const qSpan = Utils.createEl('span', 'font-bold text-slate-800 text-sm', item.question);
                        
                        // Create SVG Icon manually
                        const svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
                        svg.setAttribute("class", "faq-icon w-5 h-5 text-slate-400 flex-shrink-0 ml-4");
                        svg.setAttribute("fill", "none");
                        svg.setAttribute("stroke", "currentColor");
                        svg.setAttribute("viewBox", "0 0 24 24");
                        const path = document.createElementNS("http://www.w3.org/2000/svg", "path");
                        path.setAttribute("stroke-linecap", "round");
                        path.setAttribute("stroke-linejoin", "round");
                        path.setAttribute("stroke-width", "2");
                        path.setAttribute("d", "M19 9l-7 7-7-7");
                        svg.appendChild(path);
                        
                        btn.append(qSpan, svg);
                        
                        const content = Utils.createEl('div', 'faq-content bg-white/50');
                        content.id = `faq-content-${index}`;
                        
                        const inner = Utils.createEl('div', 'faq-inner');
                        const body = Utils.createEl('div', 'p-4 text-sm text-slate-600 leading-relaxed border-t border-gray-100 space-y-2');
                        
                        if (Array.isArray(item.answer)) {
                            item.answer.forEach(paraText => {
                                const p = Utils.createEl('p', '', paraText);
                                body.appendChild(p);
                            });
                        } else {
                            const p = Utils.createEl('p', '', item.answer);
                            body.appendChild(p);
                        }
                        
                        inner.appendChild(body);
                        content.appendChild(inner);
                        container.append(btn, content);
                        faqFragment.appendChild(container);
                    });
                    this.els.faqContainer.appendChild(faqFragment);
                    this.hasRenderedFaq = true;
                },
                renderAll() {
                    const lang = State.lang; const t = Translations[lang];
                    document.documentElement.lang = lang === 'zh' ? 'zh-CN' : 'en';
                    document.title = lang === 'en' ? "4x25 Strategy & FIRE Tool | Permanent Portfolio Calculator" : "4x25 Strategy & FIRE Tool | æ°¸ä¹…æŠ•èµ„ç»„åˆè®¡ç®—å™¨";
                    
                    this.els.i18nElements.forEach(el => { 
                        const key = el.getAttribute('data-i18n'); 
                        if (t[key]) { 
                            Utils.setText(el, t[key]); 
                        } 
                    });
                    
                    Config.ASSETS.forEach(asset => { Utils.setText(this.els.assetLabels[asset.key], t[asset.key]); Utils.setText(this.els.assetLegends[asset.key], t[asset.key]); });
                    const symbol = new Intl.NumberFormat(lang === 'zh' ? 'zh-CN' : 'en-US', { style: 'currency', currency: t.currencyCode }).formatToParts(0).find(x => x.type === 'currency').value;
                    this.els.currencySymbols.forEach(el => Utils.setText(el, symbol));
                    
                    if (this.hasRenderedFaq) {
                        this.renderFAQ();
                    }

                    Utils.setClass(this.els.btnZh, `lang-btn w-20 flex justify-center px-4 py-3 text-sm font-bold hover:bg-gray-50 transition-colors ${lang === 'zh' ? 'active' : ''}`);
                    Utils.setClass(this.els.btnEn, `lang-btn w-20 flex justify-center px-4 py-3 text-sm font-bold hover:bg-gray-50 transition-colors ${lang === 'en' ? 'active' : ''}`);
                    
                    this.initResultTable();

                    if (this.els.projPrincipal) this.els.projPrincipal.value = State.projection.principal;
                    if (this.els.projYears) this.els.projYears.value = State.projection.years;
                    if (this.els.projFlow) this.els.projFlow.value = State.projection.flow;
                    if (this.els.fireExpenseInput) this.els.fireExpenseInput.value = State.fireExpense;
                    
                    this.renderRule72();

                    this.renderProjectionUI(); this.updateThresholdDisplay(); State.triggerCalc();
                },
                toggleFaq(btn) {
                    const content = btn.nextElementSibling; const icon = btn.querySelector('.faq-icon'); const isOpen = content.classList.contains('open');
                    if (isOpen) { content.classList.remove('open'); icon.classList.remove('rotate'); btn.setAttribute('aria-expanded', 'false'); } else { content.classList.add('open'); icon.classList.add('rotate'); btn.setAttribute('aria-expanded', 'true'); }
                },
                setInert(element, isInert) {
                    if ('inert' in HTMLElement.prototype) { element.inert = isInert; } 
                    else {
                        if (isInert) { element.setAttribute('aria-hidden', 'true'); element.style.pointerEvents = 'none'; const focusables = element.querySelectorAll('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])'); focusables.forEach(el => { if (!el.hasAttribute('data-original-tabindex')) { el.setAttribute('data-original-tabindex', el.getAttribute('tabindex', '-1') || ''); } el.setAttribute('tabindex', '-1'); }); } 
                        else { element.removeAttribute('aria-hidden'); element.style.pointerEvents = ''; const focusables = element.querySelectorAll('[data-original-tabindex]'); focusables.forEach(el => { const original = el.getAttribute('data-original-tabindex'); if (original === '') { el.removeAttribute('tabindex'); } else { el.setAttribute('tabindex', original); } el.removeAttribute('data-original-tabindex'); }); }
                    }
                },
                openModal(triggerElement) {
                    const lang = State.lang;
                    const tmplId = lang === 'zh' ? 'tmpl-privacy-zh' : 'tmpl-privacy-en';
                    const tmpl = document.getElementById(tmplId);
                    if (tmpl && this.els.modalBody) {
                        this.els.modalBody.replaceChildren(tmpl.content.cloneNode(true));
                    }
                    
                    this.lastFocusedElement = triggerElement; document.body.style.overflow = 'hidden'; this.els.privacyModal.classList.remove('hidden');
                    this.setInert(this.els.appContainer, true);
                    setTimeout(() => { this.els.modalOverlay.classList.remove('opacity-0'); this.els.modalContent.classList.remove('opacity-0', 'translate-y-4', 'sm:translate-y-0', 'sm:scale-95'); this.els.modalContent.classList.add('opacity-100', 'translate-y-0', 'sm:scale-100'); this.els.modalCloseBtn.focus(); }, 10);
                },
                closeModal() {
                    this.els.modalOverlay.classList.add('opacity-0'); this.els.modalContent.classList.remove('opacity-100', 'translate-y-0', 'sm:scale-100'); this.els.modalContent.classList.add('opacity-0', 'translate-y-4', 'sm:translate-y-0', 'sm:scale-95'); document.body.style.overflow = '';
                    this.setInert(this.els.appContainer, false);
                    setTimeout(() => { this.els.privacyModal.classList.add('hidden'); if (this.lastFocusedElement) this.lastFocusedElement.focus(); }, 300);
                },
                renderProjectionResult(data) {
                    const { medianFinal, years } = data;
                    Utils.animateTo(this.els.projResult, medianFinal, State.lang, true);
                    const currentYear = new Date().getFullYear();
                    this.els.projEndYear.textContent = currentYear + years;
                },
                renderMonteCarloChart(data) {
                    const { percentiles, years } = data;
                    if (!percentiles.p50 || percentiles.p50.length < 2) {
                        this.els.projChartFan.setAttribute('d', '');
                        this.els.projChartLine.setAttribute('d', '');
                        return;
                    }

                    const allValues = [...percentiles.p10, ...percentiles.p90];
                    let globalMin = Math.min(...allValues);
                    let globalMax = Math.max(...allValues);
                    if (globalMax === globalMin) { globalMax += 1; }

                    const renderRange = globalMax - globalMin;
                    const width = 100;
                    const height = 100;
                    const svgTop = 10;
                    const svgBottom = 85; 
                    const svgHeight = svgBottom - svgTop;
                    const stepX = width / years;

                    const mapPt = (val, i) => {
                        const x = i * stepX;
                        const normalizedVal = (val - globalMin) / renderRange;
                        const y = svgBottom - (normalizedVal * svgHeight);
                        return { x, y };
                    };

                    const medianPoints = percentiles.p50.map((val, i) => { const pt = mapPt(val, i); return `${pt.x},${pt.y}`; });
                    const lineD = `M ${medianPoints.join(' L ')}`;
                    this.els.projChartLine.setAttribute('d', lineD);

                    const topPoints = percentiles.p90.map((val, i) => mapPt(val, i));
                    const bottomPoints = percentiles.p10.map((val, i) => mapPt(val, i)).reverse();
                    
                    let areaD = `M ${topPoints[0].x},${topPoints[0].y}`;
                    topPoints.forEach(p => areaD += ` L ${p.x},${p.y}`);
                    bottomPoints.forEach(p => areaD += ` L ${p.x},${p.y}`);
                    areaD += ' Z';

                    this.els.projChartFan.setAttribute('d', areaD);
                },
                renderRule72() {
                    if (State.historicalStats && this.els.rule72Desc) {
                        const t = Translations[State.lang];
                        const { cagr, doublingTime } = State.historicalStats;
                        const rawText = t.rule72Desc;
                        const filledText = rawText.replace('{rate}', cagr.toFixed(1)).replace('{years}', doublingTime.toFixed(1));
                        this.els.rule72Desc.textContent = filledText;
                    }
                }
            };
            return { init: () => UI.init() };
        })();
        
        document.addEventListener('DOMContentLoaded', () => {
            App.init();
            const loadGA = () => {
                const script = document.createElement('script');
                script.async = true;
                script.src = 'https://www.googletagmanager.com/gtag/js?id=G-8GJYYGEB88';
                document.head.appendChild(script);

                window.dataLayer = window.dataLayer || [];
                function gtag(){dataLayer.push(arguments);}
                window.gtag = gtag;
                gtag('js', new Date());
                gtag('config', 'G-8GJYYGEB88');
            };
            const onIdle = window.requestIdleCallback || function(cb) { setTimeout(cb, 2000); };
            onIdle(loadGA, { timeout: 4000 });
        });
    </script>
</body>
</html>
