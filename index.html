<!DOCTYPE html>
<html lang="en" prefix="og: http://ogp.me/ns#">
<head>
    <!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-8GJYYGEB88"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-8GJYYGEB88');
</script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- SEO OPTIMIZATION START -->
    <title>4x25 Strategy & FIRE Tool | æ°¸ä¹…æŠ•èµ„ç»„åˆè®¡ç®—å™¨</title>
    <meta name="description" content="Free 4x25 Strategy & FIRE Tool. Rebalance your Permanent Portfolio and calculate safe withdrawal rates. å…è´¹çš„æ°¸ä¹…æŠ•èµ„ç»„åˆå†å¹³è¡¡ç­–ç•¥å·¥å…·ä¸ FIRE è´¢åŠ¡è‡ªç”±è®¡ç®—å™¨ã€‚">
    <meta property="og:title" content="4x25 Strategy & FIRE Tool">
    <meta property="og:description" content="Asset Allocation & Rebalancing Calculator for the Permanent Portfolio.">
    <meta property="og:type" content="website">
    <!-- SEO OPTIMIZATION END -->

    <!-- FONT OPTIMIZATION START -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <!-- FONT OPTIMIZATION END -->

    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com/3.4.1"></script>
    
    <style>
        /* ä½¿ç”¨ Inter å­—ä½“ï¼Œå¢åŠ  font-feature-settings ä¼˜åŒ–æ•°å­—æ˜¾ç¤º */
        body { font-family: 'Inter', system-ui, -apple-system, sans-serif; font-feature-settings: "tnum"; }
        .lang-btn.active { background-color: #3b82f6; color: white; border-color: #3b82f6; }
        
        button:disabled { opacity: 0.3; cursor: not-allowed; pointer-events: none; }
        
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        input[type=number] { -moz-appearance: textfield; }

        .table-cell-truncate { max-width: 140px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        
        /* --- FAQ åŠ¨ç”»ä¼˜åŒ– (ä½¿ç”¨ CSS Grid) --- */
        .faq-content {
            display: grid;
            grid-template-rows: 0fr;
            transition: grid-template-rows 0.3s ease-out, opacity 0.3s ease-out;
            opacity: 0;
            visibility: hidden;
        }
        
        .faq-content.open {
            grid-template-rows: 1fr;
            opacity: 1;
            visibility: visible;
        }

        .faq-inner {
            overflow: hidden;
            min-height: 0; 
        }
        /* ---------------------------------- */

        .faq-icon { transition: transform 0.3s ease; }
        .faq-icon.rotate { transform: rotate(180deg); }
        .modal-overlay { transition: opacity 0.3s ease; }
        .modal-content { transition: transform 0.3s ease, opacity 0.3s ease; }
        
        /* Chart Transition */
        .chart-segment { transition: stroke-dasharray 0.6s cubic-bezier(0.4, 0, 0.2, 1), stroke-dashoffset 0.6s cubic-bezier(0.4, 0, 0.2, 1); }

        button:focus-visible, input:focus-visible, a:focus-visible {
            outline: 2px solid #2563eb;
            outline-offset: 2px;
        }
        
        body { opacity: 0; animation: fadeIn 0.3s ease-in forwards; }
        @keyframes fadeIn { to { opacity: 1; } }

        @media (prefers-reduced-motion: reduce) {
            *, ::before, ::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
                scroll-behavior: auto !important;
            }
            .faq-content { transition: none !important; }
            .chart-segment { transition: none !important; }
        }
    </style>
</head>
<body class="bg-gray-50 text-slate-800 min-h-screen flex flex-col">

    <!-- Main App Container -->
    <div id="app" class="flex flex-col min-h-screen p-4 md:p-8 transition-opacity duration-300">
        <div class="max-w-5xl mx-auto w-full flex-grow">
            <!-- Header -->
            <header class="mb-10 flex flex-col md:flex-row md:items-end justify-between gap-6 border-b border-gray-100 pb-6">
                <div class="flex flex-col justify-center">
                    <!-- Logo -->
                    <h1 class="flex items-center tracking-tighter select-none group cursor-default">
                        <span class="text-5xl md:text-6xl font-black text-slate-900 tracking-tight">4</span>
                        <span class="text-3xl md:text-4xl font-bold text-blue-500 mx-1 opacity-80 group-hover:opacity-100 transition-opacity">Ã—</span>
                        <span class="text-5xl md:text-6xl font-black text-slate-900 tracking-tight">25</span>
                    </h1>
                    
                    <h2 class="text-slate-500 mt-3 text-base md:text-lg font-medium" data-i18n="subtitle">Permanent Portfolio Strategy & FIRE Tool</h2>
                </div>
                
                <div class="flex flex-col md:flex-row gap-3 items-end md:items-center">
                    <!-- Language Switcher -->
                    <div class="flex rounded-lg shadow-sm overflow-hidden border border-gray-300 bg-white" role="group" aria-label="Language Selection">
                        <!-- Added w-20 and justify-center to ensure equal width -->
                        <button type="button" id="btn-en" class="lang-btn w-20 flex justify-center px-4 py-3 text-sm font-bold hover:bg-gray-50 transition-colors active" aria-pressed="true">EN</button>
                        <div class="w-px bg-gray-300"></div>
                        <button type="button" id="btn-zh" class="lang-btn w-20 flex justify-center px-4 py-3 text-sm font-bold hover:bg-gray-50 transition-colors" aria-pressed="false">ä¸­æ–‡</button>
                    </div>

                    <div class="bg-white px-2 py-1.5 rounded-lg shadow-sm border border-gray-200 flex items-center gap-2 select-none">
                        <span class="text-sm font-bold text-gray-500 ml-2" data-i18n="thresholdLabel" id="threshold-label">Threshold: Â±</span>
                        <div class="flex items-center bg-gray-100 rounded-md p-1" role="group" aria-labelledby="threshold-label">
                            <button type="button" id="btn-minus" aria-label="Decrease threshold" class="w-8 h-8 flex items-center justify-center bg-white rounded shadow-sm text-slate-600 hover:text-blue-600 hover:bg-blue-50 transition-all font-bold text-lg">-</button>
                            <div class="w-10 text-center font-bold text-slate-800" id="threshold-display" aria-live="polite">10</div>
                            <span class="text-xs font-bold text-slate-400 mr-2" aria-hidden="true">%</span>
                            <button type="button" id="btn-plus" aria-label="Increase threshold" class="w-8 h-8 flex items-center justify-center bg-white rounded shadow-sm text-slate-600 hover:text-blue-600 hover:bg-blue-50 transition-all font-bold text-lg">+</button>
                        </div>
                    </div>
                </div>
            </header>

            <main class="grid grid-cols-1 lg:grid-cols-12 gap-8">
                
                <!-- Left: Inputs -->
                <section class="lg:col-span-4 space-y-6">
                    <div class="bg-white rounded-2xl shadow-sm border border-gray-200 p-6">
                        <h3 class="text-xl font-bold mb-6 flex items-center gap-2" data-i18n="inputTitle">ğŸ’° Current Holdings</h3>
                        <div class="space-y-5" id="inputs-container">
                            <!-- JS Generated Inputs -->
                        </div>
                        <div class="mt-8 pt-6 border-t border-gray-100 flex justify-between items-center overflow-hidden">
                            <span class="text-gray-500 font-medium whitespace-nowrap mr-2" data-i18n="totalValue">Total Value</span>
                            <span class="text-2xl font-bold text-slate-900 font-mono truncate" id="total-value" data-current-value="0">0</span>
                        </div>
                    </div>

                    <!-- SVG Chart -->
                    <div class="bg-white rounded-2xl shadow-sm border border-gray-200 p-6 flex flex-col items-center" aria-hidden="true">
                        <div class="relative w-48 h-48 mb-6">
                            <svg viewBox="0 0 32 32" class="w-full h-full transform -rotate-90">
                                <circle r="15.9155" cx="16" cy="16" fill="transparent" stroke="#f3f4f6" stroke-width="6"></circle>
                                <circle id="chart-stocks" class="chart-segment" r="15.9155" cx="16" cy="16" fill="transparent" stroke="#3B82F6" stroke-width="6" stroke-dasharray="0 100" stroke-dashoffset="0"></circle>
                                <circle id="chart-bonds" class="chart-segment" r="15.9155" cx="16" cy="16" fill="transparent" stroke="#8B5CF6" stroke-width="6" stroke-dasharray="0 100" stroke-dashoffset="0"></circle>
                                <circle id="chart-cash" class="chart-segment" r="15.9155" cx="16" cy="16" fill="transparent" stroke="#10B981" stroke-width="6" stroke-dasharray="0 100" stroke-dashoffset="0"></circle>
                                <circle id="chart-gold" class="chart-segment" r="15.9155" cx="16" cy="16" fill="transparent" stroke="#F59E0B" stroke-width="6" stroke-dasharray="0 100" stroke-dashoffset="0"></circle>
                            </svg>
                            <div class="absolute inset-0 flex items-center justify-center pointer-events-none flex-col">
                                <span class="text-slate-900 font-black text-xl tracking-tight">4<span class="text-blue-500 mx-px">Ã—</span>25</span>
                            </div>
                        </div>
                        <div class="w-full px-6 space-y-3" id="legend-container">
                            <!-- Legend generated by JS -->
                        </div>
                    </div>
                </section>

                <!-- Right: Results -->
                <section class="lg:col-span-8 space-y-6">
                    
                    <!-- Status Card -->
                    <div id="status-card" class="rounded-2xl p-6 border-l-4 shadow-sm transition-all bg-blue-50 border-blue-500 text-blue-900" role="status" aria-live="polite">
                        <div class="flex items-start gap-4">
                            <div id="status-icon" class="text-2xl" aria-hidden="true">âš–ï¸</div>
                            <div>
                                <h3 class="text-lg font-bold" id="status-title">...</h3>
                                <p class="mt-1 text-sm" id="status-desc">...</p>
                                <p class="mt-2 text-xs opacity-75 hidden" id="status-note"></p>
                            </div>
                        </div>
                    </div>

                    <!-- Table -->
                    <div class="bg-white rounded-2xl shadow-sm border border-gray-200 overflow-hidden">
                        <div class="p-6 border-b border-gray-100 flex justify-between items-center">
                            <h3 class="text-xl font-bold" data-i18n="rebalanceTitle">ğŸ”„ Rebalancing Suggestions</h3>
                            <span class="text-xs font-mono bg-gray-100 text-gray-600 px-2 py-1 rounded" data-i18n="targetLabel">Target: 25%</span>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-left border-collapse">
                                <thead>
                                    <tr class="bg-gray-50 text-gray-500 text-sm uppercase tracking-wider">
                                        <th class="p-3 font-medium whitespace-nowrap text-left pl-4" data-i18n="colAsset" scope="col">Asset</th>
                                        <th class="p-3 font-medium whitespace-nowrap text-left" data-i18n="colCurrent" scope="col">Current %</th>
                                        <th class="p-3 font-medium whitespace-nowrap text-left" data-i18n="colTarget" scope="col">Target Value</th>
                                        <th class="p-3 font-medium whitespace-nowrap text-left" data-i18n="colAction" scope="col">Action</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-gray-100" id="result-body">
                                    <!-- JS Generated Rows -->
                                </tbody>
                            </table>
                        </div>
                        
                        <!-- FOOTER FOR TAX/FEE DISCLAIMER -->
                        <div class="bg-gray-50 px-6 py-3 border-t border-gray-100 text-xs text-slate-500 flex items-start gap-2 leading-relaxed">
                            <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 flex-shrink-0 opacity-70 mt-0.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg>
                            <span data-i18n="rebalanceNote">Note: Suggested actions are theoretical and do not account for transaction fees or tax implications.</span>
                        </div>
                    </div>

                    <!-- FIRE Calc -->
                    <div class="bg-slate-900 text-white rounded-2xl p-6 shadow-lg overflow-hidden">
                        <h3 class="text-lg font-bold mb-2" data-i18n="fireTitle">FIRE 4% Rule Preview</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-4">
                            <div class="overflow-hidden">
                                <p class="text-slate-400 text-sm mb-1" data-i18n="fireYear">Safe Annual Withdrawal</p>
                                <p class="text-3xl font-mono font-bold text-emerald-400 truncate" id="fire-year" data-current-value="0">0</p>
                            </div>
                            <div class="overflow-hidden">
                                <p class="text-slate-400 text-sm mb-1" data-i18n="fireMonth">Safe Monthly Withdrawal</p>
                                <p class="text-2xl font-mono font-bold text-emerald-400 truncate" id="fire-month" data-current-value="0">0</p>
                            </div>
                        </div>
                    </div>

                    <!-- 4% Rule Info -->
                    <article class="bg-white rounded-2xl shadow-sm border border-gray-200 p-6">
                        <h3 class="text-base font-bold text-slate-900 mb-2 flex items-center gap-2">
                            <span class="text-blue-500" aria-hidden="true">â„¹ï¸</span> <span data-i18n="fireRuleTitle">About the 4% Rule</span>
                        </h3>
                        <div class="text-sm text-slate-600 leading-relaxed" data-i18n="fireRuleText" data-i18n-html="true"></div>
                    </article>

                    <!-- Wealth Projection Mini Calculator -->
                    <div class="bg-white rounded-2xl shadow-sm border border-gray-200 p-6">
                        <div class="flex flex-col sm:flex-row sm:items-center justify-between mb-6 gap-4">
                            <h3 class="text-xl font-bold flex items-center gap-2">
                                <span class="text-purple-500">ğŸ”®</span> <span data-i18n="projTitle">Wealth Simulation</span>
                            </h3>
                            
                            <!-- Toggle: Saving vs Spending -->
                            <div class="flex bg-gray-100 p-1 rounded-lg self-start sm:self-auto">
                                <button type="button" id="mode-saving" class="px-3 py-1.5 text-xs font-bold rounded-md shadow-sm bg-white text-emerald-600 transition-all">
                                    <span data-i18n="modeSaving">Saving</span>
                                </button>
                                <button type="button" id="mode-spending" class="px-3 py-1.5 text-xs font-bold rounded-md text-gray-500 hover:text-gray-700 transition-all">
                                    <span data-i18n="modeSpending">Spending</span>
                                </button>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <!-- Inputs -->
                            <div class="space-y-4">
                                <div>
                                    <div class="mb-1">
                                        <label class="block text-xs font-bold text-gray-500 uppercase" data-i18n="projCurrent">Current Assets</label>
                                    </div>
                                    <div class="relative">
                                        <span class="currency-symbol absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 font-bold text-sm"></span>
                                        <input type="text" id="proj-principal" maxlength="8" class="w-full pl-7 pr-3 py-2 bg-gray-50 border border-gray-200 rounded-lg font-mono text-sm focus:ring-2 focus:ring-purple-500 outline-none placeholder-gray-300" placeholder="0">
                                    </div>
                                </div>
                                
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1" data-i18n="projRate">Return % (0-100)</label>
                                        <div class="relative">
                                            <!-- Placeholder 0 -->
                                            <input type="text" inputmode="decimal" id="proj-rate" value="6.8" placeholder="0" class="w-full pl-3 pr-6 py-2 bg-gray-50 border border-gray-200 rounded-lg font-mono text-sm focus:ring-2 focus:ring-purple-500 outline-none placeholder-gray-300">
                                            <span class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 font-bold text-xs">%</span>
                                        </div>
                                    </div>
                                    <div>
                                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1" data-i18n="projYears">Years (1-100)</label>
                                        <!-- Placeholder 1 -->
                                        <input type="text" inputmode="numeric" id="proj-years" value="10" placeholder="1" class="w-full px-3 py-2 bg-gray-50 border border-gray-200 rounded-lg font-mono text-sm focus:ring-2 focus:ring-purple-500 outline-none placeholder-gray-300">
                                    </div>
                                </div>

                                <div>
                                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1" id="proj-flow-label" data-i18n="projContribution">Annual Contribution</label>
                                    <div class="relative">
                                        <span class="currency-symbol absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 font-bold text-sm"></span>
                                        <input type="text" id="proj-flow" maxlength="8" class="w-full pl-7 pr-3 py-2 bg-gray-50 border border-gray-200 rounded-lg font-mono text-sm focus:ring-2 focus:ring-purple-500 outline-none placeholder-gray-300" placeholder="0">
                                    </div>
                                </div>
                            </div>

                            <!-- Result -->
                            <div class="bg-purple-50 rounded-xl p-5 flex flex-col justify-center items-center text-center border border-purple-100 overflow-hidden">
                                <p class="text-purple-600 font-medium text-sm mb-2" data-i18n="projResultLabel">Future Total Assets</p>
                                <p class="text-3xl md:text-4xl font-bold text-slate-900 font-mono tracking-tight break-all w-full" id="proj-result" data-current-value="0">0</p>
                                <div class="mt-4 text-xs text-purple-400 font-medium bg-white px-3 py-1 rounded-full shadow-sm max-w-full">
                                    <span data-i18n="projGain">Total Gain</span>: <span id="proj-gain" class="font-mono break-all" data-current-value="0">0</span>
                                </div>
                            </div>
                        </div>

                        <!-- DISCLAIMER FOOTER -->
                        <div class="mt-6 pt-4 border-t border-gray-50 text-xs text-slate-400 flex items-start gap-1.5 leading-relaxed">
                            <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 flex-shrink-0 opacity-70" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg>
                            <span data-i18n="projNote">Note: Projections are nominal values and do not account for inflation or deflation effects.</span>
                        </div>
                    </div>

                </section>
            </main>

            <!-- Intro & FAQ -->
            <article class="mt-10 bg-white rounded-2xl shadow-sm border border-gray-200 p-8">
                <h2 class="text-2xl font-bold text-slate-900 mb-4" data-i18n="introTitle">What is the Permanent Portfolio?</h2>
                <div class="prose text-slate-600 max-w-none leading-relaxed mb-10" data-i18n="introText" data-i18n-html="true"></div>
                
                <div class="border-t border-gray-100 pt-8">
                    <h3 class="text-xl font-bold text-slate-800 mb-6" data-i18n="faqTitle">Frequently Asked Questions (FAQ)</h3>
                    <div id="faq-container" class="space-y-4"></div>
                </div>
            </article>
        </div>

        <!-- Footer -->
        <footer class="mt-12 text-center pb-8 px-4 border-t border-gray-100 pt-8">
            <p class="text-slate-400 text-sm mb-2">
                &copy; 2026 4x25 Â· <button type="button" id="btn-privacy" class="cursor-pointer hover:text-slate-600 transition-colors underline decoration-slate-300 underline-offset-2" data-i18n="privacy">Privacy Policy</button>
            </p>
            <p class="text-slate-400 text-xs max-w-2xl mx-auto leading-relaxed opacity-80" data-i18n="disclaimer">
                Disclaimer: This tool is for informational purposes only.
            </p>
        </footer>
    </div>

    <!-- Privacy Modal -->
    <div id="privacy-modal" class="fixed inset-0 z-50 hidden" role="dialog" aria-modal="true" aria-labelledby="modal-title">
        <div class="modal-overlay absolute inset-0 bg-slate-900/50 backdrop-blur-sm transition-opacity opacity-0"></div>
        <div class="flex min-h-full items-center justify-center p-4 text-center sm:p-0">
            <div class="modal-content relative transform overflow-hidden rounded-2xl bg-white text-left shadow-xl transition-all sm:my-8 sm:w-full sm:max-w-lg opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95" id="modal-panel">
                <div class="bg-white px-4 pb-4 pt-5 sm:p-6 sm:pb-4">
                    <h3 class="text-xl font-bold leading-6 text-slate-900 mb-4" id="modal-title" data-i18n="privacyTitle">Privacy Policy</h3>
                    <div class="mt-2 text-sm text-slate-600 space-y-3 leading-relaxed" data-i18n="privacyContent" data-i18n-html="true"></div>
                </div>
                <div class="bg-gray-50 px-4 py-3 sm:flex sm:flex-row-reverse sm:px-6">
                    <button type="button" id="modal-close-btn" class="inline-flex w-full justify-center rounded-lg bg-blue-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-blue-50 sm:ml-3 sm:w-auto transition-colors" data-i18n="closeBtn">Close</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        /**
         * 4x25 Application
         * Architecture: App.State -> App.Logic -> App.UI -> App.Utils
         */
        const App = (() => {

            // --- 1. CONFIG & DATA ---
            const Config = {
                TARGET_PERCENT: 25,
                MIN_THRESHOLD: 5,
                MAX_THRESHOLD: 15,
                MAX_DIGITS: 8, // Limit to 8 digits (99,999,999)
                DEBOUNCE_DELAY: 150, // ms
                
                // Constants for formatting logic to avoid magic numbers
                FORMAT: {
                    SCIENTIFIC_THRESHOLD: 1e15,
                    COMPACT_THRESHOLD: 1000000
                },

                /** @type {AssetConfig[]} */
                ASSETS: [
                    { key: 'stocks', color: '#3B82F6', tailwindColor: 'bg-blue-500' },
                    { key: 'bonds', color: '#8B5CF6', tailwindColor: 'bg-violet-500' },
                    { key: 'cash', color: '#10B981', tailwindColor: 'bg-emerald-500' },
                    { key: 'gold', color: '#F59E0B', tailwindColor: 'bg-amber-500' }
                ]
            };

            const Translations = {
                zh: {
                    currencyCode: 'CNY',
                    subtitle: "4x25 æ°¸ä¹…æŠ•èµ„ç»„åˆç­–ç•¥å·¥å…· Â· FIRE è´¢åŠ¡è‡ªç”±è®¡ç®—å™¨", 
                    thresholdLabel: "å†å¹³è¡¡é˜ˆå€¼: Â±",
                    inputTitle: "ğŸ’° å½“å‰æŒä»“è¾“å…¥",
                    totalValue: "æ€»èµ„äº§ä»·å€¼",
                    rebalanceTitle: "ğŸ”„ å†å¹³è¡¡æ“ä½œå»ºè®®",
                    targetLabel: `ç›®æ ‡å æ¯”: ${Config.TARGET_PERCENT}%`,
                    colAsset: "èµ„äº§",
                    colCurrent: "å½“å‰å æ¯”",
                    colTarget: "ç›®æ ‡é‡‘é¢",
                    colAction: "æ“ä½œ",
                    fireTitle: "FIRE 4% æ³•åˆ™é¢„è§ˆ",
                    fireYear: "å¯æ”¯æŒå¹´æ”¯å‡º",
                    fireMonth: "å¯æ”¯æŒæœˆæ”¯å‡º",
                    stocks: "è‚¡ç¥¨ (Stocks)",
                    bonds: "é•¿æœŸå›½å€º (Bonds)",
                    cash: "ç°é‡‘/çŸ­å€º (Cash)",
                    gold: "é»„é‡‘ (Gold)",
                    buy: "ä¹°å…¥",
                    sell: "å–å‡º",
                    hold: "ä¿æŒ", 
                    statusEmptyTitle: "è¯·è¾“å…¥æŒä»“é‡‘é¢",
                    statusEmptyDesc: "è¯·åœ¨å·¦ä¾§è¾“å…¥å„é¡¹èµ„äº§çš„å½“å‰ä»·å€¼ä»¥å¼€å§‹è®¡ç®—ã€‚æœªå¡«å†™çš„é¡¹ç›®å°†é»˜è®¤ä¸º 0ã€‚",
                    statusHealthyTitle: "æŠ•èµ„ç»„åˆå¤„äºå¥åº·åŒºé—´",
                    statusHealthyDesc: "æ‰€æœ‰èµ„äº§å‡åœ¨ç›®æ ‡åŒºé—´å†…ï¼Œæ— éœ€æ“ä½œã€‚",
                    statusActionTitle: "å»ºè®®è¿›è¡Œå†å¹³è¡¡",
                    statusActionDesc: "æ£€æµ‹åˆ°æœ‰èµ„äº§åç¦»ç›®æ ‡é…ç½®è¶…è¿‡ {threshold}% (å³ <{min}% æˆ– >{max}%)ã€‚",
                    statusActionNote: "è¯´æ˜ï¼šé»˜è®¤ç­–ç•¥ä¸ºå°†æ‰€æœ‰èµ„äº§å›å½’è‡³å„ 25%ã€‚",
                    fireRuleTitle: "å…³äº 4% æ³•åˆ™",
                    fireRuleText: "æºè‡ª<b>ä¸‰ä¸€å­¦é™¢ç ”ç©¶</b>ã€‚æ ¸å¿ƒè§‚ç‚¹ï¼šè‹¥æ¯å¹´æå–åˆå§‹èµ„é‡‘çš„ <b>4%</b> ä½œä¸ºç”Ÿæ´»è´¹ï¼ˆå¹¶éšé€šèƒ€è°ƒæ•´ï¼‰ï¼Œèµ„é‡‘å¤§æ¦‚ç‡èƒ½ç»´æŒ 30 å¹´ä»¥ä¸Šã€‚è¿™æ„å‘³ç€ï¼šå½“<b>æ€»èµ„äº§ = å¹´æ”¯å‡º Ã— 25</b> æ—¶ï¼Œç†è®ºä¸Šå·²è¾¾æˆè´¢åŠ¡è‡ªç”±ã€‚",
                    introTitle: "ä»€ä¹ˆæ˜¯æ°¸ä¹…æŠ•èµ„ç»„åˆï¼Ÿ",
                    introText: `<p class="mb-4">æ°¸ä¹…æŠ•èµ„ç»„åˆï¼ˆPermanent Portfolioï¼‰æ˜¯ç”±å“ˆåˆ©Â·å¸ƒæœ—ï¼ˆHarry Browneï¼‰æå‡ºçš„æŠ•èµ„ç­–ç•¥ï¼Œæ—¨åœ¨æ— è®ºç»æµçŠ¶å†µå¦‚ä½•ï¼ˆç¹è£ã€é€šç¼©ã€é€šèƒ€æˆ–æ»èƒ€ï¼‰ï¼Œéƒ½èƒ½ä¿æŠ¤å¹¶å¢å€¼ä½ çš„è´¢å¯Œã€‚</p><p class="mb-4">å…¶æ ¸å¿ƒç†å¿µæå…¶ç®€å•ï¼šå°†èµ„äº§å¹³åˆ†ä¸ºå››ç­‰ä»½ï¼ˆå„${Config.TARGET_PERCENT}%ï¼‰ï¼š<strong>è‚¡ç¥¨</strong>ï¼ˆåº”å¯¹ç¹è£ï¼‰ã€<strong>é•¿æœŸå›½å€º</strong>ï¼ˆåº”å¯¹é€šç¼©ï¼‰ã€<strong>ç°é‡‘/çŸ­å€º</strong>ï¼ˆåº”å¯¹è¡°é€€/ç´§ç¼©ï¼‰ã€<strong>é»„é‡‘</strong>ï¼ˆåº”å¯¹é€šèƒ€ï¼‰ã€‚</p><p>ä½ åªéœ€è¦å®šæœŸæ£€æŸ¥ï¼Œå¦‚æœæŸé¡¹èµ„äº§å æ¯”åç¦» ${Config.TARGET_PERCENT}% å¤ªå¤šï¼ˆä¾‹å¦‚è¶…è¿‡è®¾å®šçš„é˜ˆå€¼ï¼‰ï¼Œå°±è¿›è¡Œâ€œå†å¹³è¡¡â€ï¼šå–å‡ºæ¶¨å¾—å¤šçš„ï¼Œä¹°å…¥è·Œå¾—å¤šçš„ï¼Œä½¿å…¶å›åˆ° ${Config.TARGET_PERCENT}%ã€‚</p>`,
                    faqTitle: "å¸¸è§é—®é¢˜ (FAQ)",
                    faqData: [
                        { 
                            question: "ä¸ºä»€ä¹ˆå« 4x25?", 
                            answer: [
                                "è¿™æ˜¯ä¸€ä¸ªåŒå…³å«ä¹‰ï¼š",
                                "1. æ°¸ä¹…æŠ•èµ„ç»„åˆï¼š4ç§èµ„äº§ï¼Œå„å  25%ã€‚",
                                "2. FIRE è¿åŠ¨ï¼š4% æ³•åˆ™ï¼Œæ„å‘³ç€ä½ éœ€è¦å­˜å¤Ÿå¹´æ”¯å‡ºçš„ 25 å€ã€‚"
                            ]
                        },
                        {
                            question: "å†å²å¹´åŒ–æ”¶ç›Šç‡å¤§æ¦‚æ˜¯å¤šå°‘ï¼Ÿ",
                            answer: [
                                "è™½ç„¶ã€Šæ°¸ä¹…æŠ•èµ„ç»„åˆã€‹ä¸€ä¹¦ï¼ˆå…‹é›·æ ¼Â·ç½—å…°ç­‰è‘—ï¼‰æŒ‡å‡ºè¯¥ç­–ç•¥åœ¨è¿‡å» 40 å¹´ï¼ˆåŸºäºç¾å›½å¸‚åœºï¼‰çš„å¹´åŒ–å›æŠ¥ç‡çº¦ä¸º 9-10%ã€‚",
                                "ä½†è€ƒè™‘åˆ°æœªæ¥çš„ä¸ç¡®å®šæ€§åŠä¸åŒçš„ç»æµå‘¨æœŸï¼Œæˆ‘ä»¬è®¤ä¸º 6% - 8% æ˜¯ä¸€ä¸ªæ›´åŠ¡å®ã€æ›´ç¨³å¥çš„é•¿æœŸé¢„æœŸåŒºé—´ã€‚",
                                "å› æ­¤ï¼Œæœ¬è®¡ç®—å™¨é»˜è®¤é‡‡ç”¨ 6.8% è¿›è¡Œæ¨æ¼”â€”â€”æˆ‘ä»¬åœ¨è¿½æ±‚å¢é•¿ä¹‹å‰ï¼Œé¦–å…ˆè¦ç¡®ä¿é¢„æœŸçš„å®‰å…¨æ€§ã€‚"
                            ]
                        },
                        { 
                            question: "å†å¹³è¡¡çš„é˜ˆå€¼è®¾ä¸ºå¤šå°‘æ¯”è¾ƒå¥½?", 
                            answer: [
                                "å“ˆåˆ©Â·å¸ƒæœ—å»ºè®®ä½¿ç”¨ 15/35 é¢‘å¸¦ï¼Œå³å½“æŸé¡¹èµ„äº§è·Œç ´ 15% æˆ–æ¶¨è¶… 35% æ—¶è§¦å‘å†å¹³è¡¡ï¼ˆç›¸å½“äº Â±10% çš„é˜ˆå€¼ï¼‰ã€‚",
                                "æœ¬è®¡ç®—å™¨é»˜è®¤è®¾ç½®ä¸º Â±10%ï¼Œä½ å¯ä»¥æ ¹æ®è‡ªå·±çš„é£é™©åå¥½åœ¨é¡¶éƒ¨è°ƒæ•´ã€‚"
                            ]
                        }
                    ],
                    privacy: "éšç§æ”¿ç­–",
                    disclaimer: "å…è´£å£°æ˜ï¼šæœ¬å·¥å…·ä»…ä¾›å‚è€ƒï¼Œä¸æ„æˆä»»ä½•è´¢åŠ¡å»ºè®®ã€‚",
                    privacyTitle: "éšç§æ”¿ç­–",
                    privacyContent: `<p><strong>1. æ•°æ®å®‰å…¨ï¼ˆæœ¬åœ°è®¡ç®—ï¼‰</strong><br>æœ¬ç½‘ç«™æ˜¯ä¸€ä¸ªçº¯å‰ç«¯åº”ç”¨ã€‚æ‰€æœ‰è´¢åŠ¡è®¡ç®—å‡åœ¨æ‚¨çš„æµè§ˆå™¨æœ¬åœ°å®Œæˆã€‚æˆ‘ä»¬æ²¡æœ‰åç«¯æœåŠ¡å™¨ï¼Œä¹Ÿä¸ä¼šæ”¶é›†ã€å­˜å‚¨æˆ–ä¼ è¾“æ‚¨çš„ä»»ä½•è´¢åŠ¡æ•°æ®ã€‚</p><p><strong>2. ç»Ÿè®¡åˆ†æä¸ Cookie</strong><br>æˆ‘ä»¬ä½¿ç”¨ Google Analyticsï¼ˆè°·æ­Œåˆ†æï¼‰æ¥æ”¶é›†åŒ¿åçš„ç½‘ç«™è®¿é—®ç»Ÿè®¡æ•°æ®ï¼ˆå¦‚è®¿é—®é‡ã€åœç•™æ—¶é—´ï¼‰ï¼Œä»¥å¸®åŠ©æˆ‘ä»¬æ”¹è¿›ç½‘ç«™ã€‚è¿™å¯èƒ½ä¼šåœ¨æ‚¨çš„è®¾å¤‡ä¸Šå­˜å‚¨ Cookieã€‚è¯·æ”¾å¿ƒï¼Œæ‚¨çš„å…·ä½“è´¢åŠ¡è¾“å…¥æ•°æ®ç»ä¸ä¼šè¢«å‘é€ç»™ Googleã€‚</p><p class="text-xs text-gray-400 mt-4">æœ€åæ›´æ–°æ—¥æœŸï¼š2026å¹´1æœˆ6æ—¥</p>`,
                    closeBtn: "å…³é—­",
                    projTitle: "è´¢å¯Œå˜åŒ–æ¨æ¼”",
                    modeSaving: "å®šæŠ•ç§¯ç´¯",
                    modeSpending: "ææ¬¾æ¶ˆè´¹",
                    projCurrent: "å½“å‰æ€»èµ„äº§",
                    projRate: "å¹´åŒ–æ”¶ç›Šç‡ (0-100)",
                    projYears: "æ¨æ¼”å¹´é™ (1-100)",
                    projContribution: "æ¯å¹´å®šæŠ•é‡‘é¢",
                    projExpense: "æ¯å¹´è®¡åˆ’å¼€é”€",
                    projResultLabel: "æœªæ¥æ€»èµ„äº§",
                    projGain: "ç´¯è®¡æ”¶ç›Š",
                    projNote: "æ³¨ï¼šæ¨æ¼”ç»“æœä¸ºåä¹‰é‡‘é¢ï¼Œæœªæ‰£é™¤é€šè´§è†¨èƒ€/é€šç¼©å¯¹è´­ä¹°åŠ›çš„å®é™…å½±å“ã€‚",
                    rebalanceNote: "æ³¨ï¼šå»ºè®®æ“ä½œé‡‘é¢ä¸ºç†è®ºå€¼ï¼Œæœªè€ƒè™‘äº¤æ˜“æ‰‹ç»­è´¹åŠç¨åŠ¡ï¼ˆå¦‚èµ„æœ¬åˆ©å¾—ç¨ï¼‰å½±å“ã€‚"
                },
                en: {
                    currencyCode: 'USD',
                    subtitle: "4x25 Strategy & FIRE Tool Â· Permanent Portfolio Calculator",
                    thresholdLabel: "Threshold: Â±",
                    inputTitle: "ğŸ’° Current Holdings",
                    totalValue: "Total Value",
                    rebalanceTitle: "ğŸ”„ Rebalancing Suggestions",
                    targetLabel: `Target: ${Config.TARGET_PERCENT}%`,
                    colAsset: "Asset",
                    colCurrent: "Current %",
                    colTarget: "Target Value",
                    colAction: "Action",
                    fireTitle: "FIRE 4% Rule Preview",
                    fireYear: "Safe Annual Withdrawal",
                    fireMonth: "Safe Monthly Withdrawal",
                    stocks: "Stocks",
                    bonds: "Long-Term Bonds",
                    cash: "Cash / T-Bills",
                    gold: "Gold",
                    buy: "Buy",
                    sell: "Sell",
                    hold: "Hold",
                    statusEmptyTitle: "Enter Your Holdings",
                    statusEmptyDesc: "Please input the current value of your assets. Empty fields will be treated as 0.",
                    statusHealthyTitle: "Portfolio is Healthy",
                    statusHealthyDesc: "All assets are within the target allocation range.",
                    statusActionTitle: "Rebalancing Recommended",
                    statusActionDesc: "Assets detected deviating by more than {threshold}% (i.e., <{min}% or >{max}%).",
                    statusActionNote: "Note: Defaults to rebalancing to 25% each.",
                    fireRuleTitle: "About the 4% Rule",
                    fireRuleText: "Derived from the <b>Trinity Study</b>. It suggests that if you withdraw <b>4%</b> of your portfolio annually (adjusted for inflation), your money has a high probability of lasting 30+ years. You are 'FIRE' when <b>Assets = 25 Ã— Annual Expenses</b>.",
                    introTitle: "What is the Permanent Portfolio?",
                    introText: `<p class="mb-4">The Permanent Portfolio is an investment strategy invented by Harry Browne, designed to preserve and grow your wealth under any condition.</p><p class="mb-4">The core concept is simple: divide your assets equally into four parts (${Config.TARGET_PERCENT}% each): <strong>Stocks</strong>, <strong>Long-Term Bonds</strong>, <strong>Cash</strong>, and <strong>Gold</strong>.</p><p>You simply check it regularly. If an asset deviates too far from ${Config.TARGET_PERCENT}% (beyond your set threshold), you "rebalance": sell the winners and buy the losers to get back to ${Config.TARGET_PERCENT}%.</p>`,
                    faqTitle: "Frequently Asked Questions (FAQ)",
                    faqData: [
                        { 
                            question: "Why 4x25?", 
                            answer: [
                                "It's a double meaning:",
                                "1. Permanent Portfolio: 4 assets at 25% each.",
                                "2. FIRE Movement: The 4% Rule implies saving 25 times your annual expenses."
                            ]
                        },
                        {
                            question: "What is the historical annual return?",
                            answer: [
                                "Books on the Permanent Portfolio (like Craig Rowland's) cite historical returns of around 9-10% (based on 40 years of US market data).",
                                "However, past performance does not guarantee future results. A range of 6-8% is generally considered a more realistic and conservative estimate for long-term planning.",
                                "This calculator defaults to 6.8% to prioritize safety in your projections."
                            ]
                        },
                        { 
                            question: "What is the best rebalancing threshold?", 
                            answer: [
                                "Harry Browne recommended using a 15/35 band. This means you rebalance only when an asset drops below 15% or rises above 35% (which equals a Â±10% threshold).",
                                "This calculator defaults to Â±10%, but you can adjust it at the top based on your risk tolerance."
                            ]
                        }
                    ],
                    privacy: "Privacy Policy",
                    disclaimer: "Disclaimer: This tool is for informational purposes only and does not constitute financial advice.",
                    privacyTitle: "Privacy Policy",
                    privacyContent: `<p><strong>1. Data Security (Local Processing)</strong><br>This is a client-side application. All financial calculations are performed locally in your browser. We do not have a backend server, and we do not collect, store, or transmit any of your financial data.</p><p><strong>2. Analytics & Cookies</strong><br>We use Google Analytics to collect anonymous usage statistics (e.g., page views) to help us improve the website. This service uses cookies. Your personal financial inputs are <strong>never</strong> sent to Google.</p><p class="text-xs text-gray-400 mt-4">Last Updated: January 6, 2026</p>`,
                    closeBtn: "Close",
                    projTitle: "Wealth Simulation",
                    modeSaving: "Saving",
                    modeSpending: "Spending",
                    projCurrent: "Current Assets",
                    projRate: "Return % (0-100)",
                    projYears: "Years (1-100)",
                    projContribution: "Annual Contribution",
                    projExpense: "Annual Expense",
                    projResultLabel: "Future Total Assets",
                    projGain: "Total Gain",
                    projNote: "Note: Projections are nominal values and do not account for inflation or deflation effects.",
                    rebalanceNote: "Note: Suggested actions are theoretical and do not account for transaction fees or tax implications."
                }
            };

            // --- 2. UTILS ---
            const Utils = {
                debounce: (func, wait) => {
                    let timeout;
                    return function(...args) {
                        const context = this;
                        clearTimeout(timeout);
                        timeout = setTimeout(() => func.apply(context, args), wait);
                    };
                },
                sanitizeInput: (value) => {
                    let clean = value.replace(/[^\d]/g, '');
                    if (clean.length > 1 && clean.startsWith('0')) clean = clean.replace(/^0+/, '');
                    if (clean.length > Config.MAX_DIGITS) clean = clean.slice(0, Config.MAX_DIGITS);
                    return clean;
                },
                sanitizeInteger: (value, max) => {
                    let clean = value.replace(/\D/g, ''); 
                    if (clean.length > 1 && clean.startsWith('0')) clean = clean.replace(/^0+/, '');
                    if (clean === '') return '';
                    if (parseInt(clean) > max) return String(max);
                    return clean;
                },
                sanitizeDecimal: (value, maxVal) => {
                    let clean = value.replace(/[^0-9.]/g, '');
                    const parts = clean.split('.');
                    if (parts.length > 2) clean = parts[0] + '.' + parts.slice(1).join('');
                    if (parts.length === 2 && parts[1].length > 1) clean = parts[0] + '.' + parts[1].substring(0, 1);
                    if (parseFloat(clean) > maxVal) return String(maxVal);
                    return clean;
                },
                formatMoney: (num, lang, isCompact, includeCurrency = true) => {
                    const currencyCode = Translations[lang].currencyCode;
                    const locale = lang === 'zh' ? 'zh-CN' : 'en-US';
                    
                    if (!Number.isFinite(num)) return '---';

                    if (Math.abs(num) > Config.FORMAT.SCIENTIFIC_THRESHOLD) {
                        return new Intl.NumberFormat(locale, {
                            style: includeCurrency ? 'currency' : 'decimal',
                            currency: currencyCode,
                            notation: 'scientific',
                            maximumFractionDigits: 2
                        }).format(num);
                    }

                    const useCompact = isCompact && Math.abs(num) > Config.FORMAT.COMPACT_THRESHOLD; 
                    return new Intl.NumberFormat(locale, {
                        style: includeCurrency ? 'currency' : 'decimal',
                        currency: currencyCode,
                        notation: useCompact ? 'compact' : 'standard',
                        maximumFractionDigits: useCompact ? 2 : 0
                    }).format(num);
                },
                
                // NEW: Animate number transition
                animateTo: (el, endValue, lang, isCompact = false, includeCurrency = true) => {
                    if (!el) return;
                    
                    // Get start value from data attribute or default to 0
                    const startValue = parseFloat(el.dataset.currentValue || '0');
                    
                    // If no change, just return (but ensure text is formatted)
                    if (startValue === endValue) {
                        el.textContent = Utils.formatMoney(endValue, lang, isCompact, includeCurrency);
                        return;
                    }

                    // Cancel previous animation if exists
                    if (el.animationFrame) cancelAnimationFrame(el.animationFrame);

                    const duration = 800; // ms
                    const startTime = performance.now();

                    const step = (currentTime) => {
                        const elapsed = currentTime - startTime;
                        const progress = Math.min(elapsed / duration, 1);

                        // Ease-out expo: starts fast, slows down at the end
                        const ease = progress === 1 ? 1 : 1 - Math.pow(2, -10 * progress);
                        
                        const current = startValue + (endValue - startValue) * ease;

                        // Render intermediate value
                        el.textContent = Utils.formatMoney(current, lang, isCompact, includeCurrency);

                        if (progress < 1) {
                            el.animationFrame = requestAnimationFrame(step);
                        } else {
                            // Ensure final value is exact
                            el.textContent = Utils.formatMoney(endValue, lang, isCompact, includeCurrency);
                            el.dataset.currentValue = endValue; // Store new value
                        }
                    };

                    el.animationFrame = requestAnimationFrame(step);
                },

                setText: (el, text) => { if (el && el.textContent !== text) el.textContent = text; },
                setHtml: (el, html) => {
                    if (!el) return;
                    const template = document.createElement('template');
                    template.innerHTML = html.trim();
                    el.replaceChildren(template.content);
                },
                setClass: (el, cls) => { if (el && el.className !== cls) el.className = cls; },
                roundTo2: (num) => Math.round((num + Number.EPSILON) * 100) / 100
            };

            // --- 3. STATE MANAGEMENT ---
            
            /** @type {AppState} */
            const State = {
                lang: 'en',
                threshold: 10,
                holdings: { stocks: 0, bonds: 0, cash: 0, gold: 0 },
                projection: {
                    mode: 'saving',
                    principal: '',
                    rate: '6.8',
                    years: 10,
                    flow: ''
                },
                
                debouncedCalc: null,

                init() {
                    this.debouncedCalc = Utils.debounce(() => {
                        this.performCalculation();
                    }, Config.DEBOUNCE_DELAY);
                },

                setLang(l) { this.lang = l; UI.renderAll(); },
                setThreshold(t) { 
                    if (t >= Config.MIN_THRESHOLD && t <= Config.MAX_THRESHOLD) {
                        this.threshold = t; 
                        UI.updateThresholdDisplay();
                        this.triggerCalc();
                    }
                },
                updateHolding(key, valueStr) {
                    const val = parseInt(valueStr.replace(/[^\d]/g, ''), 10);
                    this.holdings[key] = isNaN(val) ? 0 : val;
                    this.triggerCalc();
                },
                setProjMode(mode) {
                    this.projection.mode = mode;
                    UI.renderProjectionUI();
                    this.triggerCalc();
                },
                
                triggerCalc() {
                    if (this.debouncedCalc) {
                        this.debouncedCalc();
                    }
                },

                performCalculation() {
                    requestAnimationFrame(() => {
                        const results = Logic.calculatePortfolio(this.holdings, this.threshold);
                        UI.renderResults(results);
                        
                        const projResults = Logic.calculateProjection(
                            this.projection.principal, 
                            this.projection.rate, 
                            this.projection.years, 
                            this.projection.flow, 
                            this.projection.mode
                        );
                        UI.renderProjectionResult(projResults);
                    });
                }
            };

            // --- 4. CORE LOGIC ---
            const Logic = {
                calculatePortfolio: (holdings, threshold) => {
                    const total = Object.values(holdings).reduce((a, b) => a + b, 0);
                    const baseTarget = Math.floor(total / 4);
                    const remainder = total % 4;
                    const assetKeys = Config.ASSETS.map(a => a.key);
                    
                    let globalBreach = false;
                    const assetsData = assetKeys.map((key, index) => {
                        const value = holdings[key];
                        const target = baseTarget + (index < remainder ? 1 : 0);
                        const percent = total === 0 ? 0 : (value / total) * 100;
                        const diff = target - value;
                        const isBreached = total > 0 && (percent > (Config.TARGET_PERCENT + threshold) || percent < (Config.TARGET_PERCENT - threshold));
                        if (isBreached) globalBreach = true;

                        return { key, value, target, percent, diff, isBreached };
                    });

                    return { total, assetsData, globalBreach };
                },

                calculateProjection: (principalStr, rateStr, yearsStr, flowStr, mode) => {
                    const safeReturn = { futureValue: 0, gain: 0 };

                    if (rateStr === '' || yearsStr === '') return safeReturn;

                    const principal = parseFloat(String(principalStr).replace(/[^\d]/g, '')) || 0;
                    
                    let rawRate = parseFloat(rateStr);
                    if (!Number.isFinite(rawRate)) rawRate = 0;
                    if (rawRate > 100) rawRate = 100;
                    if (rawRate < 0) rawRate = 0;
                    const rate = rawRate / 100;
                    
                    let years = parseFloat(yearsStr) || 0;
                    if (!Number.isFinite(years)) years = 0;
                    if (years > 100) years = 100;

                    let flow = parseFloat(String(flowStr).replace(/[^\d]/g, '')) || 0;
                    if (mode === 'spending') flow = -flow;

                    let futureValue = 0;
                    if (rate === 0) {
                        futureValue = principal + (flow * years);
                    } else {
                        const fvPrincipal = principal * Math.pow(1 + rate, years);
                        const fvAnnuityEOY = flow * (Math.pow(1 + rate, years) - 1) / rate;
                        const fvAnnuityAvg = fvAnnuityEOY * (1 + rate / 2);
                        futureValue = fvPrincipal + fvAnnuityAvg;
                    }

                    if (!Number.isFinite(futureValue)) return safeReturn;
                    if (futureValue < 0) futureValue = 0;
                    
                    const totalInvested = principal + (flow * years);
                    const gain = futureValue - totalInvested;

                    return { 
                        futureValue: Utils.roundTo2(futureValue), 
                        gain: Utils.roundTo2(gain) 
                    };
                }
            };

            // --- 5. UI LAYER ---
            const UI = {
                els: {
                    assetInputs: {},
                    assetLabels: {},
                    assetLegends: {},
                    chartCircles: {} 
                },
                lastFocusedElement: null,
                
                init() {
                    State.init();
                    this.cacheDOM();
                    this.renderInputs(); 
                    this.cacheDynamicDOM(); 
                    this.renderLegend();
                    this.cacheLegendDOM(); 
                    this.bindEvents();
                    this.renderAll();
                },

                cacheDOM() {
                    this.els = {
                        ...this.els,
                        inputsContainer: document.getElementById('inputs-container'),
                        resultBody: document.getElementById('result-body'),
                        legendContainer: document.getElementById('legend-container'),
                        totalValue: document.getElementById('total-value'),
                        fireYear: document.getElementById('fire-year'),
                        fireMonth: document.getElementById('fire-month'),
                        statusCard: document.getElementById('status-card'),
                        statusIcon: document.getElementById('status-icon'),
                        statusTitle: document.getElementById('status-title'),
                        statusDesc: document.getElementById('status-desc'),
                        statusNote: document.getElementById('status-note'),
                        thresholdDisplay: document.getElementById('threshold-display'),
                        btnMinus: document.getElementById('btn-minus'),
                        btnPlus: document.getElementById('btn-plus'),
                        btnEn: document.getElementById('btn-en'),
                        btnZh: document.getElementById('btn-zh'),
                        faqContainer: document.getElementById('faq-container'),
                        currencySymbols: document.querySelectorAll('.currency-symbol'),
                        i18nElements: document.querySelectorAll('[data-i18n]'),
                        privacyModal: document.getElementById('privacy-modal'),
                        modalOverlay: document.querySelector('.modal-overlay'),
                        modalCloseBtn: document.getElementById('modal-close-btn'),
                        modalContent: document.querySelector('.modal-content'),
                        appContainer: document.getElementById('app'),
                        projPrincipal: document.getElementById('proj-principal'),
                        projRate: document.getElementById('proj-rate'),
                        projYears: document.getElementById('proj-years'),
                        projFlow: document.getElementById('proj-flow'),
                        projResult: document.getElementById('proj-result'),
                        projGain: document.getElementById('proj-gain'),
                        projFlowLabel: document.getElementById('proj-flow-label'),
                        modeSavingBtn: document.getElementById('mode-saving'),
                        modeSpendingBtn: document.getElementById('mode-spending'),
                    };
                },

                renderInputs() {
                    const fragment = document.createDocumentFragment();
                    Config.ASSETS.forEach(asset => {
                        const div = document.createElement('div');
                        div.innerHTML = `
                            <label class="block text-sm font-medium text-gray-700 mb-1.5" id="label-${asset.key}" for="input-${asset.key}"></label>
                            <div class="relative">
                                <span class="currency-symbol absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 font-bold select-none"></span>
                                <input type="text" inputmode="numeric" pattern="[0-9]*" maxlength="${Config.MAX_DIGITS}"
                                    id="input-${asset.key}" placeholder="0" 
                                    class="asset-input w-full pl-8 pr-4 py-3 bg-gray-50 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none font-mono text-lg placeholder-gray-300 transition-shadow">
                            </div>
                        `;
                        fragment.appendChild(div);
                    });
                    this.els.inputsContainer.appendChild(fragment);
                },

                cacheDynamicDOM() {
                    Config.ASSETS.forEach(asset => {
                        this.els.assetInputs[asset.key] = document.getElementById(`input-${asset.key}`);
                        this.els.assetLabels[asset.key] = document.getElementById(`label-${asset.key}`);
                        this.els.chartCircles[asset.key] = document.getElementById(`chart-${asset.key}`);
                    });
                },

                renderLegend() {
                    const fragment = document.createDocumentFragment();
                    Config.ASSETS.forEach(asset => {
                        const div = document.createElement('div');
                        div.className = "flex items-center gap-3";
                        div.innerHTML = `
                            <span class="w-3 h-3 rounded-full ${asset.tailwindColor} flex-shrink-0 shadow-sm"></span>
                            <span class="text-sm font-medium text-slate-600" id="legend-${asset.key}"></span>
                        `;
                        fragment.appendChild(div);
                    });
                    this.els.legendContainer.appendChild(fragment);
                },

                cacheLegendDOM() {
                    Config.ASSETS.forEach(asset => {
                        this.els.assetLegends[asset.key] = document.getElementById(`legend-${asset.key}`);
                    });
                },

                bindEvents() {
                    this.els.btnEn.onclick = () => State.setLang('en');
                    this.els.btnZh.onclick = () => State.setLang('zh');
                    this.els.btnMinus.onclick = () => State.setThreshold(State.threshold - 1);
                    this.els.btnPlus.onclick = () => State.setThreshold(State.threshold + 1);
                    
                    document.getElementById('btn-privacy').onclick = (e) => this.openModal(e.target);
                    this.els.modalCloseBtn.onclick = () => this.closeModal();
                    this.els.modalOverlay.onclick = () => this.closeModal();
                    this.els.privacyModal.onkeydown = (e) => { if(e.key === "Escape") this.closeModal(); };

                    this.els.faqContainer.onclick = (e) => {
                        const btn = e.target.closest('button[data-faq-toggle]');
                        if (btn) this.toggleFaq(btn);
                    };

                    Config.ASSETS.forEach(asset => {
                        const input = this.els.assetInputs[asset.key];
                        if (input) {
                            input.oninput = (e) => {
                                const clean = Utils.sanitizeInput(e.target.value);
                                if (e.target.value !== clean) e.target.value = clean;
                                State.updateHolding(asset.key, clean);
                            };
                        }
                    });

                    const bindInputSync = (element, stateKey, sanitizer) => {
                        if (!element) return;
                        element.oninput = (e) => {
                            const clean = sanitizer(e.target.value);
                            if (e.target.value !== clean) e.target.value = clean;
                            State.projection[stateKey] = clean;
                            State.triggerCalc();
                        };
                    };

                    bindInputSync(this.els.projPrincipal, 'principal', Utils.sanitizeInput);
                    bindInputSync(this.els.projFlow, 'flow', Utils.sanitizeInput);
                    
                    bindInputSync(this.els.projRate, 'rate', (val) => Utils.sanitizeDecimal(val, 100));
                    bindInputSync(this.els.projYears, 'years', (val) => Utils.sanitizeInteger(val, 100));

                    this.els.modeSavingBtn.onclick = () => State.setProjMode('saving');
                    this.els.modeSpendingBtn.onclick = () => State.setProjMode('spending');
                },

                renderResults(data) {
                    const t = Translations[State.lang];
                    const { total, assetsData, globalBreach } = data;

                    // ANIMATION APPLIED HERE:
                    Utils.animateTo(this.els.totalValue, total, State.lang, true);
                    Utils.animateTo(this.els.fireYear, total * 0.04, State.lang, true);
                    Utils.animateTo(this.els.fireMonth, total * 0.04 / 12, State.lang, true);

                    let statusClass, icon, title, desc, showNote;
                    const allZero = total === 0; 

                    if (allZero) {
                        statusClass = "bg-blue-50 border-blue-500 text-blue-900";
                        icon = "âš–ï¸";
                        title = t.statusEmptyTitle;
                        desc = t.statusEmptyDesc;
                        showNote = false;
                    } else if (globalBreach) {
                        statusClass = "bg-amber-50 border-amber-500 text-amber-900";
                        icon = "âš ï¸";
                        title = t.statusActionTitle;
                        desc = t.statusActionDesc.replace('{threshold}', State.threshold)
                                .replace('{min}', Config.TARGET_PERCENT - State.threshold)
                                .replace('{max}', Config.TARGET_PERCENT + State.threshold);
                        showNote = true;
                    } else {
                        statusClass = "bg-emerald-50 border-emerald-500 text-emerald-900";
                        icon = "âœ…";
                        title = t.statusHealthyTitle;
                        desc = t.statusHealthyDesc;
                        showNote = false;
                    }
                    
                    Utils.setClass(this.els.statusCard, `rounded-2xl p-6 border-l-4 shadow-sm transition-all ${statusClass}`);
                    Utils.setText(this.els.statusIcon, icon);
                    Utils.setText(this.els.statusTitle, title);
                    Utils.setText(this.els.statusDesc, desc);
                    Utils.setText(this.els.statusNote, t.statusActionNote);
                    Utils.setClass(this.els.statusNote, showNote ? "mt-2 text-xs opacity-75" : "hidden");

                    this.els.resultBody.innerHTML = '';
                    let chartOffset = 0;

                    assetsData.forEach(asset => {
                        const circle = this.els.chartCircles[asset.key];
                        
                        if (allZero) {
                            circle.style.strokeDasharray = `0 100`;
                        } else {
                            circle.style.strokeDasharray = `${asset.percent} 100`;
                            circle.style.strokeDashoffset = -chartOffset;
                            chartOffset += asset.percent;
                        }

                        const tr = document.createElement('tr');
                        tr.className = "hover:bg-gray-50 transition-colors";
                        
                        let actionHtml = '';
                        if (allZero) {
                            actionHtml = `<span class="text-gray-300 text-lg font-bold select-none">-</span>`;
                        } else if (globalBreach) {
                            if (Math.abs(asset.diff) > 0) {
                                const type = asset.diff > 0 ? t.buy : t.sell;
                                const colorClass = asset.diff > 0 ? 'bg-blue-50 text-blue-700' : 'bg-orange-50 text-orange-700';
                                actionHtml = `<div class="inline-flex items-center gap-1.5 px-3 py-1 rounded-full text-sm font-bold ${colorClass} whitespace-nowrap">${type} <span class="font-mono ml-1">${Utils.formatMoney(Math.abs(asset.diff), State.lang, true, false)}</span></div>`;
                            } else {
                                actionHtml = `<span class="text-gray-400 text-sm font-medium pl-1">${t.hold}</span>`;
                            }
                        } else {
                            actionHtml = `<span class="text-gray-400 text-sm font-medium pl-1">${t.hold}</span>`;
                        }

                        const percentClass = asset.isBreached ? 'text-red-500 font-bold' : 'text-slate-600';
                        const assetConfig = Config.ASSETS.find(a => a.key === asset.key);

                        tr.innerHTML = `
                            <td class="p-3 text-left pl-4">
                                <div class="flex items-center gap-3">
                                    <div class="w-3 h-3 rounded-full flex-shrink-0" style="background-color:${assetConfig.color}"></div>
                                    <span class="font-medium text-slate-700 whitespace-nowrap">${t[asset.key]}</span>
                                </div>
                            </td>
                            <td class="p-3 text-left font-mono">
                                <span class="${percentClass}">${asset.percent.toFixed(1)}%</span>
                            </td>
                            <td class="p-3 text-left font-mono text-slate-600 table-cell-truncate" title="${Utils.formatMoney(asset.target, State.lang, true)}">${Utils.formatMoney(asset.target, State.lang, true)}</td>
                            <td class="p-3 text-left">${actionHtml}</td>
                        `;
                        this.els.resultBody.appendChild(tr);
                    });
                },

                renderProjectionUI() {
                    const t = Translations[State.lang];
                    const mode = State.projection.mode;
                    
                    if (mode === 'saving') {
                        Utils.setClass(this.els.modeSavingBtn, "px-3 py-1.5 text-xs font-bold rounded-md shadow-sm bg-white text-emerald-600 transition-all");
                        Utils.setClass(this.els.modeSpendingBtn, "px-3 py-1.5 text-xs font-bold rounded-md text-gray-500 hover:text-gray-700 transition-all");
                        Utils.setText(this.els.projFlowLabel, t.projContribution);
                    } else {
                        Utils.setClass(this.els.modeSavingBtn, "px-3 py-1.5 text-xs font-bold rounded-md text-gray-500 hover:text-gray-700 transition-all");
                        Utils.setClass(this.els.modeSpendingBtn, "px-3 py-1.5 text-xs font-bold rounded-md shadow-sm bg-white text-orange-600 transition-all");
                        Utils.setText(this.els.projFlowLabel, t.projExpense);
                    }
                },

                renderProjectionResult(data) {
                    // ANIMATION APPLIED HERE:
                    Utils.animateTo(this.els.projResult, data.futureValue, State.lang, true);
                    
                    // Gain needs special handling for color, but animateTo handles the text
                    // We can't easily animate the color change inside animateTo without making it too complex,
                    // so we set the class immediately based on the final value.
                    const gainClass = data.gain >= 0 ? 'font-mono text-emerald-600 break-all' : 'font-mono text-red-500 break-all';
                    Utils.setClass(this.els.projGain, gainClass);
                    
                    // For gain, we want to keep the + or - sign during animation if possible, 
                    // but formatMoney handles standard currency. 
                    // Let's just animate the number. The sign is part of formatMoney usually if negative, 
                    // but for positive gains we want explicit '+'.
                    
                    // Custom animation call for Gain to handle the "+" sign for positive numbers
                    const el = this.els.projGain;
                    const endValue = data.gain;
                    const startValue = parseFloat(el.dataset.currentValue || '0');
                    
                    if (startValue !== endValue) {
                         if (el.animationFrame) cancelAnimationFrame(el.animationFrame);
                         const duration = 800;
                         const startTime = performance.now();
                         const step = (currentTime) => {
                            const progress = Math.min((currentTime - startTime) / duration, 1);
                            const ease = progress === 1 ? 1 : 1 - Math.pow(2, -10 * progress);
                            const current = startValue + (endValue - startValue) * ease;
                            
                            const formatted = Utils.formatMoney(Math.abs(current), State.lang, true);
                            el.textContent = (current >= 0 ? '+' : '-') + formatted;
                            
                            if (progress < 1) el.animationFrame = requestAnimationFrame(step);
                            else {
                                el.dataset.currentValue = endValue;
                                const finalFormatted = Utils.formatMoney(Math.abs(endValue), State.lang, true);
                                el.textContent = (endValue >= 0 ? '+' : '-') + finalFormatted;
                            }
                         };
                         el.animationFrame = requestAnimationFrame(step);
                    }
                },

                updateThresholdDisplay() {
                    Utils.setText(this.els.thresholdDisplay, State.threshold);
                    this.els.btnMinus.disabled = (State.threshold <= Config.MIN_THRESHOLD);
                    this.els.btnPlus.disabled = (State.threshold >= Config.MAX_THRESHOLD);
                },

                renderAll() {
                    const lang = State.lang;
                    const t = Translations[lang];
                    
                    document.documentElement.lang = lang === 'zh' ? 'zh-CN' : 'en';
                    document.title = lang === 'en' ? "4x25 Strategy & FIRE Tool | Permanent Portfolio Calculator" : "4x25 Strategy & FIRE Tool | æ°¸ä¹…æŠ•èµ„ç»„åˆè®¡ç®—å™¨";

                    this.els.i18nElements.forEach(el => {
                        const key = el.getAttribute('data-i18n');
                        if (t[key]) {
                            if (el.dataset.i18nHtml === 'true') {
                                Utils.setHtml(el, t[key]);
                            } else {
                                Utils.setText(el, t[key]);
                            }
                        }
                    });

                    Config.ASSETS.forEach(asset => {
                        Utils.setText(this.els.assetLabels[asset.key], t[asset.key]);
                        Utils.setText(this.els.assetLegends[asset.key], t[asset.key]);
                    });

                    const symbol = new Intl.NumberFormat(lang === 'zh' ? 'zh-CN' : 'en-US', { style: 'currency', currency: t.currencyCode }).formatToParts(0).find(x => x.type === 'currency').value;
                    this.els.currencySymbols.forEach(el => Utils.setText(el, symbol));

                    this.els.faqContainer.innerHTML = '';
                    const faqFragment = document.createDocumentFragment();
                    
                    t.faqData.forEach((item, index) => {
                        const container = document.createElement('div');
                        container.className = 'border border-gray-200 rounded-xl overflow-hidden bg-white';
                        
                        const btn = document.createElement('button');
                        btn.type = 'button';
                        btn.className = 'w-full flex justify-between items-center p-4 bg-gray-50 hover:bg-gray-100 transition-colors text-left focus:outline-none';
                        btn.setAttribute('data-faq-toggle', 'true');
                        btn.setAttribute('data-index', index);
                        btn.setAttribute('aria-expanded', 'false');
                        btn.innerHTML = `<span class="font-bold text-slate-800 text-sm md:text-base">${item.question}</span><svg class="faq-icon w-5 h-5 text-slate-400 flex-shrink-0 ml-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>`;
                        
                        const content = document.createElement('div');
                        content.className = 'faq-content bg-white';
                        content.id = `faq-content-${index}`;
                        
                        const inner = document.createElement('div');
                        inner.className = 'faq-inner';
                        
                        const body = document.createElement('div');
                        body.className = 'p-4 text-sm text-slate-600 leading-relaxed border-t border-gray-100 space-y-2';
                        
                        if (Array.isArray(item.answer)) {
                            item.answer.forEach(paraText => {
                                const p = document.createElement('p');
                                p.textContent = paraText;
                                body.appendChild(p);
                            });
                        } else {
                            body.textContent = item.answer;
                        }

                        inner.appendChild(body);
                        content.appendChild(inner);
                        container.appendChild(btn);
                        container.appendChild(content);
                        faqFragment.appendChild(container);
                    });
                    this.els.faqContainer.appendChild(faqFragment);

                    // Updated button classes to include width and centering
                    Utils.setClass(this.els.btnZh, `lang-btn w-20 flex justify-center px-4 py-3 text-sm font-bold hover:bg-gray-50 transition-colors ${lang === 'zh' ? 'active' : ''}`);
                    Utils.setClass(this.els.btnEn, `lang-btn w-20 flex justify-center px-4 py-3 text-sm font-bold hover:bg-gray-50 transition-colors ${lang === 'en' ? 'active' : ''}`);

                    this.renderProjectionUI();
                    this.updateThresholdDisplay();
                    State.triggerCalc();
                },

                toggleFaq(btn) {
                    const content = btn.nextElementSibling;
                    const icon = btn.querySelector('.faq-icon');
                    const isOpen = content.classList.contains('open');
                    
                    if (isOpen) {
                        content.classList.remove('open');
                        icon.classList.remove('rotate');
                        btn.setAttribute('aria-expanded', 'false');
                    } else {
                        content.classList.add('open');
                        icon.classList.add('rotate');
                        btn.setAttribute('aria-expanded', 'true');
                    }
                },

                setInert(element, isInert) {
                    if ('inert' in HTMLElement.prototype) {
                        element.inert = isInert;
                    } else {
                        if (isInert) {
                            element.setAttribute('aria-hidden', 'true');
                            element.style.pointerEvents = 'none';
                            const focusables = element.querySelectorAll('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])');
                            focusables.forEach(el => {
                                if (!el.hasAttribute('data-original-tabindex')) {
                                    el.setAttribute('data-original-tabindex', el.getAttribute('tabindex') || '');
                                }
                                el.setAttribute('tabindex', '-1');
                            });
                        } else {
                            element.removeAttribute('aria-hidden');
                            element.style.pointerEvents = '';
                            const focusables = element.querySelectorAll('[data-original-tabindex]');
                            focusables.forEach(el => {
                                const original = el.getAttribute('data-original-tabindex');
                                if (original === '') {
                                    el.removeAttribute('tabindex');
                                } else {
                                    el.setAttribute('tabindex', original);
                                }
                                el.removeAttribute('data-original-tabindex');
                            });
                        }
                    }
                },

                openModal(triggerElement) {
                    this.lastFocusedElement = triggerElement;
                    document.body.style.overflow = 'hidden';
                    this.els.privacyModal.classList.remove('hidden');
                    
                    this.setInert(this.els.appContainer, true);
                    
                    setTimeout(() => {
                        this.els.modalOverlay.classList.remove('opacity-0');
                        this.els.modalContent.classList.remove('opacity-0', 'translate-y-4', 'sm:translate-y-0', 'sm:scale-95');
                        this.els.modalContent.classList.add('opacity-100', 'translate-y-0', 'sm:scale-100');
                        this.els.modalCloseBtn.focus();
                    }, 10);
                },

                closeModal() {
                    this.els.modalOverlay.classList.add('opacity-0');
                    this.els.modalContent.classList.remove('opacity-100', 'translate-y-0', 'sm:scale-100');
                    this.els.modalContent.classList.add('opacity-0', 'translate-y-4', 'sm:translate-y-0', 'sm:scale-95');
                    document.body.style.overflow = '';
                    
                    this.setInert(this.els.appContainer, false);

                    setTimeout(() => { 
                        this.els.privacyModal.classList.add('hidden');
                        if (this.lastFocusedElement) this.lastFocusedElement.focus();
                    }, 300);
                }
            };

            return { init: () => UI.init() };
        })();

        document.addEventListener('DOMContentLoaded', App.init);
    </script>
</body>
</html>
